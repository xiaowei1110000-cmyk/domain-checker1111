<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šç¾¤ç½‘ç«™ç›‘æ§ç³»ç»Ÿ v9.0 - å¢å¼ºç‰ˆ</title>
    <style>
        /* ===== å…¨å±€æ ·å¼é‡ç½® ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            --warning-gradient: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            --danger-gradient: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            --info-gradient: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            --telegram-gradient: linear-gradient(135deg, #0088cc 0%, #006699 100%);
            
            --primary-color: #667eea;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            --light-color: #f8f9fa;
            --dark-color: #2c3e50;
            --border-color: #e9ecef;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.12);
            --shadow-xl: 0 20px 60px rgba(0,0,0,0.15);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            
            --transition-normal: 0.3s ease;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }
        
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: var(--primary-gradient);
        }
        
        /* ===== å¤´éƒ¨æ ·å¼ ===== */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            position: relative;
        }
        
        header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: var(--primary-gradient);
            border-radius: 2px;
        }
        
        h1 {
            color: transparent;
            margin-bottom: 10px;
            font-size: 2.2rem;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
        }
        
        .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        /* ===== å¸ƒå±€ ===== */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }
        
        /* ===== ç¾¤ç»„é…ç½® ===== */
        .group-config {
            background: white;
            border-radius: var(--radius-lg);
            padding: 25px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            height: fit-content;
            position: sticky;
            top: 30px;
        }
        
        .group-config::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--telegram-gradient);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }
        
        .group-config h3 {
            color: var(--dark-color);
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .group-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .group-item {
            background: var(--light-color);
            border-radius: var(--radius-md);
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            transition: var(--transition-normal);
            cursor: pointer;
        }
        
        .group-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
            background: #e8f4fc;
        }
        
        .group-item.active {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(41, 128, 185, 0.1) 100%);
            border-color: var(--info-color);
        }
        
        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .group-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .group-buttons {
            display: flex;
            gap: 6px;
        }
        
        .group-btn {
            padding: 4px 8px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            cursor: pointer;
            background: var(--info-color);
            color: white;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .group-btn.delete {
            background: var(--danger-color);
        }
        
        .group-btn.edit {
            background: var(--warning-color);
        }
        
        .group-details {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .group-details div {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* ===== è¡¨å•å…ƒç´  ===== */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            background: var(--light-color);
            transition: var(--transition-normal);
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            height: 150px;
            resize: vertical;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        /* ===== æŒ‰é’®æ ·å¼ ===== */
        .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-success {
            background: var(--success-gradient);
            color: white;
        }
        
        .btn-telegram {
            background: var(--telegram-gradient);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning-gradient);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger-gradient);
            color: white;
        }
        
        .btn-info {
            background: var(--info-gradient);
            color: white;
        }
        
        .btn-secondary {
            background: var(--light-color);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }
        
        /* ===== é…ç½®åŒºåŸŸ ===== */
        .config-section {
            background: linear-gradient(135deg, rgba(212, 237, 218, 0.1) 0%, rgba(195, 230, 203, 0.1) 100%);
            border: 1px solid rgba(40, 167, 69, 0.15);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }
        
        .config-section h3 {
            color: var(--success-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        
        /* ===== ç›‘æ§çŠ¶æ€ ===== */
        .monitor-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .status-card {
            background: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            text-align: center;
            box-shadow: var(--shadow-md);
            border-top: 5px solid var(--info-color);
            transition: var(--transition-normal);
        }
        
        .status-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        .status-card.warning { border-top-color: var(--warning-color); }
        .status-card.danger { border-top-color: var(--danger-color); }
        .status-card.success { border-top-color: var(--success-color); }
        .status-card.telegram { border-top-color: #0088cc; }
        
        .status-number {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-primary);
            margin: 10px 0;
        }
        
        .status-title {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        /* ===== åŸŸååˆ—è¡¨ ===== */
        .domain-list {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: var(--radius-lg);
            max-height: 300px;
            overflow-y: auto;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            display: none;
        }
        
        .domain-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .domain-item:last-child {
            border-bottom: none;
        }
        
        .domain-name {
            flex: 1;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }
        
        .domain-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            min-width: 100px;
            text-align: center;
        }
        
        .status-pending { background: #f8f9fa; color: #6c757d; }
        .status-testing { background: #e3f2fd; color: #1976d2; animation: pulse 1.5s infinite; }
        .status-success { background: #e8f5e8; color: #2e7d32; }
        .status-error { background: #ffebee; color: #c62828; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* ===== æµ‹è¯•æ§åˆ¶ ===== */
        .test-controls {
            background: linear-gradient(135deg, #f8fdff 0%, #e8f4fc 100%);
            padding: 20px;
            border-radius: var(--radius-lg);
            margin: 20px 0;
            border: 1px solid rgba(52, 152, 219, 0.2);
            box-shadow: var(--shadow-md);
            display: none;
        }
        
        .test-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: white;
            padding: 12px;
            border-radius: var(--radius-md);
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .progress-bar {
            height: 10px;
            background: var(--light-color);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--success-gradient);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        /* ===== ç›‘æ§æ—¥å¿— ===== */
        .monitor-log {
            background: var(--dark-color);
            padding: 15px;
            border-radius: var(--radius-lg);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: #e9ecef;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid #34495e;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-time {
            color: #adb5bd;
            font-size: 0.8rem;
            min-width: 60px;
        }
        
        /* ===== çŠ¶æ€æ¶ˆæ¯ ===== */
        .status-message {
            margin-top: 10px;
            padding: 10px 15px;
            border-radius: var(--radius-md);
            display: none;
            font-weight: 500;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status-success {
            background: rgba(212, 237, 218, 0.9);
            color: #155724;
            border-left: 5px solid var(--success-color);
        }
        
        .status-error {
            background: rgba(248, 215, 218, 0.9);
            color: #721c24;
            border-left: 5px solid var(--danger-color);
        }
        
        /* ===== é¡µè„š ===== */
        footer {
            margin-top: 30px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        /* ===== å“åº”å¼è®¾è®¡ ===== */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .main-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .group-config {
                position: static;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
        
        /* ===== æ»šåŠ¨æ¡ç¾åŒ– ===== */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .monitor-log::-webkit-scrollbar-track {
            background: #2c3e50;
        }
        
        .monitor-log::-webkit-scrollbar-thumb {
            background: #4a6572;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-broadcast-tower"></i> å¤šç¾¤ç½‘ç«™ç›‘æ§ç³»ç»Ÿ v9.0</h1>
            <p class="subtitle">æ”¯æŒå¤šç¾¤ç›‘æ§ | ä¸€å¯¹ä¸€ç»“æœæ¨é€ | è¿è¥å•†èŠ‚ç‚¹åˆ†æ | å³æ—¶é€šçŸ¥</p>
        </header>
        
        <div class="main-layout">
            <div class="main-content">
                <!-- è¯´æ˜åŒºåŸŸ -->
                <div class="config-section">
                    <h3><i class="fas fa-info-circle"></i> ä½¿ç”¨è¯´æ˜</h3>
                    <p>1. åœ¨å³ä¾§æ·»åŠ ç¾¤ç»„é…ç½®ï¼ˆæ¯ä¸ªç¾¤ç‹¬ç«‹çš„Botå’Œæµ‹è¯•é“¾æ¥ï¼‰</p>
                    <p>2. ç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ªé“¾æ¥æ‰“å¼€ITDOGé¡µé¢æµ‹è¯•</p>
                    <p>3. <strong>æ¯æ¬¡æµ‹è¯•å®Œç«‹å³å‘é€ç»“æœ</strong>åˆ°å¯¹åº”ç¾¤ç»„ï¼ˆä¸åªæ˜¯å¼‚å¸¸ï¼‰</p>
                    <p>4. å¼‚å¸¸æ—¶ä¼š@ç¾¤ç»„ä¸­æŒ‡å®šçš„ç”¨æˆ·ï¼ˆå¤šä¸ªç”¨æˆ·ç”¨é€—å·åˆ†éš”ï¼‰</p>
                    <p>5. æ”¯æŒè¿è¥å•†èŠ‚ç‚¹åˆ†æï¼ŒåŒºåˆ†ç§»åŠ¨/è”é€š/ç”µä¿¡å¼‚å¸¸</p>
                </div>
                
                <!-- ç›‘æ§çŠ¶æ€ -->
                <div class="monitor-status" id="monitor-status">
                    <div class="status-card">
                        <div class="status-title">æ´»è·ƒç¾¤ç»„</div>
                        <div class="status-number" id="active-groups-count">0</div>
                    </div>
                    <div class="status-card warning">
                        <div class="status-title">ä»Šæ—¥æµ‹è¯•</div>
                        <div class="status-number" id="today-tests">0</div>
                    </div>
                    <div class="status-card telegram">
                        <div class="status-title">å‘é€é€šçŸ¥</div>
                        <div class="status-number" id="sent-notifications">0</div>
                    </div>
                    <div class="status-card">
                        <div class="status-title">æ€»é“¾æ¥æ•°</div>
                        <div class="status-number" id="total-domains">0</div>
                    </div>
                </div>
                
                <!-- æ‰¹é‡æµ‹è¯• -->
                <div class="config-section">
                    <h3><i class="fas fa-globe"></i> æ‰¹é‡æµ‹è¯•æ§åˆ¶</h3>
                    
                    <div class="buttons">
                        <button class="btn btn-success" id="start-all-btn">
                            <i class="fas fa-play"></i> å¯åŠ¨æ‰€æœ‰ç¾¤ç»„
                        </button>
                        <button class="btn btn-warning" id="start-selected-btn">
                            <i class="fas fa-bolt"></i> å¯åŠ¨é€‰ä¸­ç¾¤ç»„
                        </button>
                        <button class="btn btn-danger" id="stop-all-btn">
                            <i class="fas fa-stop"></i> åœæ­¢æ‰€æœ‰æµ‹è¯•
                        </button>
                        <button class="btn btn-info" id="test-now-btn">
                            <i class="fas fa-rocket"></i> ç«‹å³æµ‹è¯•ä¸€æ¬¡
                        </button>
                    </div>
                    
                    <!-- æµ‹è¯•è¿›åº¦ -->
                    <div class="test-controls" id="test-controls">
                        <div class="test-stats">
                            <div class="stat-item">
                                <div class="stat-label">è¿›è¡Œä¸­</div>
                                <div class="stat-value" id="active-tests">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">å·²æµ‹è¯•</div>
                                <div class="stat-value" id="tested-count">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">æˆåŠŸ</div>
                                <div class="stat-value" id="success-count">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">å¼‚å¸¸</div>
                                <div class="stat-value" id="error-count">0</div>
                            </div>
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-info">
                                <span>æµ‹è¯•è¿›åº¦</span>
                                <span id="progress-text">0/0</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-bar"></div>
                            </div>
                        </div>
                        
                        <div class="buttons">
                            <button class="btn btn-warning" id="pause-btn">
                                <i class="fas fa-pause"></i> æš‚åœ
                            </button>
                            <button class="btn btn-danger" id="stop-btn">
                                <i class="fas fa-stop"></i> åœæ­¢
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ç›‘æ§æ—¥å¿— -->
                <div class="config-section">
                    <h3><i class="fas fa-clipboard-list"></i> ç›‘æ§æ—¥å¿—</h3>
                    <div class="monitor-log" id="monitor-log">
                        <div class="log-entry">
                            <span class="log-time">å°±ç»ª</span>
                            <span class="log-content">ğŸ‰ å¤šç¾¤ç›‘æ§ç³»ç»Ÿ v9.0 å·²å¯åŠ¨ - æ”¯æŒä¸€å¯¹ä¸€ç»“æœå‘é€</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç¾¤ç»„é…ç½® -->
            <div class="group-config">
                <h3><i class="fab fa-telegram"></i> ç¾¤ç»„é…ç½®ç®¡ç†</h3>
                
                <div class="form-group">
                    <label for="group-name">ç¾¤ç»„åç§°</label>
                    <input type="text" id="group-name" placeholder="ä¾‹å¦‚ï¼šä¸»ç›‘æ§ç¾¤">
                </div>
                
                <div class="form-group">
                    <label for="bot-token">Bot Token</label>
                    <input type="password" id="bot-token" placeholder="è¾“å…¥Telegram Bot Token">
                </div>
                
                <div class="form-group">
                    <label for="chat-id">Chat ID</label>
                    <input type="text" id="chat-id" placeholder="è¾“å…¥ç¾¤ç»„Chat ID">
                </div>
                
                <div class="form-group">
                    <label for="mention-users">å¼‚å¸¸æ—¶@çš„ç”¨æˆ·ID</label>
                    <input type="text" id="mention-users" placeholder="ä¾‹å¦‚ï¼š123456,789012ï¼ˆé€—å·åˆ†éš”ï¼‰">
                </div>
                
                <div class="form-group">
                    <label for="connectivity-threshold">è¿é€šç‡é˜ˆå€¼ (%)</label>
                    <input type="number" id="connectivity-threshold" min="1" max="100" value="90" placeholder="ä½äºæ­¤å€¼å‘é€å¼‚å¸¸é€šçŸ¥">
                </div>
                
                <div class="form-group">
                    <label for="group-domains">æµ‹è¯•é“¾æ¥ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
                    <textarea id="group-domains" placeholder="https://example.com&#10;http://test.com/path&#10;www.domain.com"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="test-interval">æµ‹è¯•é—´éš”ï¼ˆåˆ†é’Ÿï¼‰</label>
                    <input type="number" id="test-interval" min="1" value="60">
                </div>
                
                <div class="buttons">
                    <button class="btn btn-telegram" id="save-group-btn">
                        <i class="fas fa-save"></i> ä¿å­˜ç¾¤ç»„
                    </button>
                    <button class="btn btn-secondary" id="clear-form-btn">
                        <i class="fas fa-times"></i> æ¸…ç©º
                    </button>
                    <button class="btn btn-danger" id="delete-group-btn" style="display: none;">
                        <i class="fas fa-trash"></i> åˆ é™¤ç¾¤ç»„
                    </button>
                </div>
                
                <div id="config-status" class="status-message"></div>
                
                <!-- ç¾¤ç»„åˆ—è¡¨ -->
                <div class="group-list" id="group-list">
                    <!-- ç¾¤ç»„é¡¹ç›®ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                </div>
            </div>
        </div>
        
        <footer>
            <p>å¤šç¾¤ç½‘ç«™ç›‘æ§ç³»ç»Ÿ v9.0 | ä¸Tampermonkeyè„šæœ¬é…åˆä½¿ç”¨ | è¿è¥å•†èŠ‚ç‚¹åˆ†æç‰ˆ</p>
            <p>è¯·ç¡®ä¿å·²å®‰è£… Tampermonkey æ‰©å±•å¹¶åŠ è½½ç›‘æ§è„šæœ¬</p>
        </footer>
    </div>

<script>
// ============================================
// å¤šç¾¤ç½‘ç«™ç›‘æ§ç³»ç»Ÿ v9.0
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    // å…ƒç´ å¼•ç”¨
    const elements = {
        // ç¾¤ç»„é…ç½®å…ƒç´ 
        groupName: document.getElementById('group-name'),
        botToken: document.getElementById('bot-token'),
        chatId: document.getElementById('chat-id'),
        mentionUsers: document.getElementById('mention-users'),
        connectivityThreshold: document.getElementById('connectivity-threshold'),
        groupDomains: document.getElementById('group-domains'),
        testInterval: document.getElementById('test-interval'),
        saveGroupBtn: document.getElementById('save-group-btn'),
        clearFormBtn: document.getElementById('clear-form-btn'),
        deleteGroupBtn: document.getElementById('delete-group-btn'),
        groupList: document.getElementById('group-list'),
        configStatus: document.getElementById('config-status'),
        
        // æµ‹è¯•æ§åˆ¶å…ƒç´ 
        startAllBtn: document.getElementById('start-all-btn'),
        startSelectedBtn: document.getElementById('start-selected-btn'),
        stopAllBtn: document.getElementById('stop-all-btn'),
        testNowBtn: document.getElementById('test-now-btn'),
        testControls: document.getElementById('test-controls'),
        pauseBtn: document.getElementById('pause-btn'),
        stopBtn: document.getElementById('stop-btn'),
        activeTests: document.getElementById('active-tests'),
        testedCount: document.getElementById('tested-count'),
        successCount: document.getElementById('success-count'),
        errorCount: document.getElementById('error-count'),
        progressText: document.getElementById('progress-text'),
        progressBar: document.getElementById('progress-bar'),
        
        // çŠ¶æ€æ˜¾ç¤ºå…ƒç´ 
        activeGroupsCount: document.getElementById('active-groups-count'),
        todayTests: document.getElementById('today-tests'),
        sentNotifications: document.getElementById('sent-notifications'),
        totalDomains: document.getElementById('total-domains'),
        
        // ç›‘æ§æ—¥å¿—å…ƒç´ 
        monitorLog: document.getElementById('monitor-log')
    };

    // çŠ¶æ€å˜é‡
    let groups = {};
    let activeTestGroups = new Map(); // groupId -> test state
    let selectedGroupId = null;
    let isTesting = false;
    let isPaused = false;
    let stats = {
        todayTests: 0,
        sentNotifications: 0,
        totalDomains: 0,
        lastReset: new Date().toDateString()
    };

    // æ¶ˆæ¯å¤„ç†å™¨
    window.messageHandlers = new Map();

    // åˆå§‹åŒ–
    function init() {
        loadGroups();
        loadStats();
        setupEventListeners();
        updateGroupList();
        updateStatsDisplay();
        
        // ç›‘å¬æ¥è‡ªITDOGé¡µé¢çš„æ¶ˆæ¯
        window.addEventListener('message', handleITDOGMessage);
        
        addLog('ğŸ‰ å¤šç¾¤ç›‘æ§ç³»ç»Ÿ v9.0 å·²å¯åŠ¨', 'success');
        addLog('ğŸ“¤ æ¯æ¬¡æµ‹è¯•å®Œç«‹å³å‘é€ç»“æœåˆ°å¯¹åº”ç¾¤ç»„', 'info');
        addLog('ğŸ‘¥ æ”¯æŒå¤šç¾¤ç‹¬ç«‹é…ç½®å’Œç›‘æ§', 'info');
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®æ¯æ—¥ç»Ÿè®¡
        checkDailyReset();
    }

    // åŠ è½½ç¾¤ç»„é…ç½®
    function loadGroups() {
        try {
            const savedGroups = localStorage.getItem('monitor_groups_v9');
            if (savedGroups) {
                groups = JSON.parse(savedGroups);
                updateTotalDomains();
            }
        } catch (error) {
            console.error('åŠ è½½ç¾¤ç»„é…ç½®å¤±è´¥:', error);
            addLog('âŒ åŠ è½½ç¾¤ç»„é…ç½®å¤±è´¥', 'error');
        }
    }

    // ä¿å­˜ç¾¤ç»„é…ç½®
    function saveGroups() {
        try {
            localStorage.setItem('monitor_groups_v9', JSON.stringify(groups));
            updateTotalDomains();
            return true;
        } catch (error) {
            console.error('ä¿å­˜ç¾¤ç»„é…ç½®å¤±è´¥:', error);
            addLog('âŒ ä¿å­˜ç¾¤ç»„é…ç½®å¤±è´¥', 'error');
            return false;
        }
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    function loadStats() {
        try {
            const savedStats = localStorage.getItem('monitor_stats_v9');
            if (savedStats) {
                const loadedStats = JSON.parse(savedStats);
                if (loadedStats.lastReset === new Date().toDateString()) {
                    stats = loadedStats;
                } else {
                    resetDailyStats();
                }
            }
        } catch (error) {
            console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        }
    }

    // ä¿å­˜ç»Ÿè®¡æ•°æ®
    function saveStats() {
        try {
            localStorage.setItem('monitor_stats_v9', JSON.stringify(stats));
        } catch (error) {
            console.error('ä¿å­˜ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        }
    }

    // æ›´æ–°æ€»åŸŸåæ•°
    function updateTotalDomains() {
        stats.totalDomains = 0;
        Object.values(groups).forEach(group => {
            stats.totalDomains += group.domains.length;
        });
        updateStatsDisplay();
    }

    // æ£€æŸ¥æ¯æ—¥é‡ç½®
    function checkDailyReset() {
        if (stats.lastReset !== new Date().toDateString()) {
            resetDailyStats();
            addLog('ğŸ“… æ–°çš„ä¸€å¤©ï¼Œç»Ÿè®¡å·²é‡ç½®', 'info');
        }
    }

    // é‡ç½®æ¯æ—¥ç»Ÿè®¡
    function resetDailyStats() {
        stats.todayTests = 0;
        stats.sentNotifications = 0;
        stats.lastReset = new Date().toDateString();
        saveStats();
        updateStatsDisplay();
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
        // ä¿å­˜ç¾¤ç»„
        elements.saveGroupBtn.addEventListener('click', saveGroup);
        elements.clearFormBtn.addEventListener('click', clearForm);
        elements.deleteGroupBtn.addEventListener('click', deleteGroup);
        
        // æµ‹è¯•æ§åˆ¶
        elements.startAllBtn.addEventListener('click', startAllGroups);
        elements.startSelectedBtn.addEventListener('click', startSelectedGroup);
        elements.stopAllBtn.addEventListener('click', stopAllGroups);
        elements.testNowBtn.addEventListener('click', testSelectedGroupOnce);
        elements.pauseBtn.addEventListener('click', togglePause);
        elements.stopBtn.addEventListener('click', stopAllTests);
    }

    // ä¿å­˜ç¾¤ç»„
    function saveGroup() {
        const groupName = elements.groupName.value.trim();
        const botToken = elements.botToken.value.trim();
        const chatId = elements.chatId.value.trim();
        const mentionUsers = elements.mentionUsers.value.trim();
        const threshold = parseInt(elements.connectivityThreshold.value) || 90;
        const domains = elements.groupDomains.value.trim();
        const interval = parseInt(elements.testInterval.value) || 60;
        
        // éªŒè¯
        if (!groupName || !botToken || !chatId || !domains) {
            showStatus('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
            return;
        }
        
        if (!botToken.match(/^\d+:[A-Za-z0-9_-]+$/)) {
            showStatus('Bot Tokenæ ¼å¼ä¸æ­£ç¡®', 'error');
            return;
        }
        
        const domainList = domains.split('\n')
            .map(d => d.trim())
            .filter(d => d.length > 0);
        
        if (domainList.length === 0) {
            showStatus('è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªæµ‹è¯•é“¾æ¥', 'error');
            return;
        }
        
        // å¤„ç†ç”¨æˆ·IDï¼ˆè½¬æ¢ä¸ºæ•°å­—æ•°ç»„ï¼‰
        const mentionUserIds = mentionUsers.split(',')
            .map(u => u.trim())
            .filter(u => u.match(/^\d+$/))
            .map(u => parseInt(u));
        
        const groupId = selectedGroupId || Date.now().toString();
        
        // ä¿å­˜ç¾¤ç»„
        groups[groupId] = {
            id: groupId,
            name: groupName,
            botToken: botToken,
            chatId: chatId,
            mentionUsers: mentionUserIds,
            threshold: threshold,
            domains: domainList,
            interval: interval,
            enabled: true,
            lastTested: null,
            lastResult: null,
            createdAt: new Date().toISOString()
        };
        
        if (saveGroups()) {
            showStatus(`ç¾¤ç»„ "${groupName}" å·²ä¿å­˜`, 'success');
            addLog(`âœ… ç¾¤ç»„å·²ä¿å­˜: ${groupName} (${domainList.length}ä¸ªé“¾æ¥)`, 'success');
            
            // æ›´æ–°æ˜¾ç¤º
            updateGroupList();
            clearForm();
            
            // å¦‚æœæ­£åœ¨ç¼–è¾‘ï¼Œå¯èƒ½éœ€è¦æ›´æ–°æµ‹è¯•çŠ¶æ€
            if (selectedGroupId && activeTestGroups.has(selectedGroupId)) {
                const testState = activeTestGroups.get(selectedGroupId);
                testState.group = groups[groupId]; // æ›´æ–°ç¾¤ç»„é…ç½®
            }
        }
    }

    // æ¸…é™¤è¡¨å•
    function clearForm() {
        elements.groupName.value = '';
        elements.botToken.value = '';
        elements.chatId.value = '';
        elements.mentionUsers.value = '';
        elements.connectivityThreshold.value = '90';
        elements.groupDomains.value = '';
        elements.testInterval.value = '60';
        selectedGroupId = null;
        elements.deleteGroupBtn.style.display = 'none';
        elements.saveGroupBtn.innerHTML = '<i class="fas fa-save"></i> ä¿å­˜ç¾¤ç»„';
        
        // æ¸…é™¤é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.group-item.active').forEach(item => {
            item.classList.remove('active');
        });
    }

    // åˆ é™¤ç¾¤ç»„
    function deleteGroup() {
        if (!selectedGroupId) return;
        
        const group = groups[selectedGroupId];
        if (!group) return;
        
        if (confirm(`ç¡®å®šè¦åˆ é™¤ç¾¤ç»„ "${group.name}" å—ï¼Ÿ`)) {
            // å¦‚æœæ­£åœ¨æµ‹è¯•ï¼Œå…ˆåœæ­¢
            if (activeTestGroups.has(selectedGroupId)) {
                stopGroupTest(selectedGroupId);
            }
            
            // åˆ é™¤ç¾¤ç»„
            delete groups[selectedGroupId];
            saveGroups();
            
            showStatus(`ç¾¤ç»„ "${group.name}" å·²åˆ é™¤`, 'success');
            addLog(`ğŸ—‘ï¸ å·²åˆ é™¤ç¾¤ç»„: ${group.name}`, 'warning');
            
            // æ›´æ–°æ˜¾ç¤º
            updateGroupList();
            clearForm();
        }
    }

    // æ›´æ–°ç¾¤ç»„åˆ—è¡¨æ˜¾ç¤º
    function updateGroupList() {
        elements.groupList.innerHTML = '';
        
        Object.values(groups).forEach(group => {
            const item = document.createElement('div');
            item.className = 'group-item';
            if (selectedGroupId === group.id) {
                item.classList.add('active');
            }
            item.dataset.groupId = group.id;
            
            const isActive = activeTestGroups.has(group.id);
            const activeStatus = isActive ? 'ğŸŸ¢ è¿è¡Œä¸­' : 'âšª æœªè¿è¡Œ';
            
            item.innerHTML = `
                <div class="group-header">
                    <span class="group-name">${group.name}</span>
                    <div class="group-buttons">
                        <button class="group-btn edit" title="ç¼–è¾‘">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="group-btn delete" title="åˆ é™¤">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="group-btn ${group.enabled ? 'disable' : 'enable'}" title="${group.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}">
                            <i class="fas fa-${group.enabled ? 'pause' : 'play'}"></i>
                        </button>
                    </div>
                </div>
                <div class="group-details">
                    <div><i class="fas fa-hashtag"></i> é“¾æ¥: ${group.domains.length}ä¸ª</div>
                    <div><i class="fas fa-clock"></i> é—´éš”: ${group.interval}åˆ†é’Ÿ</div>
                    <div><i class="fas fa-bell"></i> é˜ˆå€¼: ${group.threshold}%</div>
                    <div><i class="fas fa-users"></i> é€šçŸ¥: ${group.mentionUsers.length}äºº</div>
                    <div><i class="fas fa-power-off"></i> çŠ¶æ€: ${activeStatus}</div>
                    ${group.lastTested ? `<div><i class="fas fa-history"></i> æœ€å: ${new Date(group.lastTested).toLocaleTimeString()}</div>` : ''}
                </div>
            `;
            
            elements.groupList.appendChild(item);
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆé€‰ä¸­ç¾¤ç»„ï¼‰
            item.addEventListener('click', (e) => {
                if (!e.target.classList.contains('group-btn')) {
                    selectGroup(group.id);
                }
            });
            
            // æ·»åŠ æŒ‰é’®äº‹ä»¶
            item.querySelector('.edit').addEventListener('click', (e) => {
                e.stopPropagation();
                editGroup(group.id);
            });
            item.querySelector('.delete').addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm(`åˆ é™¤ç¾¤ç»„ "${group.name}"ï¼Ÿ`)) {
                    deleteGroupById(group.id);
                }
            });
            item.querySelector('.group-btn:not(.edit):not(.delete)').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleGroupEnabled(group.id);
            });
        });
    }

    // é€‰ä¸­ç¾¤ç»„
    function selectGroup(groupId) {
        selectedGroupId = groupId;
        
        // æ›´æ–°UI
        document.querySelectorAll('.group-item').forEach(item => {
            item.classList.remove('active');
        });
        const selectedItem = document.querySelector(`.group-item[data-group-id="${groupId}"]`);
        if (selectedItem) {
            selectedItem.classList.add('active');
        }
        
        // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
        elements.deleteGroupBtn.style.display = 'block';
        
        addLog(`ğŸ“Œ é€‰ä¸­ç¾¤ç»„: ${groups[groupId]?.name || 'æœªçŸ¥'}`, 'info');
    }

    // ç¼–è¾‘ç¾¤ç»„
    function editGroup(groupId) {
        const group = groups[groupId];
        if (!group) return;
        
        selectedGroupId = groupId;
        
        // å¡«å……è¡¨å•
        elements.groupName.value = group.name;
        elements.botToken.value = group.botToken;
        elements.chatId.value = group.chatId;
        elements.mentionUsers.value = group.mentionUsers.join(', ');
        elements.connectivityThreshold.value = group.threshold;
        elements.groupDomains.value = group.domains.join('\n');
        elements.testInterval.value = group.interval;
        
        // æ›´æ–°æŒ‰é’®
        elements.deleteGroupBtn.style.display = 'block';
        elements.saveGroupBtn.innerHTML = '<i class="fas fa-sync-alt"></i> æ›´æ–°ç¾¤ç»„';
        
        addLog(`âœï¸ æ­£åœ¨ç¼–è¾‘ç¾¤ç»„: ${group.name}`, 'info');
    }

    // åˆ é™¤ç¾¤ç»„ï¼ˆé€šè¿‡IDï¼‰
    function deleteGroupById(groupId) {
        const group = groups[groupId];
        if (!group) return;
        
        // å¦‚æœæ­£åœ¨æµ‹è¯•ï¼Œå…ˆåœæ­¢
        if (activeTestGroups.has(groupId)) {
            stopGroupTest(groupId);
        }
        
        // åˆ é™¤ç¾¤ç»„
        delete groups[groupId];
        saveGroups();
        
        showStatus(`ç¾¤ç»„ "${group.name}" å·²åˆ é™¤`, 'success');
        addLog(`ğŸ—‘ï¸ å·²åˆ é™¤ç¾¤ç»„: ${group.name}`, 'warning');
        
        // å¦‚æœåˆ é™¤çš„æ˜¯é€‰ä¸­çš„ç¾¤ç»„ï¼Œæ¸…ç©ºè¡¨å•
        if (selectedGroupId === groupId) {
            clearForm();
        }
        
        // æ›´æ–°æ˜¾ç¤º
        updateGroupList();
    }

    // å¯ç”¨/ç¦ç”¨ç¾¤ç»„
    function toggleGroupEnabled(groupId) {
        const group = groups[groupId];
        if (!group) return;
        
        group.enabled = !group.enabled;
        saveGroups();
        updateGroupList();
        
        const action = group.enabled ? 'å¯ç”¨' : 'ç¦ç”¨';
        addLog(`âš™ï¸ å·²${action}ç¾¤ç»„: ${group.name}`, 'info');
        
        // å¦‚æœç¦ç”¨æ—¶æ­£åœ¨æµ‹è¯•ï¼Œåœæ­¢æµ‹è¯•
        if (!group.enabled && activeTestGroups.has(groupId)) {
            stopGroupTest(groupId);
        }
    }

    // å¯åŠ¨æ‰€æœ‰ç¾¤ç»„
    function startAllGroups() {
        const enabledGroups = Object.values(groups).filter(g => g.enabled);
        
        if (enabledGroups.length === 0) {
            showStatus('æ²¡æœ‰å¯ç”¨çš„ç¾¤ç»„', 'error');
            return;
        }
        
        let startedCount = 0;
        enabledGroups.forEach(group => {
            if (!activeTestGroups.has(group.id)) {
                if (startGroupTest(group.id)) {
                    startedCount++;
                }
            }
        });
        
        showStatus(`å·²å¯åŠ¨ ${startedCount} ä¸ªç¾¤ç»„çš„ç›‘æ§`, 'success');
        updateActiveGroupsCount();
    }

    // å¯åŠ¨é€‰ä¸­ç¾¤ç»„
    function startSelectedGroup() {
        if (!selectedGroupId) {
            showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¾¤ç»„', 'error');
            return;
        }
        
        if (!groups[selectedGroupId].enabled) {
            showStatus('è¯¥ç¾¤ç»„å·²è¢«ç¦ç”¨', 'error');
            return;
        }
        
        if (activeTestGroups.has(selectedGroupId)) {
            showStatus('è¯¥ç¾¤ç»„å·²åœ¨è¿è¡Œä¸­', 'info');
            return;
        }
        
        if (startGroupTest(selectedGroupId)) {
            showStatus('ç¾¤ç»„ç›‘æ§å·²å¯åŠ¨', 'success');
            updateActiveGroupsCount();
        }
    }

    // æµ‹è¯•é€‰ä¸­ç¾¤ç»„ä¸€æ¬¡ï¼ˆä¸å¯åŠ¨å®šæ—¶ï¼‰
    function testSelectedGroupOnce() {
        if (!selectedGroupId) {
            showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¾¤ç»„', 'error');
            return;
        }
        
        const group = groups[selectedGroupId];
        if (!group || !group.enabled) {
            showStatus('ç¾¤ç»„ä¸å¯ç”¨æˆ–å·²è¢«ç¦ç”¨', 'error');
            return;
        }
        
        addLog(`ğŸš€ ç«‹å³æµ‹è¯•ç¾¤ç»„: ${group.name}`, 'info');
        
        // åˆ›å»ºä¸€æ¬¡æ€§æµ‹è¯•çŠ¶æ€
        const testState = {
            groupId: selectedGroupId,
            group: group,
            domains: [...group.domains],
            currentIndex: 0,
            isTesting: true,
            isOneTime: true, // æ ‡è®°ä¸ºä¸€æ¬¡æ€§æµ‹è¯•
            results: {},
            activeTabs: new Map()
        };
        
        activeTestGroups.set(selectedGroupId, testState);
        updateActiveGroupsCount();
        showTestControls();
        
        // å¼€å§‹æµ‹è¯•
        testNextDomain(selectedGroupId);
    }

    // å¯åŠ¨å•ä¸ªç¾¤ç»„æµ‹è¯•
    function startGroupTest(groupId) {
        const group = groups[groupId];
        if (!group || !group.enabled) return false;
        
        addLog(`ğŸš€ å¯åŠ¨ç¾¤ç»„æµ‹è¯•: ${group.name}`, 'info');
        
        // å¦‚æœå·²ç»åœ¨æµ‹è¯•ä¸­ï¼Œå…ˆåœæ­¢
        if (activeTestGroups.has(groupId)) {
            stopGroupTest(groupId);
        }
        
        // åˆ›å»ºæµ‹è¯•çŠ¶æ€
        const testState = {
            groupId: groupId,
            group: group,
            domains: [...group.domains],
            currentIndex: 0,
            isTesting: true,
            isOneTime: false, // å®šæ—¶æµ‹è¯•
            results: {},
            activeTabs: new Map(),
            timer: null,
            interval: group.interval * 60 * 1000 // è½¬æ¢ä¸ºæ¯«ç§’
        };
        
        activeTestGroups.set(groupId, testState);
        updateActiveGroupsCount();
        showTestControls();
        
        // å¼€å§‹ç¬¬ä¸€æ¬¡æµ‹è¯•
        testNextDomain(groupId);
        
        // è®¾ç½®å®šæ—¶å™¨ï¼ˆå¦‚æœä¸æ˜¯ä¸€æ¬¡æ€§æµ‹è¯•ï¼‰
        if (!testState.isOneTime && group.interval > 0) {
            testState.timer = setInterval(() => {
                if (testState.isTesting && !isPaused) {
                    addLog(`ğŸ”„ å®šæ—¶æµ‹è¯•: ${group.name}`, 'info');
                    testState.currentIndex = 0;
                    testState.results = {};
                    testNextDomain(groupId);
                }
            }, testState.interval);
        }
        
        return true;
    }

    // åœæ­¢å•ä¸ªç¾¤ç»„æµ‹è¯•
    function stopGroupTest(groupId) {
        const testState = activeTestGroups.get(groupId);
        if (!testState) return;
        
        testState.isTesting = false;
        
        // æ¸…é™¤å®šæ—¶å™¨
        if (testState.timer) {
            clearInterval(testState.timer);
            testState.timer = null;
        }
        
        // å…³é—­æ‰€æœ‰æ‰“å¼€çš„æ ‡ç­¾é¡µ
        testState.activeTabs.forEach(tab => {
            try {
                if (tab && !tab.closed) {
                    tab.close();
                }
            } catch (e) {
                console.error('å…³é—­æ ‡ç­¾é¡µå¤±è´¥:', e);
            }
        });
        testState.activeTabs.clear();
        
        // ä»æ´»åŠ¨åˆ—è¡¨ç§»é™¤
        activeTestGroups.delete(groupId);
        updateActiveGroupsCount();
        
        const group = groups[groupId];
        if (group) {
            addLog(`â¹ï¸ åœæ­¢ç¾¤ç»„æµ‹è¯•: ${group.name}`, 'warning');
        }
        
        // å¦‚æœæ²¡æœ‰æ´»åŠ¨çš„æµ‹è¯•ï¼Œéšè—æ§åˆ¶é¢æ¿
        if (activeTestGroups.size === 0) {
            hideTestControls();
        }
    }

    // åœæ­¢æ‰€æœ‰ç¾¤ç»„
    function stopAllGroups() {
        activeTestGroups.forEach((testState, groupId) => {
            stopGroupTest(groupId);
        });
        
        showStatus('å·²åœæ­¢æ‰€æœ‰ç¾¤ç»„çš„ç›‘æ§', 'info');
        hideTestControls();
    }

    // æµ‹è¯•ä¸‹ä¸€ä¸ªåŸŸå
    function testNextDomain(groupId) {
        const testState = activeTestGroups.get(groupId);
        if (!testState || !testState.isTesting || testState.currentIndex >= testState.domains.length) {
            // æµ‹è¯•å®Œæˆ
            if (testState) {
                testState.isTesting = false;
                testState.currentIndex = 0; // é‡ç½®ç´¢å¼•
                
                // æ›´æ–°ç¾¤ç»„æœ€åæµ‹è¯•æ—¶é—´
                const group = groups[groupId];
                if (group) {
                    group.lastTested = new Date().toISOString();
                    saveGroups();
                    updateGroupList();
                    
                    // å¦‚æœä¸æ˜¯ä¸€æ¬¡æ€§æµ‹è¯•ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡å®šæ—¶æ‰§è¡Œ
                    if (!testState.isOneTime) {
                        addLog(`âœ… ç¾¤ç»„æµ‹è¯•å®Œæˆ: ${group.name}ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡å®šæ—¶`, 'success');
                    } else {
                        addLog(`âœ… ä¸€æ¬¡æ€§æµ‹è¯•å®Œæˆ: ${group.name}`, 'success');
                        // ä¸€æ¬¡æ€§æµ‹è¯•å®Œæˆï¼Œç§»é™¤
                        setTimeout(() => {
                            activeTestGroups.delete(groupId);
                            updateActiveGroupsCount();
                        }, 1000);
                    }
                }
            }
            return;
        }
        
        const domain = testState.domains[testState.currentIndex];
        const domainIndex = testState.currentIndex;
        
        testState.currentIndex++;
        updateTestProgress();
        
        // æ‰“å¼€ITDOGé¡µé¢è¿›è¡Œæµ‹è¯•
        openITDOGTest(groupId, domain, domainIndex);
        
        // å¦‚æœæ²¡æœ‰æš‚åœï¼Œç»§ç»­æµ‹è¯•ä¸‹ä¸€ä¸ªï¼ˆå»¶è¿Ÿæ‰“å¼€ï¼Œé¿å…åŒæ—¶æ‰“å¼€å¤ªå¤šé¡µé¢ï¼‰
        if (!isPaused) {
            setTimeout(() => {
                if (testState && testState.isTesting) {
                    testNextDomain(groupId);
                }
            }, 5000); // 5ç§’é—´éš”
        }
    }

    // æ‰“å¼€ITDOGæµ‹è¯•é¡µé¢
    function openITDOGTest(groupId, domain, index) {
        try {
            // æ¸…ç†åŸŸåæ ¼å¼
            let cleanDomain = domain.trim();
            if (!cleanDomain.startsWith('http://') && !cleanDomain.startsWith('https://')) {
                cleanDomain = 'http://' + cleanDomain;
            }
            
            const encodedDomain = encodeURIComponent(cleanDomain);
            const url = `https://www.itdog.cn/http/?domain=${encodedDomain}`;
            
            // ç”Ÿæˆå”¯ä¸€çª—å£å
            const windowName = `itdog_${groupId}_${index}_${Date.now()}`;
            
            // æ‰“å¼€æ–°çª—å£
            const win = window.open(url, windowName, 'width=1200,height=800,menubar=no,toolbar=no,location=yes');
            
            if (!win) {
                addLog(`âŒ æ— æ³•æ‰“å¼€æ ‡ç­¾é¡µ: ${cleanDomain} (å¯èƒ½è¢«æµè§ˆå™¨é˜»æ­¢)`, 'error');
                
                // æ ‡è®°æµ‹è¯•å¤±è´¥
                const testState = activeTestGroups.get(groupId);
                if (testState) {
                    testState.results[index] = {
                        status: 'error',
                        domain: cleanDomain,
                        rate: 0
                    };
                    updateTestStats(false);
                }
                return;
            }
            
            // ä¿å­˜çª—å£å¼•ç”¨
            const testState = activeTestGroups.get(groupId);
            if (testState) {
                testState.activeTabs.set(index, win);
                
                // è®¾ç½®æ¶ˆæ¯å¤„ç†å™¨
                const messageHandler = (event) => {
                    if (event.data && event.data.type === 'ITDOG_TEST_RESULT') {
                        handleTestResult(event.data, groupId, cleanDomain, index);
                        // ç§»é™¤ç›‘å¬å™¨
                        win.removeEventListener('message', messageHandler);
                    }
                };
                
                // æ·»åŠ æ¶ˆæ¯ç›‘å¬
                win.addEventListener('message', messageHandler);
                
                // è®¾ç½®è¶…æ—¶æ£€æŸ¥
                setTimeout(() => {
                    try {
                        if (win.closed) {
                            addLog(`â° æ ‡ç­¾é¡µå·²å…³é—­: ${cleanDomain}`, 'info');
                        } else {
                            // å‘é€Pingæ¶ˆæ¯æ£€æŸ¥è„šæœ¬çŠ¶æ€
                            win.postMessage({ type: 'PING_ITDOG' }, '*');
                        }
                    } catch (e) {
                        // è·¨åŸŸé”™è¯¯ï¼Œå¿½ç•¥
                    }
                    
                    // æ¸…ç†å¼•ç”¨
                    if (testState.activeTabs) {
                        testState.activeTabs.delete(index);
                    }
                }, 180000); // 3åˆ†é’Ÿè¶…æ—¶
            }
            
            stats.todayTests++;
            updateStatsDisplay();
            saveStats();
            
            addLog(`ğŸŒ æ‰“å¼€æµ‹è¯•: ${cleanDomain}`, 'info');
            
        } catch (error) {
            addLog(`âŒ æ‰“å¼€æµ‹è¯•é¡µé¢å‡ºé”™: ${error.message}`, 'error');
        }
    }

    // å¤„ç†æµ‹è¯•ç»“æœ
    function handleTestResult(resultData, groupId, domain, index) {
        const testState = activeTestGroups.get(groupId);
        const group = groups[groupId];
        
        if (!testState || !group) return;
        
        // ä¿å­˜ç»“æœ
        testState.results[index] = {
            status: resultData.isLowRate ? 'lowrate' : 'success',
            domain: domain,
            rate: resultData.connectivityRate || 0,
            data: resultData
        };
        
        // æ›´æ–°ç»Ÿè®¡
        updateTestStats(!resultData.isLowRate);
        
        // è®°å½•åˆ°ç¾¤ç»„
        group.lastResult = {
            domain: domain,
            rate: resultData.connectivityRate || 0,
            time: new Date().toISOString(),
            isLowRate: resultData.isLowRate || false
        };
        saveGroups();
        updateGroupList();
        
        // å‘é€ç»“æœåˆ°Telegram
        sendResultToTelegram(group, domain, resultData);
        
        // å…³é—­æ ‡ç­¾é¡µ
        const tab = testState.activeTabs.get(index);
        if (tab && !tab.closed) {
            try {
                tab.close();
            } catch (e) {
                // å¿½ç•¥é”™è¯¯
            }
        }
        testState.activeTabs.delete(index);
        
        // æ›´æ–°è¿›åº¦
        updateTestProgress();
    }

    // å‘é€ç»“æœåˆ°Telegram
    async function sendResultToTelegram(group, domain, resultData) {
        const now = new Date();
        const currentTime = now.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        }).replace(/\//g, '-');
        
        const isLowRate = resultData.isLowRate || false;
        const rate = resultData.connectivityRate || 0;
        const statusEmoji = isLowRate ? 'âš ï¸' : 'âœ…';
        
        // æ„å»ºæ¶ˆæ¯
        let message = `${statusEmoji} *ç½‘ç«™ç›‘æ§ç»“æœ - ${group.name}*\n\n`;
        message += `ğŸŒ *æ£€æµ‹åŸŸå:* \`${domain}\`\n`;
        message += `ğŸ• *æ£€æµ‹æ—¶é—´:* ${currentTime}\n`;
        message += `ğŸ“Š *è¿é€šç‡:* ${rate}%\n`;
        message += `âœ… *æˆåŠŸèŠ‚ç‚¹:* ${resultData.success200Tests || 0}/${resultData.totalTests || 0}\n\n`;
        
        // è¿è¥å•†åˆ†æ
        if (resultData.operatorSummary) {
            const summary = resultData.operatorSummary;
            message += `ğŸ“¡ *è¿è¥å•†åˆ†æ*\n`;
            
            if (summary.mobileTotal > 0) {
                message += `â”œ ä¸­å›½ç§»åŠ¨: ${summary.mobileSuccess || 0}/${summary.mobileTotal} (${summary.mobileRate || 0}%)\n`;
            }
            if (summary.unicomTotal > 0) {
                message += `â”œ ä¸­å›½è”é€š: ${summary.unicomSuccess || 0}/${summary.unicomTotal} (${summary.unicomRate || 0}%)\n`;
            }
            if (summary.telecomTotal > 0) {
                message += `â”œ ä¸­å›½ç”µä¿¡: ${summary.telecomSuccess || 0}/${summary.telecomTotal} (${summary.telecomRate || 0}%)\n`;
            }
            
            const totalErrors = (summary.mobileErrors || 0) + (summary.unicomErrors || 0) + (summary.telecomErrors || 0) + (summary.otherErrors || 0);
            if (totalErrors > 0) {
                message += `â”œ å¼‚å¸¸æ€»æ•°: ${totalErrors}ä¸ª\n`;
                if (summary.mobileErrors > 0) message += `â”‚  â”œ ç§»åŠ¨å¼‚å¸¸: ${summary.mobileErrors}ä¸ª\n`;
                if (summary.unicomErrors > 0) message += `â”‚  â”œ è”é€šå¼‚å¸¸: ${summary.unicomErrors}ä¸ª\n`;
                if (summary.telecomErrors > 0) message += `â”‚  â”œ ç”µä¿¡å¼‚å¸¸: ${summary.telecomErrors}ä¸ª\n`;
                if (summary.otherErrors > 0) message += `â”‚  â”” å…¶ä»–å¼‚å¸¸: ${summary.otherErrors}ä¸ª\n`;
            }
            message += '\n';
        }
        
        // å¼‚å¸¸æ—¶@ç›¸å…³äººå‘˜
        if (isLowRate && group.mentionUsers.length > 0) {
            const mentions = group.mentionUsers.map(userId => `[${userId}](tg://user?id=${userId})`).join(' ');
            message += `ğŸ“¢ *å¼‚å¸¸é€šçŸ¥:* ${mentions}\n`;
            message += `âš ï¸ *å‘Šè­¦:* è¿é€šç‡ä½äº${group.threshold}%ï¼\n\n`;
        }
        
        message += `ğŸ”— *æµ‹è¯•é“¾æ¥:* https://www.itdog.cn/http/?domain=${encodeURIComponent(domain)}\n`;
        
        try {
            // å‘é€æ¶ˆæ¯
            const response = await sendTelegramMessage(group.botToken, group.chatId, message);
            
            if (response.ok) {
                stats.sentNotifications++;
                updateStatsDisplay();
                saveStats();
                
                const logMsg = isLowRate ? `âš ï¸ å¼‚å¸¸ç»“æœå·²å‘é€åˆ°ç¾¤ç»„: ${group.name}` : `âœ… ç»“æœå·²å‘é€åˆ°ç¾¤ç»„: ${group.name}`;
                addLog(logMsg, isLowRate ? 'warning' : 'success');
                
                return true;
            } else {
                throw new Error(response.description || 'å‘é€å¤±è´¥');
            }
        } catch (error) {
            addLog(`âŒ å‘é€ç»“æœå¤±è´¥: ${error.message}`, 'error');
            return false;
        }
    }

    // å‘é€Telegramæ¶ˆæ¯
    async function sendTelegramMessage(botToken, chatId, text) {
        const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                chat_id: chatId,
                text: text,
                parse_mode: 'Markdown',
                disable_web_page_preview: true
            })
        });
        
        return await response.json();
    }

    // å¤„ç†ITDOGé¡µé¢æ¶ˆæ¯
    function handleITDOGMessage(event) {
        // åªå¤„ç†æ¥è‡ªITDOGåŸŸåçš„æ¶ˆæ¯
        if (event.origin !== 'https://www.itdog.cn' && event.origin !== 'http://www.itdog.cn') {
            return;
        }
        
        if (event.data && event.data.type === 'ITDOG_TEST_RESULT') {
            console.log('ğŸ“© æ”¶åˆ°ITDOGæµ‹è¯•ç»“æœ:', event.data);
            
            // è¿™é‡Œå¯ä»¥é€šè¿‡æ¶ˆæ¯å¤„ç†å™¨è·¯ç”±åˆ°å¯¹åº”çš„ç¾¤ç»„å¤„ç†
            // ä½†ç”±äºè·¨åŸŸé™åˆ¶ï¼Œé€šå¸¸ç”±æµ‹è¯•é¡µé¢ç›´æ¥å‘é€ç»“æœ
        }
    }

    // æ˜¾ç¤ºæµ‹è¯•æ§åˆ¶é¢æ¿
    function showTestControls() {
        if (!isTesting) {
            isTesting = true;
            elements.testControls.style.display = 'block';
        }
    }

    // éšè—æµ‹è¯•æ§åˆ¶é¢æ¿
    function hideTestControls() {
        if (isTesting && activeTestGroups.size === 0) {
            isTesting = false;
            elements.testControls.style.display = 'none';
        }
    }

    // æ›´æ–°æ´»è·ƒç¾¤ç»„æ•°
    function updateActiveGroupsCount() {
        const activeCount = Array.from(activeTestGroups.values()).filter(t => t.isTesting).length;
        elements.activeGroupsCount.textContent = activeCount;
    }

    // æ›´æ–°æµ‹è¯•è¿›åº¦
    function updateTestProgress() {
        let totalDomains = 0;
        let testedDomains = 0;
        let successDomains = 0;
        let errorDomains = 0;
        
        activeTestGroups.forEach(testState => {
            if (testState.isTesting) {
                totalDomains += testState.domains.length;
                testedDomains += testState.currentIndex;
                
                // ç»Ÿè®¡æˆåŠŸå’Œå¤±è´¥
                Object.values(testState.results).forEach(result => {
                    if (result.status === 'success') {
                        successDomains++;
                    } else if (result.status === 'lowrate' || result.status === 'error') {
                        errorDomains++;
                    }
                });
            }
        });
        
        elements.activeTests.textContent = activeTestGroups.size;
        elements.testedCount.textContent = testedDomains;
        elements.successCount.textContent = successDomains;
        elements.errorCount.textContent = errorDomains;
        elements.progressText.textContent = `${testedDomains}/${totalDomains}`;
        elements.progressBar.style.width = totalDomains > 0 ? `${(testedDomains / totalDomains) * 100}%` : '0%';
    }

    // æ›´æ–°æµ‹è¯•ç»Ÿè®¡
    function updateTestStats(isSuccess) {
        // è¿™é‡Œå¯ä»¥æ·»åŠ é¢å¤–çš„ç»Ÿè®¡é€»è¾‘
        updateTestProgress();
    }

    // åˆ‡æ¢æš‚åœçŠ¶æ€
    function togglePause() {
        isPaused = !isPaused;
        
        if (isPaused) {
            elements.pauseBtn.innerHTML = '<i class="fas fa-play"></i> ç»§ç»­';
            addLog('â¸ï¸ æ‰€æœ‰æµ‹è¯•å·²æš‚åœ', 'warning');
        } else {
            elements.pauseBtn.innerHTML = '<i class="fas fa-pause"></i> æš‚åœ';
            addLog('â–¶ï¸ æ‰€æœ‰æµ‹è¯•å·²ç»§ç»­', 'success');
            
            // ç»§ç»­æ‰€æœ‰æµ‹è¯•
            activeTestGroups.forEach((testState, groupId) => {
                if (testState.isTesting) {
                    testNextDomain(groupId);
                }
            });
        }
    }

    // åœæ­¢æ‰€æœ‰æµ‹è¯•
    function stopAllTests() {
        isPaused = false;
        
        activeTestGroups.forEach((testState, groupId) => {
            stopGroupTest(groupId);
        });
        
        hideTestControls();
        addLog('â¹ï¸ æ‰€æœ‰æµ‹è¯•å·²åœæ­¢', 'warning');
    }

    // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
    function updateStatsDisplay() {
        elements.todayTests.textContent = stats.todayTests;
        elements.sentNotifications.textContent = stats.sentNotifications;
        elements.totalDomains.textContent = stats.totalDomains;
    }

    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showStatus(message, type) {
        elements.configStatus.textContent = message;
        elements.configStatus.className = 'status-message';
        
        if (type === 'success') {
            elements.configStatus.classList.add('status-success');
        } else if (type === 'error') {
            elements.configStatus.classList.add('status-error');
        }
        
        elements.configStatus.style.display = 'block';
        
        setTimeout(() => {
            elements.configStatus.style.display = 'none';
        }, 3000);
    }

    // æ·»åŠ æ—¥å¿—
    function addLog(message, type = 'info') {
        const now = new Date();
        const timeString = now.toLocaleTimeString('zh-CN', { hour12: false });
        
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        
        let icon = 'ğŸ“';
        if (type === 'success') icon = 'âœ…';
        if (type === 'error') icon = 'âŒ';
        if (type === 'warning') icon = 'âš ï¸';
        if (type === 'info') icon = 'â„¹ï¸';
        
        logEntry.innerHTML = `
            <span class="log-time">${timeString}</span>
            <span class="log-content">${icon} ${message}</span>
        `;
        
        elements.monitorLog.appendChild(logEntry);
        elements.monitorLog.scrollTop = elements.monitorLog.scrollHeight;
        
        // é™åˆ¶æ—¥å¿—æ•°é‡
        const logEntries = elements.monitorLog.querySelectorAll('.log-entry');
        if (logEntries.length > 200) {
            for (let i = 0; i < logEntries.length - 200; i++) {
                logEntries[i].remove();
            }
        }
    }

    // åˆå§‹åŒ–åº”ç”¨
    init();
});
</script>
</body>
</html>
