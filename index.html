<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šç¾¤ç½‘ç«™ç›‘æ§ç³»ç»Ÿ v9.0 - å¢å¼ºç‰ˆ</title>
    <style>
        /* ===== å…¨å±€æ ·å¼é‡ç½® ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            --warning-gradient: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            --danger-gradient: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            --info-gradient: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            --telegram-gradient: linear-gradient(135deg, #0088cc 0%, #006699 100%);
            
            --primary-color: #667eea;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            --light-color: #f8f9fa;
            --dark-color: #2c3e50;
            --border-color: #e9ecef;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.12);
            --shadow-xl: 0 20px 60px rgba(0,0,0,0.15);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            
            --transition-normal: 0.3s ease;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }
        
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: var(--primary-gradient);
        }
        
        /* ===== å¤´éƒ¨æ ·å¼ ===== */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            position: relative;
        }
        
        header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: var(--primary-gradient);
            border-radius: 2px;
        }
        
        h1 {
            color: transparent;
            margin-bottom: 10px;
            font-size: 2.2rem;
            font-weight: 800;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            background-clip: text;
        }
        
        .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        /* ===== å¸ƒå±€ ===== */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }
        
        /* ===== ç¾¤ç»„é…ç½® ===== */
        .group-config {
            background: white;
            border-radius: var(--radius-lg);
            padding: 25px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            height: fit-content;
            position: sticky;
            top: 30px;
        }
        
        .group-config::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--telegram-gradient);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }
        
        .group-config h3 {
            color: var(--dark-color);
            margin-bottom: 20px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .group-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }
        
        .group-item {
            background: var(--light-color);
            border-radius: var(--radius-md);
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            transition: var(--transition-normal);
            cursor: pointer;
        }
        
        .group-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
            background: #e8f4fc;
        }
        
        .group-item.active {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(41, 128, 185, 0.1) 100%);
            border-color: var(--info-color);
        }
        
        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .group-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .group-buttons {
            display: flex;
            gap: 6px;
        }
        
        .group-btn {
            padding: 4px 8px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            cursor: pointer;
            background: var(--info-color);
            color: white;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .group-btn.delete {
            background: var(--danger-color);
        }
        
        .group-btn.edit {
            background: var(--warning-color);
        }
        
        .group-details {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .group-details div {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* ===== è¡¨å•å…ƒç´  ===== */
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            background: var(--light-color);
            transition: var(--transition-normal);
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            height: 150px;
            resize: vertical;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        /* ===== æŒ‰é’®æ ·å¼ ===== */
        .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-normal);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-success {
            background: var(--success-gradient);
            color: white;
        }
        
        .btn-telegram {
            background: var(--telegram-gradient);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning-gradient);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger-gradient);
            color: white;
        }
        
        .btn-info {
            background: var(--info-gradient);
            color: white;
        }
        
        .btn-secondary {
            background: var(--light-color);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }
        
        /* ===== é…ç½®åŒºåŸŸ ===== */
        .config-section {
            background: linear-gradient(135deg, rgba(212, 237, 218, 0.1) 0%, rgba(195, 230, 203, 0.1) 100%);
            border: 1px solid rgba(40, 167, 69, 0.15);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
        }
        
        .config-section h3 {
            color: var(--success-color);
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        
        /* ===== ç›‘æ§çŠ¶æ€ ===== */
        .monitor-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .status-card {
            background: white;
            padding: 20px;
            border-radius: var(--radius-lg);
            text-align: center;
            box-shadow: var(--shadow-md);
            border-top: 5px solid var(--info-color);
            transition: var(--transition-normal);
        }
        
        .status-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }
        
        .status-card.warning { border-top-color: var(--warning-color); }
        .status-card.danger { border-top-color: var(--danger-color); }
        .status-card.success { border-top-color: var(--success-color); }
        .status-card.telegram { border-top-color: #0088cc; }
        
        .status-number {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-primary);
            margin: 10px 0;
        }
        
        .status-title {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        /* ===== åŸŸååˆ—è¡¨ ===== */
        .domain-list {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: var(--radius-lg);
            max-height: 300px;
            overflow-y: auto;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            display: none;
        }
        
        .domain-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .domain-item:last-child {
            border-bottom: none;
        }
        
        .domain-name {
            flex: 1;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
        }
        
        .domain-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            min-width: 100px;
            text-align: center;
        }
        
        .status-pending { background: #f8f9fa; color: #6c757d; }
        .status-testing { background: #e3f2fd; color: #1976d2; animation: pulse 1.5s infinite; }
        .status-success { background: #e8f5e8; color: #2e7d32; }
        .status-error { background: #ffebee; color: #c62828; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* ===== æµ‹è¯•æ§åˆ¶ ===== */
        .test-controls {
            background: linear-gradient(135deg, #f8fdff 0%, #e8f4fc 100%);
            padding: 20px;
            border-radius: var(--radius-lg);
            margin: 20px 0;
            border: 1px solid rgba(52, 152, 219, 0.2);
            box-shadow: var(--shadow-md);
            display: none;
        }
        
        .test-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            background: white;
            padding: 12px;
            border-radius: var(--radius-md);
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .progress-bar {
            height: 10px;
            background: var(--light-color);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--success-gradient);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        /* ===== ç›‘æ§æ—¥å¿— ===== */
        .monitor-log {
            background: var(--dark-color);
            padding: 15px;
            border-radius: var(--radius-lg);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: #e9ecef;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid #34495e;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-time {
            color: #adb5bd;
            font-size: 0.8rem;
            min-width: 60px;
        }
        
        /* ===== çŠ¶æ€æ¶ˆæ¯ ===== */
        .status-message {
            margin-top: 10px;
            padding: 10px 15px;
            border-radius: var(--radius-md);
            display: none;
            font-weight: 500;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .status-success {
            background: rgba(212, 237, 218, 0.9);
            color: #155724;
            border-left: 5px solid var(--success-color);
        }
        
        .status-error {
            background: rgba(248, 215, 218, 0.9);
            color: #721c24;
            border-left: 5px solid var(--danger-color);
        }
        
        /* ===== é¡µè„š ===== */
        footer {
            margin-top: 30px;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }
        
        /* ===== å“åº”å¼è®¾è®¡ ===== */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .main-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .group-config {
                position: static;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
        
        /* ===== æ»šåŠ¨æ¡ç¾åŒ– ===== */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .monitor-log::-webkit-scrollbar-track {
            background: #2c3e50;
        }
        
        .monitor-log::-webkit-scrollbar-thumb {
            background: #4a6572;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-broadcast-tower"></i> å¤šç¾¤ç½‘ç«™ç›‘æ§ç³»ç»Ÿ v9.0</h1>
            <p class="subtitle">æ”¯æŒå¤šç¾¤ç›‘æ§ | ä¸€å¯¹ä¸€ç»“æœæ¨é€ | è¿è¥å•†èŠ‚ç‚¹åˆ†æ | å³æ—¶é€šçŸ¥</p>
        </header>
        
        <div class="main-layout">
            <div class="main-content">
                <!-- è¯´æ˜åŒºåŸŸ -->
                <div class="config-section">
                    <h3><i class="fas fa-info-circle"></i> ä½¿ç”¨è¯´æ˜</h3>
                    <p>1. åœ¨å³ä¾§æ·»åŠ ç¾¤ç»„é…ç½®ï¼ˆæ¯ä¸ªç¾¤ç‹¬ç«‹çš„Botå’Œæµ‹è¯•é“¾æ¥ï¼‰</p>
                    <p>2. ç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ªé“¾æ¥æ‰“å¼€ITDOGé¡µé¢æµ‹è¯•</p>
                    <p>3. <strong>æ¯æ¬¡æµ‹è¯•å®Œç«‹å³å‘é€ç»“æœ</strong>åˆ°å¯¹åº”ç¾¤ç»„ï¼ˆä¸åªæ˜¯å¼‚å¸¸ï¼‰</p>
                    <p>4. å¼‚å¸¸æ—¶ä¼š@ç¾¤ç»„ä¸­æŒ‡å®šçš„ç”¨æˆ·ï¼ˆå¤šä¸ªç”¨æˆ·ç”¨é€—å·åˆ†éš”ï¼‰</p>
                    <p>5. æ”¯æŒè¿è¥å•†èŠ‚ç‚¹åˆ†æï¼ŒåŒºåˆ†ç§»åŠ¨/è”é€š/ç”µä¿¡å¼‚å¸¸</p>
                </div>
                
                <!-- ç›‘æ§çŠ¶æ€ -->
                <div class="monitor-status" id="monitor-status">
                    <div class="status-card">
                        <div class="status-title">æ´»è·ƒç¾¤ç»„</div>
                        <div class="status-number" id="active-groups-count">0</div>
                    </div>
                    <div class="status-card warning">
                        <div class="status-title">ä»Šæ—¥æµ‹è¯•</div>
                        <div class="status-number" id="today-tests">0</div>
                    </div>
                    <div class="status-card telegram">
                        <div class="status-title">å‘é€é€šçŸ¥</div>
                        <div class="status-number" id="sent-notifications">0</div>
                    </div>
                    <div class="status-card">
                        <div class="status-title">æ€»é“¾æ¥æ•°</div>
                        <div class="status-number" id="total-domains">0</div>
                    </div>
                </div>
                
                <!-- æ‰¹é‡æµ‹è¯• -->
                <div class="config-section">
                    <h3><i class="fas fa-globe"></i> æ‰¹é‡æµ‹è¯•æ§åˆ¶</h3>
                    
                    <div class="buttons">
                        <button class="btn btn-success" id="start-all-btn">
                            <i class="fas fa-play"></i> å¯åŠ¨æ‰€æœ‰ç¾¤ç»„
                        </button>
                        <button class="btn btn-warning" id="start-selected-btn">
                            <i class="fas fa-bolt"></i> å¯åŠ¨é€‰ä¸­ç¾¤ç»„
                        </button>
                        <button class="btn btn-danger" id="stop-all-btn">
                            <i class="fas fa-stop"></i> åœæ­¢æ‰€æœ‰æµ‹è¯•
                        </button>
                        <button class="btn btn-info" id="test-now-btn">
                            <i class="fas fa-rocket"></i> ç«‹å³æµ‹è¯•ä¸€æ¬¡
                        </button>
                    </div>
                    
                    <!-- æµ‹è¯•è¿›åº¦ -->
                    <div class="test-controls" id="test-controls">
                        <div class="test-stats">
                            <div class="stat-item">
                                <div class="stat-label">è¿›è¡Œä¸­</div>
                                <div class="stat-value" id="active-tests">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">å·²æµ‹è¯•</div>
                                <div class="stat-value" id="tested-count">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">æˆåŠŸ</div>
                                <div class="stat-value" id="success-count">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">å¼‚å¸¸</div>
                                <div class="stat-value" id="error-count">0</div>
                            </div>
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-info">
                                <span>æµ‹è¯•è¿›åº¦</span>
                                <span id="progress-text">0/0</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-bar"></div>
                            </div>
                        </div>
                        
                        <div class="buttons">
                            <button class="btn btn-warning" id="pause-btn">
                                <i class="fas fa-pause"></i> æš‚åœ
                            </button>
                            <button class="btn btn-danger" id="stop-btn">
                                <i class="fas fa-stop"></i> åœæ­¢
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ç›‘æ§æ—¥å¿— -->
                <div class="config-section">
                    <h3><i class="fas fa-clipboard-list"></i> ç›‘æ§æ—¥å¿—</h3>
                    <div class="monitor-log" id="monitor-log">
                        <div class="log-entry">
                            <span class="log-time">å°±ç»ª</span>
                            <span class="log-content">ğŸ‰ å¤šç¾¤ç›‘æ§ç³»ç»Ÿ v9.0 å·²å¯åŠ¨ - æ”¯æŒä¸€å¯¹ä¸€ç»“æœå‘é€</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç¾¤ç»„é…ç½® -->
            <div class="group-config">
                <h3><i class="fab fa-telegram"></i> ç¾¤ç»„é…ç½®ç®¡ç†</h3>
                
                <div class="form-group">
                    <label for="group-name">ç¾¤ç»„åç§°</label>
                    <input type="text" id="group-name" placeholder="ä¾‹å¦‚ï¼šä¸»ç›‘æ§ç¾¤">
                </div>
                
                <div class="form-group">
                    <label for="bot-token">Bot Token</label>
                    <input type="password" id="bot-token" placeholder="è¾“å…¥Telegram Bot Token">
                </div>
                
                <div class="form-group">
                    <label for="chat-id">Chat ID</label>
                    <input type="text" id="chat-id" placeholder="è¾“å…¥ç¾¤ç»„Chat ID">
                </div>
                
                <div class="form-group">
                    <label for="mention-users">å¼‚å¸¸æ—¶@çš„ç”¨æˆ·ID</label>
                    <input type="text" id="mention-users" placeholder="ä¾‹å¦‚ï¼š123456,789012ï¼ˆé€—å·åˆ†éš”ï¼‰">
                </div>
                
                <div class="form-group">
                    <label for="connectivity-threshold">è¿é€šç‡é˜ˆå€¼ (%)</label>
                    <input type="number" id="connectivity-threshold" min="1" max="100" value="90" placeholder="ä½äºæ­¤å€¼å‘é€å¼‚å¸¸é€šçŸ¥">
                </div>
                
                <div class="form-group">
                    <label for="group-domains">æµ‹è¯•é“¾æ¥ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
                    <textarea id="group-domains" placeholder="https://example.com&#10;http://test.com/path&#10;www.domain.com"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="test-interval">æµ‹è¯•é—´éš”ï¼ˆåˆ†é’Ÿï¼‰</label>
                    <input type="number" id="test-interval" min="1" value="60">
                </div>
                
                <div class="buttons">
                    <button class="btn btn-telegram" id="save-group-btn">
                        <i class="fas fa-save"></i> ä¿å­˜ç¾¤ç»„
                    </button>
                    <button class="btn btn-secondary" id="clear-form-btn">
                        <i class="fas fa-times"></i> æ¸…ç©º
                    </button>
                    <button class="btn btn-danger" id="delete-group-btn" style="display: none;">
                        <i class="fas fa-trash"></i> åˆ é™¤ç¾¤ç»„
                    </button>
                </div>
                
                <div id="config-status" class="status-message"></div>
                
                <!-- ç¾¤ç»„åˆ—è¡¨ -->
                <div class="group-list" id="group-list">
                    <!-- ç¾¤ç»„é¡¹ç›®ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                </div>
            </div>
        </div>
        
        <footer>
            <p>å¤šç¾¤ç½‘ç«™ç›‘æ§ç³»ç»Ÿ v9.0 | ä¸Tampermonkeyè„šæœ¬é…åˆä½¿ç”¨ | è¿è¥å•†èŠ‚ç‚¹åˆ†æç‰ˆ</p>
            <p>è¯·ç¡®ä¿å·²å®‰è£… Tampermonkey æ‰©å±•å¹¶åŠ è½½ç›‘æ§è„šæœ¬</p>
        </footer>
    </div>

<script>
// ============================================
// å¤šç¾¤ç½‘ç«™ç›‘æ§ç³»ç»Ÿ v9.0
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    // å…ƒç´ å¼•ç”¨
    const elements = {
        // ç¾¤ç»„é…ç½®å…ƒç´ 
        groupName: document.getElementById('group-name'),
        botToken: document.getElementById('bot-token'),
        chatId: document.getElementById('chat-id'),
        mentionUsers: document.getElementById('mention-users'),
        connectivityThreshold: document.getElementById('connectivity-threshold'),
        groupDomains: document.getElementById('group-domains'),
        testInterval: document.getElementById('test-interval'),
        saveGroupBtn: document.getElementById('save-group-btn'),
        clearFormBtn: document.getElementById('clear-form-btn'),
        deleteGroupBtn: document.getElementById('delete-group-btn'),
        groupList: document.getElementById('group-list'),
        configStatus: document.getElementById('config-status'),
        
        // æµ‹è¯•æ§åˆ¶å…ƒç´ 
        startAllBtn: document.getElementById('start-all-btn'),
        startSelectedBtn: document.getElementById('start-selected-btn'),
        stopAllBtn: document.getElementById('stop-all-btn'),
        testNowBtn: document.getElementById('test-now-btn'),
        testControls: document.getElementById('test-controls'),
        pauseBtn: document.getElementById('pause-btn'),
        stopBtn: document.getElementById('stop-btn'),
        activeTests: document.getElementById('active-tests'),
        testedCount: document.getElementById('tested-count'),
        successCount: document.getElementById('success-count'),
        errorCount: document.getElementById('error-count'),
        progressText: document.getElementById('progress-text'),
        progressBar: document.getElementById('progress-bar'),
        
        // çŠ¶æ€æ˜¾ç¤ºå…ƒç´ 
        activeGroupsCount: document.getElementById('active-groups-count'),
        todayTests: document.getElementById('today-tests'),
        sentNotifications: document.getElementById('sent-notifications'),
        totalDomains: document.getElementById('total-domains'),
        
        // ç›‘æ§æ—¥å¿—å…ƒç´ 
        monitorLog: document.getElementById('monitor-log')
    };

    // çŠ¶æ€å˜é‡
    let groups = {};
    let activeTestGroups = new Map(); // groupId -> test state
    let selectedGroupId = null;
    let isTesting = false;
    let isPaused = false;
    let stats = {
        todayTests: 0,
        sentNotifications: 0,
        totalDomains: 0,
        lastReset: new Date().toDateString()
    };

    // æ¶ˆæ¯å¤„ç†å™¨
    window.messageHandlers = new Map();

    // åˆå§‹åŒ–
    function init() {
        loadGroups();
        loadStats();
        setupEventListeners();
        updateGroupList();
        updateStatsDisplay();
        
        // ç›‘å¬æ¥è‡ªITDOGé¡µé¢çš„æ¶ˆæ¯
        window.addEventListener('message', handleITDOGMessage);
        
        addLog('ğŸ‰ å¤šç¾¤ç›‘æ§ç³»ç»Ÿ v9.0 å·²å¯åŠ¨', 'success');
        addLog('ğŸ“¤ æ¯æ¬¡æµ‹è¯•å®Œç«‹å³å‘é€ç»“æœåˆ°å¯¹åº”ç¾¤ç»„', 'info');
        addLog('ğŸ‘¥ æ”¯æŒå¤šç¾¤ç‹¬ç«‹é…ç½®å’Œç›‘æ§', 'info');
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®æ¯æ—¥ç»Ÿè®¡
        checkDailyReset();
    }

    // åŠ è½½ç¾¤ç»„é…ç½®
    function loadGroups() {
        try {
            const savedGroups = localStorage.getItem('monitor_groups_v9');
            if (savedGroups) {
                groups = JSON.parse(savedGroups);
                updateTotalDomains();
            }
        } catch (error) {
            console.error('åŠ è½½ç¾¤ç»„é…ç½®å¤±è´¥:', error);
            addLog('âŒ åŠ è½½ç¾¤ç»„é…ç½®å¤±è´¥', 'error');
        }
    }

    // ä¿å­˜ç¾¤ç»„é…ç½®
    function saveGroups() {
        try {
            localStorage.setItem('monitor_groups_v9', JSON.stringify(groups));
            updateTotalDomains();
            return true;
        } catch (error) {
            console.error('ä¿å­˜ç¾¤ç»„é…ç½®å¤±è´¥:', error);
            addLog('âŒ ä¿å­˜ç¾¤ç»„é…ç½®å¤±è´¥', 'error');
            return false;
        }
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    function loadStats() {
        try {
            const savedStats = localStorage.getItem('monitor_stats_v9');
            if (savedStats) {
                const loadedStats = JSON.parse(savedStats);
                if (loadedStats.lastReset === new Date().toDateString()) {
                    stats = loadedStats;
                } else {
                    resetDailyStats();
                }
            }
        } catch (error) {
            console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        }
    }

    // ä¿å­˜ç»Ÿè®¡æ•°æ®
    function saveStats() {
        try {
            localStorage.setItem('monitor_stats_v9', JSON.stringify(stats));
        } catch (error) {
            console.error('ä¿å­˜ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        }
    }

    // æ›´æ–°æ€»åŸŸåæ•°
    function updateTotalDomains() {
        stats.totalDomains = 0;
        Object.values(groups).forEach(group => {
            stats.totalDomains += group.domains.length;
        });
        updateStatsDisplay();
    }

    // æ£€æŸ¥æ¯æ—¥é‡ç½®
    function checkDailyReset() {
        if (stats.lastReset !== new Date().toDateString()) {
            resetDailyStats();
            addLog('ğŸ“… æ–°çš„ä¸€å¤©ï¼Œç»Ÿè®¡å·²é‡ç½®', 'info');
        }
    }

    // é‡ç½®æ¯æ—¥ç»Ÿè®¡
    function resetDailyStats() {
        stats.todayTests = 0;
        stats.sentNotifications = 0;
        stats.lastReset = new Date().toDateString();
        saveStats();
        updateStatsDisplay();
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
        // ä¿å­˜ç¾¤ç»„
        elements.saveGroupBtn.addEventListener('click', saveGroup);
        elements.clearFormBtn.addEventListener('click', clearForm);
        elements.deleteGroupBtn.addEventListener('click', deleteGroup);
        
        // æµ‹è¯•æ§åˆ¶
        elements.startAllBtn.addEventListener('click', startAllGroups);
        elements.startSelectedBtn.addEventListener('click', startSelectedGroup);
        elements.stopAllBtn.addEventListener('click', stopAllGroups);
        elements.testNowBtn.addEventListener('click', testSelectedGroupOnce);
        elements.pauseBtn.addEventListener('click', togglePause);
        elements.stopBtn.addEventListener('click', stopAllTests);
    }

    // ä¿å­˜ç¾¤ç»„
    function saveGroup() {
        const groupName = elements.groupName.value.trim();
        const botToken = elements.botToken.value.trim();
        const chatId = elements.chatId.value.trim();
        const mentionUsers = elements.mentionUsers.value.trim();
        const threshold = parseInt(elements.connectivityThreshold.value) || 90;
        const domains = elements.groupDomains.value.trim();
        const interval = parseInt(elements.testInterval.value) || 60;
        
        // éªŒè¯
        if (!groupName || !botToken || !chatId || !domains) {
            showStatus('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
            return;
        }
        
        if (!botToken.match(/^\d+:[A-Za-z0-9_-]+$/)) {
            showStatus('Bot Tokenæ ¼å¼ä¸æ­£ç¡®', 'error');
            return;
        }
        
        const domainList = domains.split('\n')
            .map(d => d.trim())
            .filter(d => d.length > 0);
        
        if (domainList.length === 0) {
            showStatus('è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªæµ‹è¯•é“¾æ¥', 'error');
            return;
        }
        
        // å¤„ç†ç”¨æˆ·IDï¼ˆè½¬æ¢ä¸ºæ•°å­—æ•°ç»„ï¼‰
        const mentionUserIds = mentionUsers.split(',')
            .map(u => u.trim())
            .filter(u => u.match(/^\d+$/))
            .map(u => parseInt(u));
        
        const groupId = selectedGroupId || Date.now().toString();
        
        // ä¿å­˜ç¾¤ç»„
        groups[groupId] = {
            id: groupId,
            name: groupName,
            botToken: botToken,
            chatId: chatId,
            mentionUsers: mentionUserIds,
            threshold: threshold,
            domains: domainList,
            interval: interval,
            enabled: true,
            lastTested: null,
            lastResult: null,
            createdAt: new Date().toISOString()
        };
        
        if (saveGroups()) {
            showStatus(`ç¾¤ç»„ "${groupName}" å·²ä¿å­˜`, 'success');
            addLog(`âœ… ç¾¤ç»„å·²ä¿å­˜: ${groupName} (${domainList.length}ä¸ªé“¾æ¥)`, 'success');
            
            // æ›´æ–°æ˜¾ç¤º
            updateGroupList();
            clearForm();
            
            // å¦‚æœæ­£åœ¨ç¼–è¾‘ï¼Œå¯èƒ½éœ€è¦æ›´æ–°æµ‹è¯•çŠ¶æ€
            if (selectedGroupId && activeTestGroups.has(selectedGroupId)) {
                const testState = activeTestGroups.get(selectedGroupId);
                testState.group = groups[groupId]; // æ›´æ–°ç¾¤ç»„é…ç½®
            }
        }
    }

    // æ¸…é™¤è¡¨å•
    function clearForm() {
        elements.groupName.value = '';
        elements.botToken.value = '';
        elements.chatId.value = '';
        elements.mentionUsers.value = '';
        elements.connectivityThreshold.value = '90';
        elements.groupDomains.value = '';
        elements.testInterval.value = '60';
        selectedGroupId = null;
        elements.deleteGroupBtn.style.display = 'none';
        elements.saveGroupBtn.innerHTML = '<i class="fas fa-save"></i> ä¿å­˜ç¾¤ç»„';
        
        // æ¸…é™¤é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.group-item.active').forEach(item => {
            item.classList.remove('active');
        });
    }

    // åˆ é™¤ç¾¤ç»„
    function deleteGroup() {
        if (!selectedGroupId) return;
        
        const group = groups[selectedGroupId];
        if (!group) return;
        
        if (confirm(`ç¡®å®šè¦åˆ é™¤ç¾¤ç»„ "${group.name}" å—ï¼Ÿ`)) {
            // å¦‚æœæ­£åœ¨æµ‹è¯•ï¼Œå…ˆåœæ­¢
            if (activeTestGroups.has(selectedGroupId)) {
                stopGroupTest(selectedGroupId);
            }
            
            // åˆ é™¤ç¾¤ç»„
            delete groups[selectedGroupId];
            saveGroups();
            
            showStatus(`ç¾¤ç»„ "${group.name}" å·²åˆ é™¤`, 'success');
            addLog(`ğŸ—‘ï¸ å·²åˆ é™¤ç¾¤ç»„: ${group.name}`, 'warning');
            
            // æ›´æ–°æ˜¾ç¤º
            updateGroupList();
            clearForm();
        }
    }

    // æ›´æ–°ç¾¤ç»„åˆ—è¡¨æ˜¾ç¤º
    function updateGroupList() {
        elements.groupList.innerHTML = '';
        
        Object.values(groups).forEach(group => {
            const item = document.createElement('div');
            item.className = 'group-item';
            if (selectedGroupId === group.id) {
                item.classList.add('active');
            }
            item.dataset.groupId = group.id;
            
            const isActive = activeTestGroups.has(group.id);
            const activeStatus = isActive ? 'ğŸŸ¢ è¿è¡Œä¸­' : 'âšª æœªè¿è¡Œ';
            
            item.innerHTML = `
                <div class="group-header">
                    <span class="group-name">${group.name}</span>
                    <div class="group-buttons">
                        <button class="group-btn edit" title="ç¼–è¾‘">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="group-btn delete" title="åˆ é™¤">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="group-btn ${group.enabled ? 'disable' : 'enable'}" title="${group.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}">
                            <i class="fas fa-${group.enabled ? 'pause' : 'play'}"></i>
                        </button>
                    </div>
                </div>
                <div class="group-details">
                    <div><i class="fas fa-hashtag"></i> é“¾æ¥: ${group.domains.length}ä¸ª</div>
                    <div><i class="fas fa-clock"></i> é—´éš”: ${group.interval}åˆ†é’Ÿ</div>
                    <div><i class="fas fa-bell"></i> é˜ˆå€¼: ${group.threshold}%</div>
                    <div><i class="fas fa-users"></i> é€šçŸ¥: ${group.mentionUsers.length}äºº</div>
                    <div><i class="fas fa-power-off"></i> çŠ¶æ€: ${activeStatus}</div>
                    ${group.lastTested ? `<div><i class="fas fa-history"></i> æœ€å: ${new Date(group.lastTested).toLocaleTimeString()}</div>` : ''}
                </div>
            `;
            
            elements.groupList.appendChild(item);
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆé€‰ä¸­ç¾¤ç»„ï¼‰
            item.addEventListener('click', (e) => {
                if (!e.target.classList.contains('group-btn')) {
                    selectGroup(group.id);
                }
            });
            
            // æ·»åŠ æŒ‰é’®äº‹ä»¶
            item.querySelector('.edit').addEventListener('click', (e) => {
                e.stopPropagation();
                editGroup(group.id);
            });
            item.querySelector('.delete').addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm(`åˆ é™¤ç¾¤ç»„ "${group.name}"ï¼Ÿ`)) {
                    deleteGroupById(group.id);
                }
            });
            item.querySelector('.group-btn:not(.edit):not(.delete)').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleGroupEnabled(group.id);
            });
        });
    }

    // é€‰ä¸­ç¾¤ç»„
    function selectGroup(groupId) {
        selectedGroupId = groupId;
        
        // æ›´æ–°UI
        document.querySelectorAll('.group-item').forEach(item => {
            item.classList.remove('active');
        });
        const selectedItem = document.querySelector(`.group-item[data-group-id="${groupId}"]`);
        if (selectedItem) {
            selectedItem.classList.add('active');
        }
        
        // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
        elements.deleteGroupBtn.style.display = 'block';
        
        addLog(`ğŸ“Œ é€‰ä¸­ç¾¤ç»„: ${groups[groupId]?.name || 'æœªçŸ¥'}`, 'info');
    }

    // ç¼–è¾‘ç¾¤ç»„
    function editGroup(groupId) {
        const group = groups[groupId];
        if (!group) return;
        
        selectedGroupId = groupId;
        
        // å¡«å……è¡¨å•
        elements.groupName.value = group.name;
        elements.botToken.value = group.botToken;
        elements.chatId.value = group.chatId;
        elements.mentionUsers.value = group.mentionUsers.join(', ');
        elements.connectivityThreshold.value = group.threshold;
        elements.groupDomains.value = group.domains.join('\n');
        elements.testInterval.value = group.interval;
        
        // æ›´æ–°æŒ‰é’®
        elements.deleteGroupBtn.style.display = 'block';
        elements.saveGroupBtn.innerHTML = '<i class="fas fa-sync-alt"></i> æ›´æ–°ç¾¤ç»„';
        
        addLog(`âœï¸ æ­£åœ¨ç¼–è¾‘ç¾¤ç»„: ${group.name}`, 'info');
    }

    // åˆ é™¤ç¾¤ç»„ï¼ˆé€šè¿‡IDï¼‰
    function deleteGroupById(groupId) {
        const group = groups[groupId];
        if (!group) return;
        
        // å¦‚æœæ­£åœ¨æµ‹è¯•ï¼Œå…ˆåœæ­¢
        if (activeTestGroups.has(groupId)) {
            stopGroupTest(groupId);
        }
        
        // åˆ é™¤ç¾¤ç»„
        delete groups[groupId];
        saveGroups();
        
        showStatus(`ç¾¤ç»„ "${group.name}" å·²åˆ é™¤`, 'success');
        addLog(`ğŸ—‘ï¸ å·²åˆ é™¤ç¾¤ç»„: ${group.name}`, 'warning');
        
        // å¦‚æœåˆ é™¤çš„æ˜¯é€‰ä¸­çš„ç¾¤ç»„ï¼Œæ¸…ç©ºè¡¨å•
        if (selectedGroupId === groupId) {
            clearForm();
        }
        
        // æ›´æ–°æ˜¾ç¤º
        updateGroupList();
    }

    // å¯ç”¨/ç¦ç”¨ç¾¤ç»„
    function toggleGroupEnabled(groupId) {
        const group = groups[groupId];
        if (!group) return;
        
        group.enabled = !group.enabled;
        saveGroups();
        updateGroupList();
        
        const action = group.enabled ? 'å¯ç”¨' : 'ç¦ç”¨';
        addLog(`âš™ï¸ å·²${action}ç¾¤ç»„: ${group.name}`, 'info');
        
        // å¦‚æœç¦ç”¨æ—¶æ­£åœ¨æµ‹è¯•ï¼Œåœæ­¢æµ‹è¯•
        if (!group.enabled && activeTestGroups.has(groupId)) {
            stopGroupTest(groupId);
        }
    }

    // å¯åŠ¨æ‰€æœ‰ç¾¤ç»„
    function startAllGroups() {
        const enabledGroups = Object.values(groups).filter(g => g.enabled);
        
        if (enabledGroups.length === 0) {
            showStatus('æ²¡æœ‰å¯ç”¨çš„ç¾¤ç»„', 'error');
            return;
        }
        
        let startedCount = 0;
        enabledGroups.forEach(group => {
            if (!activeTestGroups.has(group.id)) {
                if (startGroupTest(group.id)) {
                    startedCount++;
                }
            }
        });
        
        showStatus(`å·²å¯åŠ¨ ${startedCount} ä¸ªç¾¤ç»„çš„ç›‘æ§`, 'success');
        updateActiveGroupsCount();
    }

    // å¯åŠ¨é€‰ä¸­ç¾¤ç»„
    function startSelectedGroup() {
        if (!selectedGroupId) {
            showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¾¤ç»„', 'error');
            return;
        }
        
        if (!groups[selectedGroupId].enabled) {
            showStatus('è¯¥ç¾¤ç»„å·²è¢«ç¦ç”¨', 'error');
            return;
        }
        
        if (activeTestGroups.has(selectedGroupId)) {
            showStatus('è¯¥ç¾¤ç»„å·²åœ¨è¿è¡Œä¸­', 'info');
            return;
        }
        
        if (startGroupTest(selectedGroupId)) {
            showStatus('ç¾¤ç»„ç›‘æ§å·²å¯åŠ¨', 'success');
            updateActiveGroupsCount();
        }
    }

    // æµ‹è¯•é€‰ä¸­ç¾¤ç»„ä¸€æ¬¡ï¼ˆä¸å¯åŠ¨å®šæ—¶ï¼‰
    function testSelectedGroupOnce() {
        if (!selectedGroupId) {
            showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¾¤ç»„', 'error');
            return;
        }
        
        const group = groups[selectedGroupId];
        if (!group || !group.enabled) {
            showStatus('ç¾¤ç»„ä¸å¯ç”¨æˆ–å·²è¢«ç¦ç”¨', 'error');
            return;
        }
        
        addLog(`ğŸš€ ç«‹å³æµ‹è¯•ç¾¤ç»„: ${group.name}`, 'info');
        
        // åˆ›å»ºä¸€æ¬¡æ€§æµ‹è¯•çŠ¶æ€
        const testState = {
            groupId: selectedGroupId,
            group: group,
            domains: [...group.domains],
            currentIndex: 0,
            isTesting: true,
            isOneTime: true, // æ ‡è®°ä¸ºä¸€æ¬¡æ€§æµ‹è¯•
            results: {},
            activeTabs: new Map()
        };
        
        activeTestGroups.set(selectedGroupId, testState);
        updateActiveGroupsCount();
        showTestControls();
        
        // å¼€å§‹æµ‹è¯•
        testNextDomain(selectedGroupId);
    }

    // å¯åŠ¨å•ä¸ªç¾¤ç»„æµ‹è¯•
    function startGroupTest(groupId) {
        const group = groups[groupId];
        if (!group || !group.enabled) return false;
        
        addLog(`ğŸš€ å¯åŠ¨ç¾¤ç»„æµ‹è¯•: ${group.name}`, 'info');
        
        // å¦‚æœå·²ç»åœ¨æµ‹è¯•ä¸­ï¼Œå…ˆåœæ­¢
        if (activeTestGroups.has(groupId)) {
            stopGroupTest(groupId);
        }
        
        // åˆ›å»ºæµ‹è¯•çŠ¶æ€
        const testState = {
            groupId: groupId,
            group: group,
            domains: [...group.domains],
            currentIndex: 0,
            isTesting: true,
            isOneTime: false, // å®šæ—¶æµ‹è¯•
            results: {},
            activeTabs: new Map(),
            timer: null,
            interval: group.interval * 60 * 1000 // è½¬æ¢ä¸ºæ¯«ç§’
        };
        
        activeTestGroups.set(groupId, testState);
        updateActiveGroupsCount();
        showTestControls();
        
        // å¼€å§‹ç¬¬ä¸€æ¬¡æµ‹è¯•
        testNextDomain(groupId);
        
        // è®¾ç½®å®šæ—¶å™¨ï¼ˆå¦‚æœä¸æ˜¯ä¸€æ¬¡æ€§æµ‹è¯•ï¼‰
        if (!testState.isOneTime && group.interval > 0) {
            testState.timer = setInterval(() => {
                if (testState.isTesting && !isPaused) {
                    addLog(`ğŸ”„ å®šæ—¶æµ‹è¯•: ${group.name}`, 'info');
                    testState.currentIndex = 0;
                    testState.results = {};
                    testNextDomain(groupId);
                }
            }, testState.interval);
        }
        
        return true;
    }

    // åœæ­¢å•ä¸ªç¾¤ç»„æµ‹è¯•
    function stopGroupTest(groupId) {
        const testState = activeTestGroups.get(groupId);
        if (!testState) return;
        
        testState.isTesting = false;
        
        // æ¸…é™¤å®šæ—¶å™¨
        if (testState.timer) {
            clearInterval(testState.timer);
            testState.timer = null;
        }
        
        // å…³é—­æ‰€æœ‰æ‰“å¼€çš„æ ‡ç­¾é¡µ
        testState.activeTabs.forEach(tab => {
            try {
                if (tab && !tab.closed) {
                    tab.close();
                }
            } catch (e) {
                console.error('å…³é—­æ ‡ç­¾é¡µå¤±è´¥:', e);
            }
        });
        testState.activeTabs.clear();
        
        // ä»æ´»åŠ¨åˆ—è¡¨ç§»é™¤
        activeTestGroups.delete(groupId);
        updateActiveGroupsCount();
        
        const group = groups[groupId];
        if (group) {
            addLog(`â¹ï¸ åœæ­¢ç¾¤ç»„æµ‹è¯•: ${group.name}`, 'warning');
        }
        
        // å¦‚æœæ²¡æœ‰æ´»åŠ¨çš„æµ‹è¯•ï¼Œéšè—æ§åˆ¶é¢æ¿
        if (activeTestGroups.size === 0) {
            hideTestControls();
        }
    }

    // åœæ­¢æ‰€æœ‰ç¾¤ç»„
    function stopAllGroups() {
        activeTestGroups.forEach((testState, groupId) => {
            stopGroupTest(groupId);
        });
        
        showStatus('å·²åœæ­¢æ‰€æœ‰ç¾¤ç»„çš„ç›‘æ§', 'info');
        hideTestControls();
    }

    // æµ‹è¯•ä¸‹ä¸€ä¸ªåŸŸå
    function testNextDomain(groupId) {
        const testState = activeTestGroups.get(groupId);
        if (!testState || !testState.isTesting || testState.currentIndex >= testState.domains.length) {
            // æµ‹è¯•å®Œæˆ
            if (testState) {
                testState.isTesting = false;
                testState.currentIndex = 0; // é‡ç½®ç´¢å¼•
                
                // æ›´æ–°ç¾¤ç»„æœ€åæµ‹è¯•æ—¶é—´
                const group = groups[groupId];
                if (group) {
                    group.lastTested = new Date().toISOString();
                    saveGroups();
                    updateGroupList();
                    
                    // å¦‚æœä¸æ˜¯ä¸€æ¬¡æ€§æµ‹è¯•ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡å®šæ—¶æ‰§è¡Œ
                    if (!testState.isOneTime) {
                        addLog(`âœ… ç¾¤ç»„æµ‹è¯•å®Œæˆ: ${group.name}ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡å®šæ—¶`, 'success');
                    } else {
                        addLog(`âœ… ä¸€æ¬¡æ€§æµ‹è¯•å®Œæˆ: ${group.name}`, 'success');
                        // ä¸€æ¬¡æ€§æµ‹è¯•å®Œæˆï¼Œç§»é™¤
                        setTimeout(() => {
                            activeTestGroups.delete(groupId);
                            updateActiveGroupsCount();
                        }, 1000);
                    }
                }
            }
            return;
        }
        
        const domain = testState.domains[testState.currentIndex];
        const domainIndex = testState.currentIndex;
        
        testState.currentIndex++;
        updateTestProgress();
        
        // æ‰“å¼€ITDOGé¡µé¢è¿›è¡Œæµ‹è¯•
        openITDOGTest(groupId, domain, domainIndex);
        
        // å¦‚æœæ²¡æœ‰æš‚åœï¼Œç»§ç»­æµ‹è¯•ä¸‹ä¸€ä¸ªï¼ˆå»¶è¿Ÿæ‰“å¼€ï¼Œé¿å…åŒæ—¶æ‰“å¼€å¤ªå¤šé¡µé¢ï¼‰
        if (!isPaused) {
            setTimeout(() => {
                if (testState && testState.isTesting) {
                    testNextDomain(groupId);
                }
            }, 5000); // 5ç§’é—´éš”
        }
    }

    // æ‰“å¼€ITDOGæµ‹è¯•é¡µé¢
    function openITDOGTest(groupId, domain, index) {
        try {
            // æ¸…ç†åŸŸåæ ¼å¼
            let cleanDomain = domain.trim();
            if (!cleanDomain.startsWith('http://') && !cleanDomain.startsWith('https://')) {
                cleanDomain = 'http://' + cleanDomain;
            }
            
            const encodedDomain = encodeURIComponent(cleanDomain);
            const url = `https://www.itdog.cn/http/?domain=${encodedDomain}`;
            
            // ç”Ÿæˆå”¯ä¸€çª—å£å
            const windowName = `itdog_${groupId}_${index}_${Date.now()}`;
            
            // æ‰“å¼€æ–°çª—å£
            const win = window.open(url, windowName, 'width=1200,height=800,menubar=no,toolbar=no,location=yes');
            
            if (!win) {
                addLog(`âŒ æ— æ³•æ‰“å¼€æ ‡ç­¾é¡µ: ${cleanDomain} (å¯èƒ½è¢«æµè§ˆå™¨é˜»æ­¢)`, 'error');
                
                // æ ‡è®°æµ‹è¯•å¤±è´¥
                const testState = activeTestGroups.get(groupId);
                if (testState) {
                    testState.results[index] = {
                        status: 'error',
                        domain: cleanDomain,
                        rate: 0
                    };
                    updateTestStats(false);
                }
                return;
            }
            
            // ä¿å­˜çª—å£å¼•ç”¨
            const testState = activeTestGroups.get(groupId);
            if (testState) {
                testState.activeTabs.set(index, win);
                
                // è®¾ç½®æ¶ˆæ¯å¤„ç†å™¨
                const messageHandler = (event) => {
                    if (event.data && event.data.type === 'ITDOG_TEST_RESULT') {
                        handleTestResult(event.data, groupId, cleanDomain, index);
                        // ç§»é™¤ç›‘å¬å™¨
                        win.removeEventListener('message', messageHandler);
                    }
                };
                
                // æ·»åŠ æ¶ˆæ¯ç›‘å¬
                win.addEventListener('message', messageHandler);
                
                // è®¾ç½®è¶…æ—¶æ£€æŸ¥
                setTimeout(() => {
                    try {
                        if (win.closed) {
                            addLog(`â° æ ‡ç­¾é¡µå·²å…³é—­: ${cleanDomain}`, 'info');
                        } else {
                            // å‘é€Pingæ¶ˆæ¯æ£€æŸ¥è„šæœ¬çŠ¶æ€
                            win.postMessage({ type: 'PING_ITDOG' }, '*');
                        }
                    } catch (e) {
                        // è·¨åŸŸé”™è¯¯ï¼Œå¿½ç•¥
                    }
                    
                    // æ¸…ç†å¼•ç”¨
                    if (testState.activeTabs) {
                        testState.activeTabs.delete(index);
                    }
                }, 180000); // 3åˆ†é’Ÿè¶…æ—¶
            }
            
            stats.todayTests++;
            updateStatsDisplay();
            saveStats();
            
            addLog(`ğŸŒ æ‰“å¼€æµ‹è¯•: ${cleanDomain}`, 'info');
            
        } catch (error) {
            addLog(`âŒ æ‰“å¼€æµ‹è¯•é¡µé¢å‡ºé”™: ${error.message}`, 'error');
        }
    }

    // å¤„ç†æµ‹è¯•ç»“æœ
    function handleTestResult(resultData, groupId, domain, index) {
        const testState = activeTestGroups.get(groupId);
        const group = groups[groupId];
        
        if (!testState || !group) return;
        
        // ä¿å­˜ç»“æœ
        testState.results[index] = {
            status: resultData.isLowRate ? 'lowrate' : 'success',
            domain: domain,
            rate: resultData.connectivityRate || 0,
            data: resultData
        };
        
        // æ›´æ–°ç»Ÿè®¡
        updateTestStats(!resultData.isLowRate);
        
        // è®°å½•åˆ°ç¾¤ç»„
        group.lastResult = {
            domain: domain,
            rate: resultData.connectivityRate || 0,
            time: new Date().toISOString(),
            isLowRate: resultData.isLowRate || false
        };
        saveGroups();
        updateGroupList();
        
        // å‘é€ç»“æœåˆ°Telegram
        sendResultToTelegram(group, domain, resultData);
        
        // å…³é—­æ ‡ç­¾é¡µ
        const tab = testState.activeTabs.get(index);
        if (tab && !tab.closed) {
            try {
                tab.close();
            } catch (e) {
                // å¿½ç•¥é”™è¯¯
            }
        }
        testState.activeTabs.delete(index);
        
        // æ›´æ–°è¿›åº¦
        updateTestProgress();
    }

    // å‘é€ç»“æœåˆ°Telegram
    async function sendResultToTelegram(group, domain, resultData) {
        const now = new Date();
        const currentTime = now.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        }).replace(/\//g, '-');
        
        const isLowRate = resultData.isLowRate || false;
        const rate = resultData.connectivityRate || 0;
        const statusEmoji = isLowRate ? 'âš ï¸' : 'âœ…';
        
        // æ„å»ºæ¶ˆæ¯
        let message = `${statusEmoji} *ç½‘ç«™ç›‘æ§ç»“æœ - ${group.name}*\n\n`;
        message += `ğŸŒ *æ£€æµ‹åŸŸå:* \`${domain}\`\n`;
        message += `ğŸ• *æ£€æµ‹æ—¶é—´:* ${currentTime}\n`;
        message += `ğŸ“Š *è¿é€šç‡:* ${rate}%\n`;
        message += `âœ… *æˆåŠŸèŠ‚ç‚¹:* ${resultData.success200Tests || 0}/${resultData.totalTests || 0}\n\n`;
        
        // è¿è¥å•†åˆ†æ
        if (resultData.operatorSummary) {
            const summary = resultData.operatorSummary;
            message += `ğŸ“¡ *è¿è¥å•†åˆ†æ*\n`;
            
            if (summary.mobileTotal > 0) {
                message += `â”œ ä¸­å›½ç§»åŠ¨: ${summary.mobileSuccess || 0}/${summary.mobileTotal} (${summary.mobileRate || 0}%)\n`;
            }
            if (summary.unicomTotal > 0) {
                message += `â”œ ä¸­å›½è”é€š: ${summary.unicomSuccess || 0}/${summary.unicomTotal} (${summary.unicomRate || 0}%)\n`;
            }
            if (summary.telecomTotal > 0) {
                message += `â”œ ä¸­å›½ç”µä¿¡: ${summary.telecomSuccess || 0}/${summary.telecomTotal} (${summary.telecomRate || 0}%)\n`;
            }
            
            const totalErrors = (summary.mobileErrors || 0) + (summary.unicomErrors || 0) + (summary.telecomErrors || 0) + (summary.otherErrors || 0);
            if (totalErrors > 0) {
                message += `â”œ å¼‚å¸¸æ€»æ•°: ${totalErrors}ä¸ª\n`;
                if (summary.mobileErrors > 0) message += `â”‚  â”œ ç§»åŠ¨å¼‚å¸¸: ${summary.mobileErrors}ä¸ª\n`;
                if (summary.unicomErrors > 0) message += `â”‚  â”œ è”é€šå¼‚å¸¸: ${summary.unicomErrors}ä¸ª\n`;
                if (summary.telecomErrors > 0) message += `â”‚  â”œ ç”µä¿¡å¼‚å¸¸: ${summary.telecomErrors}ä¸ª\n`;
                if (summary.otherErrors > 0) message += `â”‚  â”” å…¶ä»–å¼‚å¸¸: ${summary.otherErrors}ä¸ª\n`;
            }
            message += '\n';
        }
        
        // å¼‚å¸¸æ—¶@ç›¸å…³äººå‘˜
        if (isLowRate && group.mentionUsers.length > 0) {
            const mentions = group.mentionUsers.map(userId => `[${userId}](tg://user?id=${userId})`).join(' ');
            message += `ğŸ“¢ *å¼‚å¸¸é€šçŸ¥:* ${mentions}\n`;
            message += `âš ï¸ *å‘Šè­¦:* è¿é€šç‡ä½äº${group.threshold}%ï¼\n\n`;
        }
        
        message += `ğŸ”— *æµ‹è¯•é“¾æ¥:* https://www.itdog.cn/http/?domain=${encodeURIComponent(domain)}\n`;
        
        try {
            // å‘é€æ¶ˆæ¯
            const response = await sendTelegramMessage(group.botToken, group.chatId, message);
            
            if (response.ok) {
                stats.sentNotifications++;
                updateStatsDisplay();
                saveStats();
                
                const logMsg = isLowRate ? `âš ï¸ å¼‚å¸¸ç»“æœå·²å‘é€åˆ°ç¾¤ç»„: ${group.name}` : `âœ… ç»“æœå·²å‘é€åˆ°ç¾¤ç»„: ${group.name}`;
                addLog(logMsg, isLowRate ? 'warning' : 'success');
                
                return true;
            } else {
                throw new Error(response.description || 'å‘é€å¤±è´¥');
            }
        } catch (error) {
            addLog(`âŒ å‘é€ç»“æœå¤±è´¥: ${error.message}`, 'error');
            return false;
        }
    }

    // å‘é€Telegramæ¶ˆæ¯
    async function sendTelegramMessage(botToken, chatId, text) {
        const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                chat_id: chatId,
                text: text,
                parse_mode: 'Markdown',
                disable_web_page_preview: true
            })
        });
        
        return await response.json();
    }

    // å¤„ç†ITDOGé¡µé¢æ¶ˆæ¯
    function handleITDOGMessage(event) {
        // åªå¤„ç†æ¥è‡ªITDOGåŸŸåçš„æ¶ˆæ¯
        if (event.origin !== 'https://www.itdog.cn' && event.origin !== 'http://www.itdog.cn') {
            return;
        }
        
        if (event.data && event.data.type === 'ITDOG_TEST_RESULT') {
            console.log('ğŸ“© æ”¶åˆ°ITDOGæµ‹è¯•ç»“æœ:', event.data);
            
            // è¿™é‡Œå¯ä»¥é€šè¿‡æ¶ˆæ¯å¤„ç†å™¨è·¯ç”±åˆ°å¯¹åº”çš„ç¾¤ç»„å¤„ç†
            // ä½†ç”±äºè·¨åŸŸé™åˆ¶ï¼Œé€šå¸¸ç”±æµ‹è¯•é¡µé¢ç›´æ¥å‘é€ç»“æœ
        }
    }

    // æ˜¾ç¤ºæµ‹è¯•æ§åˆ¶é¢æ¿
    function showTestControls() {
        if (!isTesting) {
            isTesting = true;
            elements.testControls.style.display = 'block';
        }
    }

    // éšè—æµ‹è¯•æ§åˆ¶é¢æ¿
    function hideTestControls() {
        if (isTesting && activeTestGroups.size === 0) {
            isTesting = false;
            elements.testControls.style.display = 'none';
        }
    }

    // æ›´æ–°æ´»è·ƒç¾¤ç»„æ•°
    function updateActiveGroupsCount() {
        const activeCount = Array.from(activeTestGroups.values()).filter(t => t.isTesting).length;
        elements.activeGroupsCount.textContent = activeCount;
    }

    // æ›´æ–°æµ‹è¯•è¿›åº¦
    function updateTestProgress() {
        let totalDomains = 0;
        let testedDomains = 0;
        let successDomains = 0;
        let errorDomains = 0;
        
        activeTestGroups.forEach(testState => {
            if (testState.isTesting) {
                totalDomains += testState.domains.length;
                testedDomains += testState.currentIndex;
                
                // ç»Ÿè®¡æˆåŠŸå’Œå¤±è´¥
                Object.values(testState.results).forEach(result => {
                    if (result.status === 'success') {
                        successDomains++;
                    } else if (result.status === 'lowrate' || result.status === 'error') {
                        errorDomains++;
                    }
                });
            }
        });
        
        elements.activeTests.textContent = activeTestGroups.size;
        elements.testedCount.textContent = testedDomains;
        elements.successCount.textContent = successDomains;
        elements.errorCount.textContent = errorDomains;
        elements.progressText.textContent = `${testedDomains}/${totalDomains}`;
        elements.progressBar.style.width = totalDomains > 0 ? `${(testedDomains / totalDomains) * 100}%` : '0%';
    }

    // æ›´æ–°æµ‹è¯•ç»Ÿè®¡
    function updateTestStats(isSuccess) {
        // è¿™é‡Œå¯ä»¥æ·»åŠ é¢å¤–çš„ç»Ÿè®¡é€»è¾‘
        updateTestProgress();
    }

    // åˆ‡æ¢æš‚åœçŠ¶æ€
    function togglePause() {
        isPaused = !isPaused;
        
        if (isPaused) {
            elements.pauseBtn.innerHTML = '<i class="fas fa-play"></i> ç»§ç»­';
            addLog('â¸ï¸ æ‰€æœ‰æµ‹è¯•å·²æš‚åœ', 'warning');
        } else {
            elements.pauseBtn.innerHTML = '<i class="fas fa-pause"></i> æš‚åœ';
            addLog('â–¶ï¸ æ‰€æœ‰æµ‹è¯•å·²ç»§ç»­', 'success');
            
            // ç»§ç»­æ‰€æœ‰æµ‹è¯•
            activeTestGroups.forEach((testState, groupId) => {
                if (testState.isTesting) {
                    testNextDomain(groupId);
                }
            });
        }
    }

    // åœæ­¢æ‰€æœ‰æµ‹è¯•
    function stopAllTests() {
        isPaused = false;
        
        activeTestGroups.forEach((testState, groupId) => {
            stopGroupTest(groupId);
        });
        
        hideTestControls();
        addLog('â¹ï¸ æ‰€æœ‰æµ‹è¯•å·²åœæ­¢', 'warning');
    }

    // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
    function updateStatsDisplay() {
        elements.todayTests.textContent = stats.todayTests;
        elements.sentNotifications.textContent = stats.sentNotifications;
        elements.totalDomains.textContent = stats.totalDomains;
    }

    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showStatus(message, type) {
        elements.configStatus.textContent = message;
        elements.configStatus.className = 'status-message';
        
        if (type === 'success') {
            elements.configStatus.classList.add('status-success');
        } else if (type === 'error') {
            elements.configStatus.classList.add('status-error');
        }
        
        elements.configStatus.style.display = 'block';
        
        setTimeout(() => {
            elements.configStatus.style.display = 'none';
        }, 3000);
    }

    // æ·»åŠ æ—¥å¿—
    function addLog(message, type = 'info') {
        const now = new Date();
        const timeString = now.toLocaleTimeString('zh-CN', { hour12: false });
        
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        
        let icon = 'ğŸ“';
        if (type === 'success') icon = 'âœ…';
        if (type === 'error') icon = 'âŒ';
        if (type === 'warning') icon = 'âš ï¸';
        if (type === 'info') icon = 'â„¹ï¸';
        
        logEntry.innerHTML = `
            <span class="log-time">${timeString}</span>
            <span class="log-content">${icon} ${message}</span>
        `;
        
        elements.monitorLog.appendChild(logEntry);
        elements.monitorLog.scrollTop = elements.monitorLog.scrollHeight;
        
        // é™åˆ¶æ—¥å¿—æ•°é‡
        const logEntries = elements.monitorLog.querySelectorAll('.log-entry');
        if (logEntries.length > 200) {
            for (let i = 0; i < logEntries.length - 200; i++) {
                logEntries[i].remove();
            }
        }
    }

    // åˆå§‹åŒ–åº”ç”¨
    init();
});
</script>
</body>
</html>

ä½ è¿™ä¸ªä»£ç æ£€æµ‹å®Œä¹Ÿä¸ä¼šæˆªå›¾å‘é€åˆ°é£æœºå•Š  ä»¥ä¸‹æ˜¯tampermonkey.netè„šæœ¬ ç»™æˆ‘ä¿®æ”¹åçš„å®Œæ•´ä»£ç  è¦å¯ä»¥ä½¿ç”¨çš„ä¸æ˜¯æ¨¡æ‹Ÿ

// ==UserScript==
// @name         ITDOGç½‘ç«™æµ‹é€Ÿç›‘æ§ v8.1 - è¿è¥å•†èŠ‚ç‚¹åˆ†æç‰ˆ
// @namespace    http://tampermonkey.net/
// @version      8.1
// @description  è‡ªåŠ¨æå–åŸŸåã€å–æ¶ˆæ¸¯æ¾³å°é€‰é¡¹ã€ç‚¹å‡»å¼€å§‹æµ‹è¯•ã€ç›‘æ§è¿é€šç‡å¹¶è¿”å›ç»“æœç»™ä¸»é¡µé¢ï¼Œæ–°å¢è¿è¥å•†èŠ‚ç‚¹åˆ†æåŠŸèƒ½
// @author       ITDOGç›‘æ§ç³»ç»Ÿ
// @match        https://www.itdog.cn/*
// @run-at       document-end
// @grant        GM_addStyle
// @grant        GM_setValue
// @grant        GM_getValue
// ==/UserScript==

(function() {
    'use strict';

    // ====== é˜²é‡å¤æ‰§è¡Œæ£€æŸ¥ ======
    if (window.itdogMonitorRunningV81) {
        console.log('ğŸš« ITDOGç›‘æ§è„šæœ¬å·²åœ¨è¿è¡Œä¸­ï¼Œç¦æ­¢é‡å¤æ‰§è¡Œ');
        return;
    }
    window.itdogMonitorRunningV81 = true;

    console.log('ğŸš€ ITDOGç›‘æ§è„šæœ¬å¯åŠ¨ - è¿è¥å•†èŠ‚ç‚¹åˆ†æç‰ˆ v8.1');

    // é…ç½®
    const CONFIG = {
        maxChecks: 60,           // ç›‘æ§æ¬¡æ•°
        checkInterval: 2000,     // æ£€æŸ¥é—´éš”2ç§’
        minSuccessRate: 90,      // æœ€ä½è¿é€šç‡
        minTotalTests: 8,        // æœ€å°‘æ£€æµ‹èŠ‚ç‚¹æ•°
        timeout: 150000,         // 2.5åˆ†é’Ÿè¶…æ—¶
        waitAfterClick: 5000,    // ç‚¹å‡»åç­‰å¾…5ç§’
        stableThreshold: 3,      // ç¨³å®šæ¬¡æ•°é˜ˆå€¼
        sessionKey: 'itdog_monitor_state_81' // sessionå­˜å‚¨é”®å
    };

    // å…¨å±€çŠ¶æ€æ ‡è®°
    let hasProcessed = false;
    let testStarted = false;
    let testReallyStarted = false;
    let monitoringStarted = false;
    let resultsSent = false;
    let monitoringInterval = null;
    let checkCount = 0;
    let clickTime = 0;
    let currentStage = 'initial';

    // ==================== è¿è¥å•†è¯†åˆ«å‡½æ•° ====================
    function identifyOperator(nodeText) {
        if (!nodeText) return 'other';

        const text = nodeText.toLowerCase();

        if (text.includes('ç§»åŠ¨') || text.includes('cmcc') || text.includes('chinamobile')) {
            return 'mobile';
        } else if (text.includes('è”é€š') || text.includes('unicom') || text.includes('chinaunicom')) {
            return 'unicom';
        } else if (text.includes('ç”µä¿¡') || text.includes('telecom') || text.includes('chinatelecom')) {
            return 'telecom';
        } else if (text.includes('bgp') || text.includes('å¤šçº¿')) {
            return 'bgp';
        } else if (text.includes('æ•™è‚²ç½‘') || text.includes('cernet')) {
            return 'edu';
        } else if (text.includes('é“é€š') || text.includes('tietong')) {
            return 'tietong';
        } else if (text.includes('é•¿åŸ') || text.includes('greatwall')) {
            return 'greatwall';
        } else {
            return 'other';
        }
    }

    // ==================== çŠ¶æ€ç®¡ç† ====================
    class StateManager {
        constructor() {
            this.stateKey = CONFIG.sessionKey;
            this.clearOldSessions();
        }

        getState() {
            try {
                const stateStr = sessionStorage.getItem(this.stateKey);
                return stateStr ? JSON.parse(stateStr) : null;
            } catch (e) {
                console.log('è·å–çŠ¶æ€å¤±è´¥:', e);
                return null;
            }
        }

        setState(state) {
            try {
                const stateData = {
                    ...state,
                    timestamp: Date.now(),
                    version: '8.1'
                };
                sessionStorage.setItem(this.stateKey, JSON.stringify(stateData));
                console.log('ğŸ’¾ çŠ¶æ€å·²ä¿å­˜:', stateData.stage);
                return true;
            } catch (e) {
                console.log('ä¿å­˜çŠ¶æ€å¤±è´¥:', e);
                return false;
            }
        }

        clearState() {
            try {
                sessionStorage.removeItem(this.stateKey);
                console.log('ğŸ—‘ï¸ çŠ¶æ€å·²æ¸…é™¤');
                return true;
            } catch (e) {
                return false;
            }
        }

        clearOldSessions() {
            try {
                const allKeys = Object.keys(sessionStorage);
                allKeys.forEach(key => {
                    if (key.startsWith('itdog_') && key !== this.stateKey) {
                        sessionStorage.removeItem(key);
                    }
                });
            } catch (e) {
                // å¿½ç•¥é”™è¯¯
            }
        }

        isPageRefreshed() {
            const state = this.getState();
            if (!state) return false;

            const timeDiff = Date.now() - state.timestamp;
            if (timeDiff > 10 * 60 * 1000) {
                this.clearState();
                return false;
            }

            return state.stage === 'monitoring' || state.stage === 'post_refresh';
        }

        updateStage(stage, data = {}) {
            currentStage = stage;
            const state = this.getState() || {};

            const newState = {
                ...state,
                stage: stage,
                ...data,
                pageUrl: window.location.href,
                timestamp: Date.now()
            };

            this.setState(newState);
            return newState;
        }
    }

    // åˆ›å»ºçŠ¶æ€ç®¡ç†å™¨
    const stateManager = new StateManager();

    // ==================== é¡µé¢é˜¶æ®µåˆ¤æ–­ ====================
    function detectPagePhase() {
        console.log('ğŸ” æ£€æµ‹é¡µé¢é˜¶æ®µ...');

        const results = extractResults();
        const hasTestResults = results.totalTests > 0;

        const url = window.location.href;
        const pageText = document.body.textContent.toLowerCase();

        const isResultPage = hasTestResults ||
                           pageText.includes('æµ‹è¯•å®Œæˆ') ||
                           pageText.includes('æ£€æµ‹å®Œæˆ') ||
                           pageText.includes('è¿é€šç‡') ||
                           url.includes('/result/') ||
                           url.includes('test_id=');

        const startButton = findStartButton();
        const hasStartButton = startButton !== null;

        console.log(`ğŸ“Š é¡µé¢åˆ†æ: ç»“æœ=${hasTestResults}, å¼€å§‹æŒ‰é’®=${hasStartButton}, URL=${url}`);

        if (stateManager.isPageRefreshed()) {
            console.log('ğŸ”„ æ£€æµ‹åˆ°é¡µé¢åˆ·æ–°ï¼Œç»§ç»­ç›‘æ§');
            return 'post_refresh';
        } else if (isResultPage && !hasStartButton) {
            console.log('ğŸ“Š æ£€æµ‹åˆ°ç»“æœé¡µé¢ï¼Œç›´æ¥ç›‘æ§');
            return 'monitoring';
        } else if (hasStartButton) {
            console.log('ğŸš€ æ£€æµ‹åˆ°å¼€å§‹é¡µé¢ï¼Œå‡†å¤‡å¼€å§‹æµ‹è¯•');
            return 'pre_test';
        } else {
            console.log('â“ æœªçŸ¥é¡µé¢çŠ¶æ€');
            return 'initial';
        }
    }

    // ==================== æ ·å¼æ³¨å…¥ ====================
    function injectStyles() {
        if (document.getElementById('itdog-monitor-styles')) {
            return;
        }

        const style = document.createElement('style');
        style.id = 'itdog-monitor-styles';
        style.textContent = `
            #itdog-monitor-status {
                position: fixed !important;
                top: 20px !important;
                right: 20px !important;
                background: rgba(0, 0, 0, 0.95) !important;
                color: white !important;
                padding: 15px 20px !important;
                border-radius: 10px !important;
                z-index: 999999 !important;
                font-family: 'Microsoft YaHei', Arial, sans-serif !important;
                font-size: 13px !important;
                border: 2px solid #3498db !important;
                box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5) !important;
                min-width: 300px !important;
                max-width: 400px !important;
                backdrop-filter: blur(10px) !important;
            }

            #itdog-monitor-completion {
                position: fixed !important;
                top: 50% !important;
                left: 50% !important;
                transform: translate(-50%, -50%) !important;
                background: linear-gradient(135deg, #1a1a1a, #2c3e50) !important;
                color: white !important;
                padding: 40px !important;
                border-radius: 20px !important;
                z-index: 1000000 !important;
                text-align: center !important;
                width: 500px !important;
                border: 3px solid #2ecc71 !important;
                box-shadow: 0 20px 60px rgba(0,0,0,0.8) !important;
                animation: fadeInScale 0.5s ease-out !important;
            }

            @keyframes fadeInScale {
                from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
                to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            }

            .itdog-highlight {
                box-shadow: 0 0 0 3px #f39c12 !important;
                animation: pulse 2s infinite !important;
                transition: all 0.3s ease !important;
            }

            @keyframes pulse {
                0% { box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.7); }
                50% { box-shadow: 0 0 0 6px rgba(243, 156, 18, 0.3); }
                100% { box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.7); }
            }

            .itdog-input-filled {
                background-color: rgba(46, 204, 113, 0.1) !important;
                border-color: #2ecc71 !important;
            }
        `;
        document.head.appendChild(style);
        console.log('âœ… ç›‘æ§æ ·å¼å·²æ³¨å…¥');
    }

    // ==================== è·å–åŸŸå ====================
    function getDomain() {
        console.log('ğŸ” è·å–æµ‹è¯•åŸŸå...');

        try {
            // ä¼˜å…ˆä»çŠ¶æ€ä¸­è·å–
            const state = stateManager.getState();
            if (state && state.domain) {
                console.log('âœ… ä»çŠ¶æ€è·å–åŸŸå:', state.domain);
                return state.domain;
            }

            // ä»URLå‚æ•°è·å–
            const urlParams = new URLSearchParams(window.location.search);
            let domain = urlParams.get('domain');

            if (domain) {
                domain = decodeURIComponent(domain).trim();
                console.log('âœ… ä»URLå‚æ•°è·å–åŸŸå:', domain);
                return domain;
            }

            // ä»URLè·¯å¾„è·å–
            const urlMatch = window.location.pathname.match(/\/(?:ping|http|tcp|ping_full)\/(.+)/);
            if (urlMatch && urlMatch[1]) {
                domain = decodeURIComponent(urlMatch[1]).trim();
                console.log('âœ… ä»URLè·¯å¾„è·å–å®Œæ•´åŸŸå:', domain);
                return domain;
            }

            // ä»è¾“å…¥æ¡†è·å–
            const inputs = document.querySelectorAll('input[type="text"], input[type="url"], input[placeholder*="åŸŸå"], input[placeholder*="ç½‘å€"], input[placeholder*="URL"]');
            for (const input of inputs) {
                if (input && input.value) {
                    let value = input.value.trim();
                    if (value.length > 3) {
                        console.log('âœ… ä»è¾“å…¥æ¡†è·å–å®Œæ•´åŸŸå:', value);
                        return value;
                    }
                }
            }

            // é¢å¤–æŸ¥æ‰¾
            const urlElements = document.querySelectorAll('[href*="://"], [data-url], [data-domain], [src*="://"]');
            for (const element of urlElements) {
                const url = element.getAttribute('href') ||
                           element.getAttribute('data-url') ||
                           element.getAttribute('data-domain') ||
                           element.getAttribute('src');
                if (url && (url.includes('://') || url.startsWith('http'))) {
                    const trimmedUrl = url.trim();
                    console.log('âœ… ä»å…ƒç´ å±æ€§è·å–å®Œæ•´åŸŸå:', trimmedUrl);
                    return trimmedUrl;
                }
            }

            // æŸ¥æ‰¾é¡µé¢æ–‡æœ¬ä¸­çš„URL
            const urlRegex = /(https?:\/\/[^\s<>"']+(?:\/[^\s<>"']*)?)/g;
            const pageText = document.body.textContent;
            const matches = pageText.match(urlRegex);
            if (matches && matches.length > 0) {
                for (const match of matches) {
                    if (match.length > 10 && !match.includes('itdog.cn') && !match.includes('.css') && !match.includes('.js')) {
                        console.log('âœ… ä»é¡µé¢æ–‡æœ¬è·å–å®Œæ•´åŸŸå:', match);
                        return match.trim();
                    }
                }
            }

            // æŸ¥æ‰¾è¡¨å•ä¸­çš„éšè—å­—æ®µ
            const hiddenInputs = document.querySelectorAll('input[type="hidden"]');
            for (const input of hiddenInputs) {
                const name = (input.name || '').toLowerCase();
                const value = input.value || '';
                if ((name.includes('url') || name.includes('domain')) && value.length > 5) {
                    console.log('âœ… ä»éšè—å­—æ®µè·å–åŸŸå:', value);
                    return value.trim();
                }
            }

            console.log('âŒ æœªæ‰¾åˆ°åŸŸå');
            return null;

        } catch (error) {
            console.log('è·å–åŸŸåå¤±è´¥:', error);
            return null;
        }
    }

    // ==================== æå–æµ‹è¯•ç»“æœï¼ˆè¿è¥å•†åˆ†æç‰ˆï¼‰ ====================
    function extractResults() {
        let totalTests = 0;
        let success200Tests = 0;
        let connectivityRate = 0;
        let completed = false;
        let hasResults = false;

        // æ–°å¢ï¼šè¿è¥å•†ç»Ÿè®¡
        const operatorStats = {
            mobile: { name: 'ä¸­å›½ç§»åŠ¨', success: 0, total: 0, errors: [] },
            unicom: { name: 'ä¸­å›½è”é€š', success: 0, total: 0, errors: [] },
            telecom: { name: 'ä¸­å›½ç”µä¿¡', success: 0, total: 0, errors: [] },
            bgp: { name: 'BGPå¤šçº¿', success: 0, total: 0, errors: [] },
            other: { name: 'å…¶ä»–ç½‘ç»œ', success: 0, total: 0, errors: [] }
        };

        try {
            // æŸ¥æ‰¾æ£€æµ‹ç‚¹è¡¨æ ¼
            const tables = document.querySelectorAll('table');

            for (const table of tables) {
                const rows = table.querySelectorAll('tr');
                if (rows.length < 2) continue;

                const firstRow = rows[0].textContent.toLowerCase();
                const secondRow = rows[1] ? rows[1].textContent.toLowerCase() : '';

                const isTestTable = firstRow.includes('æ£€æµ‹ç‚¹') ||
                                   firstRow.includes('èŠ‚ç‚¹') ||
                                   firstRow.includes('location') ||
                                   firstRow.includes('çŠ¶æ€') ||
                                   firstRow.includes('å“åº”') ||
                                   firstRow.includes('è€—æ—¶') ||
                                   firstRow.includes('ms') ||
                                   secondRow.includes('ms') ||
                                   secondRow.includes('æˆåŠŸ') ||
                                   secondRow.includes('å¤±è´¥');

                if (isTestTable) {
                    console.log('âœ… æ‰¾åˆ°æ£€æµ‹ç‚¹è¡¨æ ¼ï¼Œè¡Œæ•°:', rows.length);

                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        const cells = row.querySelectorAll('td');
                        if (cells.length < 2) continue;

                        totalTests++;
                        hasResults = true;

                        const rowText = row.textContent.toLowerCase();
                        let isSuccess = false;

                        // æå–èŠ‚ç‚¹åç§°ï¼ˆé€šå¸¸åœ¨ç¬¬ä¸€åˆ—ï¼‰
                        const nodeName = cells[0]?.textContent?.trim() || '';
                        const nodeOperator = identifyOperator(nodeName);

                        // è¯†åˆ«çŠ¶æ€
                        let statusCode = 'unknown';
                        let responseTime = 'unknown';

                        // å°è¯•ä»å•å…ƒæ ¼ä¸­æå–çŠ¶æ€ç å’Œå“åº”æ—¶é—´
                        for (let j = 1; j < cells.length; j++) {
                            const cellText = cells[j].textContent.trim();

                            // æ£€æŸ¥çŠ¶æ€ç 
                            if (/^\d{3}$/.test(cellText) || cellText.includes('200') || cellText.includes('404') || cellText.includes('502')) {
                                statusCode = cellText;
                            }

                            // æ£€æŸ¥å“åº”æ—¶é—´
                            if (cellText.includes('ms') || cellText.includes('æ¯«ç§’')) {
                                responseTime = cellText;
                            }
                        }

                        // åˆ¤æ–­æ˜¯å¦æˆåŠŸ
                        if (rowText.includes('200') || statusCode === '200') {
                            isSuccess = true;
                        } else if (rowText.includes('æˆåŠŸ') ||
                                 rowText.includes('æ­£å¸¸') ||
                                 rowText.includes('è¿é€š') ||
                                 rowText.includes('ok') ||
                                 rowText.includes('success')) {
                            isSuccess = true;
                        } else if (row.querySelector('.text-success, .success, [style*="color:green"], [style*="color:#"]')) {
                            const color = window.getComputedStyle(row).color;
                            if (color.includes('rgb(0, 128, 0)') || color.includes('#008000') || color.includes('#00') || color.includes('rgb(46, 204, 113)')) {
                                isSuccess = true;
                            }
                        }

                        // ç»Ÿè®¡è¿è¥å•†æ•°æ®
                        operatorStats[nodeOperator].total++;
                        if (isSuccess) {
                            success200Tests++;
                            operatorStats[nodeOperator].success++;
                        } else {
                            // è®°å½•é”™è¯¯è¯¦æƒ…
                            operatorStats[nodeOperator].errors.push({
                                nodeName: nodeName,
                                operator: operatorStats[nodeOperator].name,
                                statusCode: statusCode,
                                responseTime: responseTime,
                                rowIndex: i,
                                rawText: rowText.substring(0, 50)
                            });
                        }
                    }

                    if (totalTests > 0) {
                        connectivityRate = Math.round((success200Tests / totalTests) * 100);
                        completed = totalTests >= CONFIG.minTotalTests;
                        break;
                    }
                }
            }

            // å…¶ä»–æŸ¥æ‰¾æ–¹æ³•ï¼ˆå¤‡ç”¨ï¼‰
            if (!hasResults) {
                const testElements = document.querySelectorAll('.test-item, .node-item, .server-item, [class*="ping-"], [class*="test-"]');
                if (testElements.length > 0) {
                    totalTests = testElements.length;
                    hasResults = true;

                    const successElements = document.querySelectorAll('.text-success, .success, .passed, [class*="ok"]');
                    success200Tests = Math.min(successElements.length, totalTests);
                    connectivityRate = Math.round((success200Tests / totalTests) * 100);
                    completed = totalTests >= CONFIG.minTotalTests;

                    // å¤‡ç”¨æ–¹æ³•æ— æ³•è·å–è¿è¥å•†æ•°æ®
                    console.log('âš ï¸ ä½¿ç”¨å¤‡ç”¨æ–¹æ³•ï¼Œæ— æ³•è·å–è¿è¥å•†è¯¦ç»†æ•°æ®');
                }
            }

            // æ£€æŸ¥é¡µé¢æ˜¯å¦æ˜¾ç¤ºå®Œæˆ
            const pageText = document.body.textContent.toLowerCase();
            if (pageText.includes('æµ‹è¯•å®Œæˆ') || pageText.includes('æ£€æµ‹å®Œæˆ') || pageText.includes('å·²å®Œæˆ')) {
                completed = true;
            }

        } catch (error) {
            console.log('æå–ç»“æœå¤±è´¥:', error);
        }

        console.log(`ğŸ“Š æå–ç»“æœ: æ€»æ•°=${totalTests}, æˆåŠŸ=${success200Tests}, ç‡=${connectivityRate}%, å®Œæˆ=${completed}`);

        // è®¡ç®—è¿è¥å•†æ‘˜è¦
        const operatorSummary = calculateOperatorSummary(operatorStats);

        return {
            totalTests: totalTests,
            success200Tests: success200Tests,
            connectivityRate: connectivityRate,
            isCompleted: completed || (totalTests >= CONFIG.minTotalTests && connectivityRate > 0),
            isLowRate: connectivityRate < CONFIG.minSuccessRate && connectivityRate > 0,
            hasResults: hasResults,
            // æ–°å¢ï¼šè¿è¥å•†æ•°æ®
            operatorStats: operatorStats,
            operatorSummary: operatorSummary
        };
    }

    // ==================== è®¡ç®—è¿è¥å•†æ‘˜è¦ ====================
    function calculateOperatorSummary(operatorStats) {
        const summary = {
            mobileErrors: operatorStats.mobile.total - operatorStats.mobile.success,
            unicomErrors: operatorStats.unicom.total - operatorStats.unicom.success,
            telecomErrors: operatorStats.telecom.total - operatorStats.telecom.success,
            otherErrors: operatorStats.other.total - operatorStats.other.success +
                        operatorStats.bgp.total - operatorStats.bgp.success,

            mobileTotal: operatorStats.mobile.total,
            unicomTotal: operatorStats.unicom.total,
            telecomTotal: operatorStats.telecom.total,
            otherTotal: operatorStats.other.total + operatorStats.bgp.total,

            mobileSuccess: operatorStats.mobile.success,
            unicomSuccess: operatorStats.unicom.success,
            telecomSuccess: operatorStats.telecom.success,

            mobileRate: operatorStats.mobile.total > 0 ?
                Math.round((operatorStats.mobile.success / operatorStats.mobile.total) * 100) : 0,
            unicomRate: operatorStats.unicom.total > 0 ?
                Math.round((operatorStats.unicom.success / operatorStats.unicom.total) * 100) : 0,
            telecomRate: operatorStats.telecom.total > 0 ?
                Math.round((operatorStats.telecom.success / operatorStats.telecom.total) * 100) : 0,
            otherRate: operatorStats.other.total + operatorStats.bgp.total > 0 ?
                Math.round(((operatorStats.other.success + operatorStats.bgp.success) /
                          (operatorStats.other.total + operatorStats.bgp.total)) * 100) : 0
        };

        console.log('ğŸ“Š è¿è¥å•†æ‘˜è¦:', summary);
        return summary;
    }

    // ==================== å‘é€ç»“æœï¼ˆåŒ…å«è¿è¥å•†æ•°æ®ï¼‰ ====================
    function sendResults(domain, results) {
        try {
            if (window.opener && !window.opener.closed) {
                const data = {
                    type: 'ITDOG_TEST_RESULT',
                    domain: domain || 'æœªçŸ¥åŸŸå',
                    connectivityRate: results.connectivityRate || 0,
                    totalTests: results.totalTests || 0,
                    success200Tests: results.success200Tests || 0,
                    isLowRate: results.isLowRate || false,
                    isCompleted: results.isCompleted || false,
                    timestamp: new Date().toISOString(),
                    source: 'ITDOG_MONITOR_V8.1',
                    version: '8.1',
                    // æ–°å¢ï¼šè¿è¥å•†æ•°æ®
                    operatorStats: results.operatorStats || {},
                    operatorSummary: results.operatorSummary || {},
                    // é”™è¯¯çŠ¶æ€ç ï¼ˆå¦‚æœæœ‰ï¼‰
                    otherStatusCodes: extractStatusCodes(results.operatorStats || {})
                };

                console.log('ğŸ“¤ å‘é€ç»“æœåˆ°çˆ¶é¡µé¢ï¼ˆåŒ…å«è¿è¥å•†æ•°æ®ï¼‰:', data);

                window.opener.postMessage(data, '*');

                // å‘é€ä¸¤æ¬¡ç¡®ä¿æ”¶åˆ°
                setTimeout(() => {
                    window.opener.postMessage(data, '*');
                }, 500);

                return true;
            }

            return false;

        } catch (error) {
            console.log('å‘é€ç»“æœå¤±è´¥:', error);
            return false;
        }
    }

    // ==================== æå–çŠ¶æ€ç  ====================
    function extractStatusCodes(operatorStats) {
        const statusCodes = [];

        for (const operatorKey in operatorStats) {
            const operator = operatorStats[operatorKey];
            if (operator.errors && Array.isArray(operator.errors)) {
                operator.errors.forEach(error => {
                    if (error.statusCode && error.statusCode !== 'unknown') {
                        statusCodes.push(error.statusCode);
                    }
                });
            }
        }

        return statusCodes;
    }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-broadcast-tower"></i> å¤šç¾¤ç½‘ç«™ç›‘æ§ç³»ç»Ÿ v10.0</h1>
            <p class="subtitle">æ”¯æŒå¤šç¾¤ç›‘æ§ | ä¸€é”®æˆªå›¾å‘é€ | è¿è¥å•†èŠ‚ç‚¹åˆ†æ | å³æ—¶é€šçŸ¥</p>
        </header>
        
        <div class="main-layout">
            <div class="main-content">
                <!-- è¯´æ˜åŒºåŸŸ -->
                <div class="config-section">
                    <h3><i class="fas fa-info-circle"></i> ä½¿ç”¨è¯´æ˜</h3>
                    <p>1. åœ¨å³ä¾§æ·»åŠ ç¾¤ç»„é…ç½®ï¼ˆæ¯ä¸ªç¾¤ç‹¬ç«‹çš„Botå’Œæµ‹è¯•é“¾æ¥ï¼‰</p>
                    <p>2. ç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ªé“¾æ¥æ‰“å¼€ITDOGé¡µé¢æµ‹è¯•</p>
                    <p>3. <strong>æµ‹è¯•å®Œæˆç«‹å³å‘é€æˆªå›¾å’Œç»“æœ</strong>åˆ°å¯¹åº”ç¾¤ç»„ï¼ˆä¸åªæ˜¯å¼‚å¸¸ï¼‰</p>
                    <p>4. å¼‚å¸¸æ—¶ä¼š@ç¾¤ç»„ä¸­æŒ‡å®šçš„ç”¨æˆ·ï¼ˆå¤šä¸ªç”¨æˆ·ç”¨é€—å·åˆ†éš”ï¼‰</p>
                    <p>5. æ”¯æŒè¿è¥å•†èŠ‚ç‚¹åˆ†æï¼ŒåŒºåˆ†ç§»åŠ¨/è”é€š/ç”µä¿¡å¼‚å¸¸</p>
                    <p>6. <strong style="color: #e74c3c;">è¯·å…ˆå®‰è£…Tampermonkeyè„šæœ¬ï¼ˆä¸‹æ–¹æŒ‰é’®è·å–ï¼‰</strong></p>
                </div>
                
                <!-- è„šæœ¬å®‰è£… -->
                <div class="config-section">
                    <h3><i class="fas fa-code"></i> Tampermonkeyè„šæœ¬å®‰è£…</h3>
                    <div class="buttons">
                        <button class="btn btn-info" id="install-script-btn">
                            <i class="fas fa-download"></i> è·å–ç›‘æ§è„šæœ¬
                        </button>
                        <button class="btn btn-warning" id="test-script-btn">
                            <i class="fas fa-vial"></i> æµ‹è¯•è„šæœ¬è¿æ¥
                        </button>
                    </div>
                    <div id="script-status" style="margin-top: 10px; display: none;"></div>
                </div>
                
                <!-- ç›‘æ§çŠ¶æ€ -->
                <div class="monitor-status" id="monitor-status">
                    <div class="status-card">
                        <div class="status-title">æ´»è·ƒç¾¤ç»„</div>
                        <div class="status-number" id="active-groups-count">0</div>
                    </div>
                    <div class="status-card warning">
                        <div class="status-title">ä»Šæ—¥æµ‹è¯•</div>
                        <div class="status-number" id="today-tests">0</div>
                    </div>
                    <div class="status-card telegram">
                        <div class="status-title">å‘é€é€šçŸ¥</div>
                        <div class="status-number" id="sent-notifications">0</div>
                    </div>
                    <div class="status-card">
                        <div class="status-title">æ€»é“¾æ¥æ•°</div>
                        <div class="status-number" id="total-domains">0</div>
                    </div>
                </div>
                
                <!-- æ‰¹é‡æµ‹è¯• -->
                <div class="config-section">
                    <h3><i class="fas fa-globe"></i> æ‰¹é‡æµ‹è¯•æ§åˆ¶</h3>
                    
                    <div class="buttons">
                        <button class="btn btn-success" id="start-all-btn">
                            <i class="fas fa-play"></i> å¯åŠ¨æ‰€æœ‰ç¾¤ç»„
                        </button>
                        <button class="btn btn-warning" id="start-selected-btn">
                            <i class="fas fa-bolt"></i> å¯åŠ¨é€‰ä¸­ç¾¤ç»„
                        </button>
                        <button class="btn btn-danger" id="stop-all-btn">
                            <i class="fas fa-stop"></i> åœæ­¢æ‰€æœ‰æµ‹è¯•
                        </button>
                        <button class="btn btn-info" id="test-now-btn">
                            <i class="fas fa-rocket"></i> ç«‹å³æµ‹è¯•ä¸€æ¬¡
                        </button>
                    </div>
                    
                    <!-- æµ‹è¯•è¿›åº¦ -->
                    <div class="test-controls" id="test-controls">
                        <div class="test-stats">
                            <div class="stat-item">
                                <div class="stat-label">è¿›è¡Œä¸­</div>
                                <div class="stat-value" id="active-tests">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">å·²æµ‹è¯•</div>
                                <div class="stat-value" id="tested-count">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">æˆåŠŸ</div>
                                <div class="stat-value" id="success-count">0</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">å¼‚å¸¸</div>
                                <div class="stat-value" id="error-count">0</div>
                            </div>
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-info">
                                <span>æµ‹è¯•è¿›åº¦</span>
                                <span id="progress-text">0/0</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-bar"></div>
                            </div>
                        </div>
                        
                        <div class="buttons">
                            <button class="btn btn-warning" id="pause-btn">
                                <i class="fas fa-pause"></i> æš‚åœ
                            </button>
                            <button class="btn btn-danger" id="stop-btn">
                                <i class="fas fa-stop"></i> åœæ­¢
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- ç›‘æ§æ—¥å¿— -->
                <div class="config-section">
                    <h3><i class="fas fa-clipboard-list"></i> ç›‘æ§æ—¥å¿—</h3>
                    <div class="monitor-log" id="monitor-log">
                        <div class="log-entry">
                            <span class="log-time">å°±ç»ª</span>
                            <span class="log-content">ğŸ‰ å¤šç¾¤ç›‘æ§ç³»ç»Ÿ v10.0 å·²å¯åŠ¨ - æ”¯æŒæˆªå›¾å’Œç»“æœå‘é€</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç¾¤ç»„é…ç½® -->
            <div class="group-config">
                <h3><i class="fab fa-telegram"></i> ç¾¤ç»„é…ç½®ç®¡ç†</h3>
                
                <div class="form-group">
                    <label for="group-name">ç¾¤ç»„åç§°</label>
                    <input type="text" id="group-name" placeholder="ä¾‹å¦‚ï¼šä¸»ç›‘æ§ç¾¤">
                </div>
                
                <div class="form-group">
                    <label for="bot-token">Bot Token</label>
                    <input type="text" id="bot-token" placeholder="è¾“å…¥Telegram Bot Token">
                </div>
                
                <div class="form-group">
                    <label for="chat-id">Chat ID</label>
                    <input type="text" id="chat-id" placeholder="è¾“å…¥ç¾¤ç»„Chat ID">
                </div>
                
                <div class="form-group">
                    <label for="mention-users">å¼‚å¸¸æ—¶@çš„ç”¨æˆ·ID</label>
                    <input type="text" id="mention-users" placeholder="ä¾‹å¦‚ï¼š123456,789012ï¼ˆé€—å·åˆ†éš”ï¼‰">
                </div>
                
                <div class="form-group">
                    <label for="connectivity-threshold">è¿é€šç‡é˜ˆå€¼ (%)</label>
                    <input type="number" id="connectivity-threshold" min="1" max="100" value="90" placeholder="ä½äºæ­¤å€¼å‘é€å¼‚å¸¸é€šçŸ¥">
                </div>
                
                <div class="form-group">
                    <label for="group-domains">æµ‹è¯•é“¾æ¥ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
                    <textarea id="group-domains" placeholder="https://example.com&#10;http://test.com/path&#10;www.domain.com"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="test-interval">æµ‹è¯•é—´éš”ï¼ˆåˆ†é’Ÿï¼‰</label>
                    <input type="number" id="test-interval" min="1" value="60">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="send-screenshot" checked> 
                        å‘é€æµ‹è¯•ç»“æœæˆªå›¾
                    </label>
                </div>
                
                <div class="buttons">
                    <button class="btn btn-telegram" id="save-group-btn">
                        <i class="fas fa-save"></i> ä¿å­˜ç¾¤ç»„
                    </button>
                    <button class="btn btn-secondary" id="clear-form-btn">
                        <i class="fas fa-times"></i> æ¸…ç©º
                    </button>
                    <button class="btn btn-danger" id="delete-group-btn" style="display: none;">
                        <i class="fas fa-trash"></i> åˆ é™¤ç¾¤ç»„
                    </button>
                </div>
                
                <div id="config-status" class="status-message"></div>
                
                <!-- ç¾¤ç»„åˆ—è¡¨ -->
                <div class="group-list" id="group-list">
                    <!-- ç¾¤ç»„é¡¹ç›®ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                </div>
            </div>
        </div>
        
        <footer>
            <p>å¤šç¾¤ç½‘ç«™ç›‘æ§ç³»ç»Ÿ v10.0 | ä¸Tampermonkeyè„šæœ¬é…åˆä½¿ç”¨ | æˆªå›¾å‘é€ç‰ˆ</p>
            <p>è¯·ç¡®ä¿å·²å®‰è£… Tampermonkey æ‰©å±•å¹¶åŠ è½½ç›‘æ§è„šæœ¬</p>
        </footer>
    </div>

<script>
// ============================================
// å¤šç¾¤ç½‘ç«™ç›‘æ§ç³»ç»Ÿ v10.0 - å®Œæ•´ç‰ˆ
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    // å…ƒç´ å¼•ç”¨
    const elements = {
        // ç¾¤ç»„é…ç½®å…ƒç´ 
        groupName: document.getElementById('group-name'),
        botToken: document.getElementById('bot-token'),
        chatId: document.getElementById('chat-id'),
        mentionUsers: document.getElementById('mention-users'),
        connectivityThreshold: document.getElementById('connectivity-threshold'),
        groupDomains: document.getElementById('group-domains'),
        testInterval: document.getElementById('test-interval'),
        sendScreenshot: document.getElementById('send-screenshot'),
        saveGroupBtn: document.getElementById('save-group-btn'),
        clearFormBtn: document.getElementById('clear-form-btn'),
        deleteGroupBtn: document.getElementById('delete-group-btn'),
        groupList: document.getElementById('group-list'),
        configStatus: document.getElementById('config-status'),
        
        // è„šæœ¬æ§åˆ¶å…ƒç´ 
        installScriptBtn: document.getElementById('install-script-btn'),
        testScriptBtn: document.getElementById('test-script-btn'),
        scriptStatus: document.getElementById('script-status'),
        
        // æµ‹è¯•æ§åˆ¶å…ƒç´ 
        startAllBtn: document.getElementById('start-all-btn'),
        startSelectedBtn: document.getElementById('start-selected-btn'),
        stopAllBtn: document.getElementById('stop-all-btn'),
        testNowBtn: document.getElementById('test-now-btn'),
        testControls: document.getElementById('test-controls'),
        pauseBtn: document.getElementById('pause-btn'),
        stopBtn: document.getElementById('stop-btn'),
        activeTests: document.getElementById('active-tests'),
        testedCount: document.getElementById('tested-count'),
        successCount: document.getElementById('success-count'),
        errorCount: document.getElementById('error-count'),
        progressText: document.getElementById('progress-text'),
        progressBar: document.getElementById('progress-bar'),
        
        // çŠ¶æ€æ˜¾ç¤ºå…ƒç´ 
        activeGroupsCount: document.getElementById('active-groups-count'),
        todayTests: document.getElementById('today-tests'),
        sentNotifications: document.getElementById('sent-notifications'),
        totalDomains: document.getElementById('total-domains'),
        
        // ç›‘æ§æ—¥å¿—å…ƒç´ 
        monitorLog: document.getElementById('monitor-log')
    };

    // çŠ¶æ€å˜é‡
    let groups = {};
    let activeTestGroups = new Map(); // groupId -> test state
    let selectedGroupId = null;
    let isTesting = false;
    let isPaused = false;
    let stats = {
        todayTests: 0,
        sentNotifications: 0,
        totalDomains: 0,
        lastReset: new Date().toDateString()
    };

    // åˆå§‹åŒ–
    function init() {
        loadGroups();
        loadStats();
        setupEventListeners();
        updateGroupList();
        updateStatsDisplay();
        
        // ç›‘å¬æ¥è‡ªITDOGé¡µé¢çš„æ¶ˆæ¯
        window.addEventListener('message', handleITDOGMessage);
        
        addLog('ğŸ‰ å¤šç¾¤ç›‘æ§ç³»ç»Ÿ v10.0 å·²å¯åŠ¨', 'success');
        addLog('ğŸ“¸ æµ‹è¯•å®Œæˆåä¼šè‡ªåŠ¨æˆªå›¾å¹¶å‘é€åˆ°Telegramç¾¤ç»„', 'info');
        addLog('ğŸ‘¥ æ”¯æŒå¤šç¾¤ç‹¬ç«‹é…ç½®å’Œç›‘æ§', 'info');
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®æ¯æ—¥ç»Ÿè®¡
        checkDailyReset();
        
        // æ£€æŸ¥è„šæœ¬æ˜¯å¦å·²å®‰è£…
        setTimeout(checkTampermonkey, 2000);
    }

    // æ£€æŸ¥Tampermonkeyè„šæœ¬
    function checkTampermonkey() {
        // å‘é€æµ‹è¯•æ¶ˆæ¯æ£€æŸ¥è„šæœ¬æ˜¯å¦è¿è¡Œ
        window.postMessage({ 
            type: 'PING_ITDOG_MONITOR',
            source: 'MAIN_CONTROL',
            timestamp: Date.now()
        }, '*');
        
        setTimeout(() => {
            if (!window.itdogMonitorDetected) {
                showScriptStatus('âš ï¸ Tampermonkeyè„šæœ¬æœªæ£€æµ‹åˆ°ï¼Œè¯·å®‰è£…è„šæœ¬', 'warning');
            } else {
                showScriptStatus('âœ… Tampermonkeyè„šæœ¬å·²æ£€æµ‹åˆ°', 'success');
            }
        }, 1000);
    }

    // æ˜¾ç¤ºè„šæœ¬çŠ¶æ€
    function showScriptStatus(message, type) {
        elements.scriptStatus.textContent = message;
        elements.scriptStatus.style.display = 'block';
        elements.scriptStatus.style.padding = '10px';
        elements.scriptStatus.style.borderRadius = '8px';
        elements.scriptStatus.style.marginTop = '10px';
        elements.scriptStatus.style.fontSize = '14px';
        
        if (type === 'success') {
            elements.scriptStatus.style.background = 'rgba(46, 204, 113, 0.1)';
            elements.scriptStatus.style.color = '#155724';
            elements.scriptStatus.style.borderLeft = '4px solid #2ecc71';
        } else if (type === 'warning') {
            elements.scriptStatus.style.background = 'rgba(243, 156, 18, 0.1)';
            elements.scriptStatus.style.color = '#856404';
            elements.scriptStatus.style.borderLeft = '4px solid #f39c12';
        } else if (type === 'error') {
            elements.scriptStatus.style.background = 'rgba(231, 76, 60, 0.1)';
            elements.scriptStatus.style.color = '#721c24';
            elements.scriptStatus.style.borderLeft = '4px solid #e74c3c';
        }
    }

    // åŠ è½½ç¾¤ç»„é…ç½®
    function loadGroups() {
        try {
            const savedGroups = localStorage.getItem('monitor_groups_v10');
            if (savedGroups) {
                groups = JSON.parse(savedGroups);
                updateTotalDomains();
            }
        } catch (error) {
            console.error('åŠ è½½ç¾¤ç»„é…ç½®å¤±è´¥:', error);
            addLog('âŒ åŠ è½½ç¾¤ç»„é…ç½®å¤±è´¥', 'error');
        }
    }

    // ä¿å­˜ç¾¤ç»„é…ç½®
    function saveGroups() {
        try {
            localStorage.setItem('monitor_groups_v10', JSON.stringify(groups));
            updateTotalDomains();
            return true;
        } catch (error) {
            console.error('ä¿å­˜ç¾¤ç»„é…ç½®å¤±è´¥:', error);
            addLog('âŒ ä¿å­˜ç¾¤ç»„é…ç½®å¤±è´¥', 'error');
            return false;
        }
    }

    // åŠ è½½ç»Ÿè®¡æ•°æ®
    function loadStats() {
        try {
            const savedStats = localStorage.getItem('monitor_stats_v10');
            if (savedStats) {
                const loadedStats = JSON.parse(savedStats);
                if (loadedStats.lastReset === new Date().toDateString()) {
                    stats = loadedStats;
                } else {
                    resetDailyStats();
                }
            }
        } catch (error) {
            console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        }
    }

    // ä¿å­˜ç»Ÿè®¡æ•°æ®
    function saveStats() {
        try {
            localStorage.setItem('monitor_stats_v10', JSON.stringify(stats));
        } catch (error) {
            console.error('ä¿å­˜ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        }
    }

    // æ›´æ–°æ€»åŸŸåæ•°
    function updateTotalDomains() {
        stats.totalDomains = 0;
        Object.values(groups).forEach(group => {
            stats.totalDomains += group.domains.length;
        });
        updateStatsDisplay();
        saveStats();
    }

    // æ£€æŸ¥æ¯æ—¥é‡ç½®
    function checkDailyReset() {
        if (stats.lastReset !== new Date().toDateString()) {
            resetDailyStats();
            addLog('ğŸ“… æ–°çš„ä¸€å¤©ï¼Œç»Ÿè®¡å·²é‡ç½®', 'info');
        }
    }

    // é‡ç½®æ¯æ—¥ç»Ÿè®¡
    function resetDailyStats() {
        stats.todayTests = 0;
        stats.sentNotifications = 0;
        stats.lastReset = new Date().toDateString();
        saveStats();
        updateStatsDisplay();
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
        // ä¿å­˜ç¾¤ç»„
        elements.saveGroupBtn.addEventListener('click', saveGroup);
        elements.clearFormBtn.addEventListener('click', clearForm);
        elements.deleteGroupBtn.addEventListener('click', deleteGroup);
        
        // è„šæœ¬æ§åˆ¶
        elements.installScriptBtn.addEventListener('click', showScriptCode);
        elements.testScriptBtn.addEventListener('click', testScriptConnection);
        
        // æµ‹è¯•æ§åˆ¶
        elements.startAllBtn.addEventListener('click', startAllGroups);
        elements.startSelectedBtn.addEventListener('click', startSelectedGroup);
        elements.stopAllBtn.addEventListener('click', stopAllGroups);
        elements.testNowBtn.addEventListener('click', testSelectedGroupOnce);
        elements.pauseBtn.addEventListener('click', togglePause);
        elements.stopBtn.addEventListener('click', stopAllTests);
    }

    // ä¿å­˜ç¾¤ç»„
    function saveGroup() {
        const groupName = elements.groupName.value.trim();
        const botToken = elements.botToken.value.trim();
        const chatId = elements.chatId.value.trim();
        const mentionUsers = elements.mentionUsers.value.trim();
        const threshold = parseInt(elements.connectivityThreshold.value) || 90;
        const domains = elements.groupDomains.value.trim();
        const interval = parseInt(elements.testInterval.value) || 60;
        const sendScreenshot = elements.sendScreenshot.checked;
        
        // éªŒè¯
        if (!groupName || !botToken || !chatId || !domains) {
            showStatus('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
            return;
        }
        
        if (!botToken.match(/^\d+:[A-Za-z0-9_-]+$/)) {
            showStatus('Bot Tokenæ ¼å¼ä¸æ­£ç¡®', 'error');
            return;
        }
        
        const domainList = domains.split('\n')
            .map(d => d.trim())
            .filter(d => d.length > 0);
        
        if (domainList.length === 0) {
            showStatus('è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªæµ‹è¯•é“¾æ¥', 'error');
            return;
        }
        
        // å¤„ç†ç”¨æˆ·IDï¼ˆè½¬æ¢ä¸ºæ•°å­—æ•°ç»„ï¼‰
        const mentionUserIds = mentionUsers.split(',')
            .map(u => u.trim())
            .filter(u => u.match(/^\d+$/))
            .map(u => parseInt(u));
        
        const groupId = selectedGroupId || Date.now().toString();
        
        // ä¿å­˜ç¾¤ç»„
        groups[groupId] = {
            id: groupId,
            name: groupName,
            botToken: botToken,
            chatId: chatId,
            mentionUsers: mentionUserIds,
            threshold: threshold,
            domains: domainList,
            interval: interval,
            sendScreenshot: sendScreenshot,
            enabled: true,
            lastTested: null,
            lastResult: null,
            createdAt: new Date().toISOString()
        };
        
        if (saveGroups()) {
            showStatus(`ç¾¤ç»„ "${groupName}" å·²ä¿å­˜`, 'success');
            addLog(`âœ… ç¾¤ç»„å·²ä¿å­˜: ${groupName} (${domainList.length}ä¸ªé“¾æ¥)`, 'success');
            
            // æ›´æ–°æ˜¾ç¤º
            updateGroupList();
            clearForm();
        }
    }

    // æ¸…é™¤è¡¨å•
    function clearForm() {
        elements.groupName.value = '';
        elements.botToken.value = '';
        elements.chatId.value = '';
        elements.mentionUsers.value = '';
        elements.connectivityThreshold.value = '90';
        elements.groupDomains.value = '';
        elements.testInterval.value = '60';
        elements.sendScreenshot.checked = true;
        selectedGroupId = null;
        elements.deleteGroupBtn.style.display = 'none';
        elements.saveGroupBtn.innerHTML = '<i class="fas fa-save"></i> ä¿å­˜ç¾¤ç»„';
        
        // æ¸…é™¤é€‰ä¸­çŠ¶æ€
        document.querySelectorAll('.group-item.active').forEach(item => {
            item.classList.remove('active');
        });
    }

    // åˆ é™¤ç¾¤ç»„
    function deleteGroup() {
        if (!selectedGroupId) return;
        
        const group = groups[selectedGroupId];
        if (!group) return;
        
        if (confirm(`ç¡®å®šè¦åˆ é™¤ç¾¤ç»„ "${group.name}" å—ï¼Ÿ`)) {
            // å¦‚æœæ­£åœ¨æµ‹è¯•ï¼Œå…ˆåœæ­¢
            if (activeTestGroups.has(selectedGroupId)) {
                stopGroupTest(selectedGroupId);
            }
            
            // åˆ é™¤ç¾¤ç»„
            delete groups[selectedGroupId];
            saveGroups();
            
            showStatus(`ç¾¤ç»„ "${group.name}" å·²åˆ é™¤`, 'success');
            addLog(`ğŸ—‘ï¸ å·²åˆ é™¤ç¾¤ç»„: ${group.name}`, 'warning');
            
            // æ›´æ–°æ˜¾ç¤º
            updateGroupList();
            clearForm();
        }
    }

    // æ›´æ–°ç¾¤ç»„åˆ—è¡¨æ˜¾ç¤º
    function updateGroupList() {
        elements.groupList.innerHTML = '';
        
        Object.values(groups).forEach(group => {
            const item = document.createElement('div');
            item.className = 'group-item';
            if (selectedGroupId === group.id) {
                item.classList.add('active');
            }
            item.dataset.groupId = group.id;
            
            const isActive = activeTestGroups.has(group.id);
            const activeStatus = isActive ? 'ğŸŸ¢ è¿è¡Œä¸­' : 'âšª æœªè¿è¡Œ';
            const screenshotStatus = group.sendScreenshot ? 'ğŸ“¸ æˆªå›¾' : 'ğŸ“ æ–‡æœ¬';
            
            item.innerHTML = `
                <div class="group-header">
                    <span class="group-name">${group.name}</span>
                    <div class="group-buttons">
                        <button class="group-btn edit" title="ç¼–è¾‘">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="group-btn delete" title="åˆ é™¤">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="group-btn ${group.enabled ? 'disable' : 'enable'}" title="${group.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}">
                            <i class="fas fa-${group.enabled ? 'pause' : 'play'}"></i>
                        </button>
                    </div>
                </div>
                <div class="group-details">
                    <div><i class="fas fa-hashtag"></i> é“¾æ¥: ${group.domains.length}ä¸ª</div>
                    <div><i class="fas fa-clock"></i> é—´éš”: ${group.interval}åˆ†é’Ÿ</div>
                    <div><i class="fas fa-bell"></i> é˜ˆå€¼: ${group.threshold}%</div>
                    <div><i class="fas fa-users"></i> é€šçŸ¥: ${group.mentionUsers.length}äºº</div>
                    <div><i class="fas fa-camera"></i> å‘é€: ${screenshotStatus}</div>
                    <div><i class="fas fa-power-off"></i> çŠ¶æ€: ${activeStatus}</div>
                    ${group.lastTested ? `<div><i class="fas fa-history"></i> æœ€å: ${new Date(group.lastTested).toLocaleTimeString()}</div>` : ''}
                </div>
            `;
            
            elements.groupList.appendChild(item);
            
            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆé€‰ä¸­ç¾¤ç»„ï¼‰
            item.addEventListener('click', (e) => {
                if (!e.target.classList.contains('group-btn')) {
                    selectGroup(group.id);
                }
            });
            
            // æ·»åŠ æŒ‰é’®äº‹ä»¶
            const editBtn = item.querySelector('.edit');
            const deleteBtn = item.querySelector('.delete');
            const toggleBtn = item.querySelector('.group-btn:not(.edit):not(.delete)');
            
            if (editBtn) editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                editGroup(group.id);
            });
            
            if (deleteBtn) deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (confirm(`åˆ é™¤ç¾¤ç»„ "${group.name}"ï¼Ÿ`)) {
                    deleteGroupById(group.id);
                }
            });
            
            if (toggleBtn) toggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleGroupEnabled(group.id);
            });
        });
    }

    // é€‰ä¸­ç¾¤ç»„
    function selectGroup(groupId) {
        selectedGroupId = groupId;
        
        // æ›´æ–°UI
        document.querySelectorAll('.group-item').forEach(item => {
            item.classList.remove('active');
        });
        const selectedItem = document.querySelector(`.group-item[data-group-id="${groupId}"]`);
        if (selectedItem) {
            selectedItem.classList.add('active');
        }
        
        // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
        elements.deleteGroupBtn.style.display = 'block';
        
        addLog(`ğŸ“Œ é€‰ä¸­ç¾¤ç»„: ${groups[groupId]?.name || 'æœªçŸ¥'}`, 'info');
    }

    // ç¼–è¾‘ç¾¤ç»„
    function editGroup(groupId) {
        const group = groups[groupId];
        if (!group) return;
        
        selectedGroupId = groupId;
        
        // å¡«å……è¡¨å•
        elements.groupName.value = group.name;
        elements.botToken.value = group.botToken;
        elements.chatId.value = group.chatId;
        elements.mentionUsers.value = group.mentionUsers.join(', ');
        elements.connectivityThreshold.value = group.threshold;
        elements.groupDomains.value = group.domains.join('\n');
        elements.testInterval.value = group.interval;
        elements.sendScreenshot.checked = group.sendScreenshot;
        
        // æ›´æ–°æŒ‰é’®
        elements.deleteGroupBtn.style.display = 'block';
        elements.saveGroupBtn.innerHTML = '<i class="fas fa-sync-alt"></i> æ›´æ–°ç¾¤ç»„';
        
        addLog(`âœï¸ æ­£åœ¨ç¼–è¾‘ç¾¤ç»„: ${group.name}`, 'info');
    }

    // åˆ é™¤ç¾¤ç»„ï¼ˆé€šè¿‡IDï¼‰
    function deleteGroupById(groupId) {
        const group = groups[groupId];
        if (!group) return;
        
        // å¦‚æœæ­£åœ¨æµ‹è¯•ï¼Œå…ˆåœæ­¢
        if (activeTestGroups.has(groupId)) {
            stopGroupTest(groupId);
        }
        
        // åˆ é™¤ç¾¤ç»„
        delete groups[groupId];
        saveGroups();
        
        showStatus(`ç¾¤ç»„ "${group.name}" å·²åˆ é™¤`, 'success');
        addLog(`ğŸ—‘ï¸ å·²åˆ é™¤ç¾¤ç»„: ${group.name}`, 'warning');
        
        // å¦‚æœåˆ é™¤çš„æ˜¯é€‰ä¸­çš„ç¾¤ç»„ï¼Œæ¸…ç©ºè¡¨å•
        if (selectedGroupId === groupId) {
            clearForm();
        }
        
        // æ›´æ–°æ˜¾ç¤º
        updateGroupList();
    }

    // å¯ç”¨/ç¦ç”¨ç¾¤ç»„
    function toggleGroupEnabled(groupId) {
        const group = groups[groupId];
        if (!group) return;
        
        group.enabled = !group.enabled;
        saveGroups();
        updateGroupList();
        
        const action = group.enabled ? 'å¯ç”¨' : 'ç¦ç”¨';
        addLog(`âš™ï¸ å·²${action}ç¾¤ç»„: ${group.name}`, 'info');
        
        // å¦‚æœç¦ç”¨æ—¶æ­£åœ¨æµ‹è¯•ï¼Œåœæ­¢æµ‹è¯•
        if (!group.enabled && activeTestGroups.has(groupId)) {
            stopGroupTest(groupId);
        }
    }

    // å¯åŠ¨æ‰€æœ‰ç¾¤ç»„
    function startAllGroups() {
        const enabledGroups = Object.values(groups).filter(g => g.enabled);
        
        if (enabledGroups.length === 0) {
            showStatus('æ²¡æœ‰å¯ç”¨çš„ç¾¤ç»„', 'error');
            return;
        }
        
        let startedCount = 0;
        enabledGroups.forEach(group => {
            if (!activeTestGroups.has(group.id)) {
                if (startGroupTest(group.id)) {
                    startedCount++;
                }
            }
        });
        
        if (startedCount > 0) {
            showStatus(`å·²å¯åŠ¨ ${startedCount} ä¸ªç¾¤ç»„çš„ç›‘æ§`, 'success');
            updateActiveGroupsCount();
        }
    }

    // å¯åŠ¨é€‰ä¸­ç¾¤ç»„
    function startSelectedGroup() {
        if (!selectedGroupId) {
            showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¾¤ç»„', 'error');
            return;
        }
        
        if (!groups[selectedGroupId].enabled) {
            showStatus('è¯¥ç¾¤ç»„å·²è¢«ç¦ç”¨', 'error');
            return;
        }
        
        if (activeTestGroups.has(selectedGroupId)) {
            showStatus('è¯¥ç¾¤ç»„å·²åœ¨è¿è¡Œä¸­', 'info');
            return;
        }
        
        if (startGroupTest(selectedGroupId)) {
            showStatus('ç¾¤ç»„ç›‘æ§å·²å¯åŠ¨', 'success');
            updateActiveGroupsCount();
        }
    }

    // æµ‹è¯•é€‰ä¸­ç¾¤ç»„ä¸€æ¬¡ï¼ˆä¸å¯åŠ¨å®šæ—¶ï¼‰
    function testSelectedGroupOnce() {
        if (!selectedGroupId) {
            showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç¾¤ç»„', 'error');
            return;
        }
        
        const group = groups[selectedGroupId];
        if (!group || !group.enabled) {
            showStatus('ç¾¤ç»„ä¸å¯ç”¨æˆ–å·²è¢«ç¦ç”¨', 'error');
            return;
        }
        
        addLog(`ğŸš€ ç«‹å³æµ‹è¯•ç¾¤ç»„: ${group.name}`, 'info');
        
        // åˆ›å»ºä¸€æ¬¡æ€§æµ‹è¯•çŠ¶æ€
        const testState = {
            groupId: selectedGroupId,
            group: group,
            domains: [...group.domains],
            currentIndex: 0,
            isTesting: true,
            isOneTime: true, // æ ‡è®°ä¸ºä¸€æ¬¡æ€§æµ‹è¯•
            results: {},
            activeTabs: new Map()
        };
        
        activeTestGroups.set(selectedGroupId, testState);
        updateActiveGroupsCount();
        showTestControls();
        
        // å¼€å§‹æµ‹è¯•
        testNextDomain(selectedGroupId);
    }

    // å¯åŠ¨å•ä¸ªç¾¤ç»„æµ‹è¯•
    function startGroupTest(groupId) {
        const group = groups[groupId];
        if (!group || !group.enabled) return false;
        
        addLog(`ğŸš€ å¯åŠ¨ç¾¤ç»„æµ‹è¯•: ${group.name}`, 'info');
        
        // å¦‚æœå·²ç»åœ¨æµ‹è¯•ä¸­ï¼Œå…ˆåœæ­¢
        if (activeTestGroups.has(groupId)) {
            stopGroupTest(groupId);
        }
        
        // åˆ›å»ºæµ‹è¯•çŠ¶æ€
        const testState = {
            groupId: groupId,
            group: group,
            domains: [...group.domains],
            currentIndex: 0,
            isTesting: true,
            isOneTime: false, // å®šæ—¶æµ‹è¯•
            results: {},
            activeTabs: new Map(),
            timer: null,
            interval: group.interval * 60 * 1000 // è½¬æ¢ä¸ºæ¯«ç§’
        };
        
        activeTestGroups.set(groupId, testState);
        updateActiveGroupsCount();
        showTestControls();
        
        // å¼€å§‹ç¬¬ä¸€æ¬¡æµ‹è¯•
        testNextDomain(groupId);
        
        // è®¾ç½®å®šæ—¶å™¨ï¼ˆå¦‚æœä¸æ˜¯ä¸€æ¬¡æ€§æµ‹è¯•ï¼‰
        if (!testState.isOneTime && group.interval > 0) {
            testState.timer = setInterval(() => {
                if (testState.isTesting && !isPaused) {
                    addLog(`ğŸ”„ å®šæ—¶æµ‹è¯•: ${group.name}`, 'info');
                    testState.currentIndex = 0;
                    testState.results = {};
                    testState.activeTabs.clear();
                    testNextDomain(groupId);
                }
            }, testState.interval);
        }
        
        return true;
    }

    // åœæ­¢å•ä¸ªç¾¤ç»„æµ‹è¯•
    function stopGroupTest(groupId) {
        const testState = activeTestGroups.get(groupId);
        if (!testState) return;
        
        testState.isTesting = false;
        
        // æ¸…é™¤å®šæ—¶å™¨
        if (testState.timer) {
            clearInterval(testState.timer);
            testState.timer = null;
        }
        
        // å…³é—­æ‰€æœ‰æ‰“å¼€çš„æ ‡ç­¾é¡µ
        testState.activeTabs.forEach(tab => {
            try {
                if (tab && !tab.closed) {
                    tab.close();
                }
            } catch (e) {
                console.error('å…³é—­æ ‡ç­¾é¡µå¤±è´¥:', e);
            }
        });
        testState.activeTabs.clear();
        
        // ä»æ´»åŠ¨åˆ—è¡¨ç§»é™¤
        activeTestGroups.delete(groupId);
        updateActiveGroupsCount();
        
        const group = groups[groupId];
        if (group) {
            addLog(`â¹ï¸ åœæ­¢ç¾¤ç»„æµ‹è¯•: ${group.name}`, 'warning');
        }
        
        // å¦‚æœæ²¡æœ‰æ´»åŠ¨çš„æµ‹è¯•ï¼Œéšè—æ§åˆ¶é¢æ¿
        if (activeTestGroups.size === 0) {
            hideTestControls();
        }
    }

    // åœæ­¢æ‰€æœ‰ç¾¤ç»„
    function stopAllGroups() {
        if (activeTestGroups.size === 0) {
            showStatus('æ²¡æœ‰æ­£åœ¨è¿è¡Œçš„æµ‹è¯•', 'info');
            return;
        }
        
        activeTestGroups.forEach((testState, groupId) => {
            stopGroupTest(groupId);
        });
        
        showStatus('å·²åœæ­¢æ‰€æœ‰ç¾¤ç»„çš„ç›‘æ§', 'info');
        hideTestControls();
    }

    // æµ‹è¯•ä¸‹ä¸€ä¸ªåŸŸå
    function testNextDomain(groupId) {
        const testState = activeTestGroups.get(groupId);
        if (!testState || !testState.isTesting || testState.currentIndex >= testState.domains.length) {
            // æµ‹è¯•å®Œæˆ
            if (testState) {
                testState.isTesting = false;
                testState.currentIndex = 0; // é‡ç½®ç´¢å¼•
                
                // æ›´æ–°ç¾¤ç»„æœ€åæµ‹è¯•æ—¶é—´
                const group = groups[groupId];
                if (group) {
                    group.lastTested = new Date().toISOString();
                    saveGroups();
                    updateGroupList();
                    
                    // å¦‚æœä¸æ˜¯ä¸€æ¬¡æ€§æµ‹è¯•ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡å®šæ—¶æ‰§è¡Œ
                    if (!testState.isOneTime) {
                        addLog(`âœ… ç¾¤ç»„æµ‹è¯•å®Œæˆ: ${group.name}ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡å®šæ—¶`, 'success');
                    } else {
                        addLog(`âœ… ä¸€æ¬¡æ€§æµ‹è¯•å®Œæˆ: ${group.name}`, 'success');
                        // ä¸€æ¬¡æ€§æµ‹è¯•å®Œæˆï¼Œç§»é™¤
                        setTimeout(() => {
                            activeTestGroups.delete(groupId);
                            updateActiveGroupsCount();
                        }, 1000);
                    }
                }
            }
            return;
        }
        
        const domain = testState.domains[testState.currentIndex];
        const domainIndex = testState.currentIndex;
        
        testState.currentIndex++;
        updateTestProgress();
        
        // æ‰“å¼€ITDOGé¡µé¢è¿›è¡Œæµ‹è¯•
        openITDOGTest(groupId, domain, domainIndex);
        
        // å¦‚æœæ²¡æœ‰æš‚åœï¼Œç»§ç»­æµ‹è¯•ä¸‹ä¸€ä¸ªï¼ˆå»¶è¿Ÿæ‰“å¼€ï¼Œé¿å…åŒæ—¶æ‰“å¼€å¤ªå¤šé¡µé¢ï¼‰
        if (!isPaused) {
            setTimeout(() => {
                if (testState && testState.isTesting) {
                    testNextDomain(groupId);
                }
            }, 3000); // 3ç§’é—´éš”
        }
    }

    // æ‰“å¼€ITDOGæµ‹è¯•é¡µé¢
    function openITDOGTest(groupId, domain, index) {
        try {
            // æ¸…ç†åŸŸåæ ¼å¼
            let cleanDomain = domain.trim();
            if (!cleanDomain.startsWith('http://') && !cleanDomain.startsWith('https://')) {
                cleanDomain = 'http://' + cleanDomain;
            }
            
            const encodedDomain = encodeURIComponent(cleanDomain);
            const url = `https://www.itdog.cn/http/?domain=${encodedDomain}`;
            
            // ç”Ÿæˆå”¯ä¸€çª—å£å
            const windowName = `itdog_${groupId}_${index}_${Date.now()}`;
            
            // æ‰“å¼€æ–°çª—å£
            const win = window.open(url, windowName, 'width=1200,height=800,menubar=no,toolbar=no,location=yes');
            
            if (!win) {
                addLog(`âŒ æ— æ³•æ‰“å¼€æ ‡ç­¾é¡µ: ${cleanDomain} (å¯èƒ½è¢«æµè§ˆå™¨é˜»æ­¢)`, 'error');
                
                // æ ‡è®°æµ‹è¯•å¤±è´¥
                const testState = activeTestGroups.get(groupId);
                if (testState) {
                    testState.results[index] = {
                        status: 'error',
                        domain: cleanDomain,
                        rate: 0
                    };
                    updateTestStats(false);
                }
                return;
            }
            
            // ä¿å­˜çª—å£å¼•ç”¨
            const testState = activeTestGroups.get(groupId);
            if (testState) {
                testState.activeTabs.set(index, win);
                
                // è®¾ç½®è¶…æ—¶æ£€æŸ¥
                setTimeout(() => {
                    try {
                        if (win.closed) {
                            addLog(`â° æ ‡ç­¾é¡µå·²å…³é—­: ${cleanDomain}`, 'info');
                        }
                    } catch (e) {
                        // è·¨åŸŸé”™è¯¯ï¼Œå¿½ç•¥
                    }
                    
                    // æ¸…ç†å¼•ç”¨
                    if (testState.activeTabs) {
                        testState.activeTabs.delete(index);
                    }
                }, 180000); // 3åˆ†é’Ÿè¶…æ—¶
            }
            
            stats.todayTests++;
            updateStatsDisplay();
            saveStats();
            
            addLog(`ğŸŒ æ‰“å¼€æµ‹è¯•: ${cleanDomain}`, 'info');
            
        } catch (error) {
            addLog(`âŒ æ‰“å¼€æµ‹è¯•é¡µé¢å‡ºé”™: ${error.message}`, 'error');
        }
    }

    // å¤„ç†ITDOGæ¶ˆæ¯
    function handleITDOGMessage(event) {
        // å¤„ç†è„šæœ¬æ£€æµ‹æ¶ˆæ¯
        if (event.data && event.data.type === 'PONG_ITDOG_MONITOR') {
            window.itdogMonitorDetected = true;
            return;
        }
        
        // å¤„ç†æµ‹è¯•ç»“æœæ¶ˆæ¯
        if (event.data && event.data.type === 'ITDOG_TEST_RESULT') {
            console.log('ğŸ“© æ”¶åˆ°ITDOGæµ‹è¯•ç»“æœ:', event.data);
            
            const result = event.data;
            const groupId = findGroupIdByDomain(result.domain);
            
            if (groupId) {
                handleTestResult(groupId, result);
            } else {
                // å°è¯•ä»æ‰€æœ‰æ´»åŠ¨æµ‹è¯•ä¸­æŸ¥æ‰¾
                for (const [testGroupId, testState] of activeTestGroups) {
                    if (testState.domains.includes(result.domain)) {
                        handleTestResult(testGroupId, result);
                        break;
                    }
                }
            }
            
            return;
        }
    }

    // æŸ¥æ‰¾åŸŸåå¯¹åº”çš„ç¾¤ç»„
    function findGroupIdByDomain(domain) {
        for (const [groupId, testState] of activeTestGroups) {
            if (testState.domains.includes(domain)) {
                return groupId;
            }
        }
        return null;
    }

    // å¤„ç†æµ‹è¯•ç»“æœ
    function handleTestResult(groupId, result) {
        const testState = activeTestGroups.get(groupId);
        const group = groups[groupId];
        
        if (!testState || !group) return;
        
        // æ›´æ–°ç»Ÿè®¡
        stats.todayTests++;
        updateStatsDisplay();
        saveStats();
        
        // å‘é€ç»“æœåˆ°Telegram
        sendResultToTelegram(group, result);
        
        // æ ‡è®°ä¸ºå®Œæˆ
        const domainIndex = testState.domains.findIndex(d => d === result.domain);
        if (domainIndex !== -1) {
            testState.results[domainIndex] = result;
            updateTestProgress();
            
            // å…³é—­æ ‡ç­¾é¡µ
            const tab = testState.activeTabs.get(domainIndex);
            if (tab && !tab.closed) {
                try {
                    tab.close();
                } catch (e) {
                    // å¿½ç•¥é”™è¯¯
                }
            }
            testState.activeTabs.delete(domainIndex);
            
            // å¦‚æœæ‰€æœ‰åŸŸåéƒ½æµ‹è¯•å®Œæˆï¼Œæ¸…é™¤æµ‹è¯•çŠ¶æ€
            const allTested = testState.domains.every((_, index) => testState.results[index]);
            if (allTested) {
                if (testState.isOneTime) {
                    setTimeout(() => {
                        activeTestGroups.delete(groupId);
                        updateActiveGroupsCount();
                    }, 1000);
                } else {
                    // å®šæ—¶æµ‹è¯•ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡æ‰§è¡Œ
                    testState.isTesting = false;
                    testState.currentIndex = 0;
                    testState.results = {};
                    
                    addLog(`âœ… ç¾¤ç»„ ${group.name} æµ‹è¯•å®Œæˆï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡æ‰§è¡Œ`, 'success');
                }
            }
        }
        
        // æ›´æ–°ç¾¤ç»„æœ€åæµ‹è¯•æ—¶é—´
        group.lastTested = new Date().toISOString();
        group.lastResult = result;
        saveGroups();
        updateGroupList();
    }

    // å‘é€ç»“æœåˆ°Telegram
    async function sendResultToTelegram(group, result) {
        try {
            const now = new Date();
            const currentTime = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            }).replace(/\//g, '-');
            
            const isLowRate = result.isLowRate || false;
            const rate = result.connectivityRate || 0;
            const statusEmoji = isLowRate ? 'âš ï¸' : 'âœ…';
            
            // æ„å»ºæ¶ˆæ¯
            let message = `${statusEmoji} *ç½‘ç«™ç›‘æ§ç»“æœ - ${group.name}*\\n\\n`;
            message += `ğŸŒ *æ£€æµ‹åŸŸå:* \`${result.domain || 'æœªçŸ¥åŸŸå'}\`\\n`;
            message += `ğŸ• *æ£€æµ‹æ—¶é—´:* ${currentTime}\\n`;
            message += `ğŸ“Š *è¿é€šç‡:* ${rate}%\\n`;
            message += `âœ… *æˆåŠŸèŠ‚ç‚¹:* ${result.success200Tests || 0}/${result.totalTests || 0}\\n\\n`;
            
            // è¿è¥å•†åˆ†æ
            if (result.operatorSummary) {
                const summary = result.operatorSummary;
                message += `ğŸ“¡ *è¿è¥å•†åˆ†æ*\\n`;
                
                if (summary.mobileTotal > 0) {
                    message += `â”œ ä¸­å›½ç§»åŠ¨: ${summary.mobileSuccess || 0}/${summary.mobileTotal} (${summary.mobileRate || 0}%)\\n`;
                }
                if (summary.unicomTotal > 0) {
                    message += `â”œ ä¸­å›½è”é€š: ${summary.unicomSuccess || 0}/${summary.unicomTotal} (${summary.unicomRate || 0}%)\\n`;
                }
                if (summary.telecomTotal > 0) {
                    message += `â”œ ä¸­å›½ç”µä¿¡: ${summary.telecomSuccess || 0}/${summary.telecomTotal} (${summary.telecomRate || 0}%)\\n`;
                }
                
                const totalErrors = (summary.mobileErrors || 0) + (summary.unicomErrors || 0) + (summary.telecomErrors || 0) + (summary.otherErrors || 0);
                if (totalErrors > 0) {
                    message += `â”œ å¼‚å¸¸æ€»æ•°: ${totalErrors}ä¸ª\\n`;
                }
                message += '\\n';
            }
            
            // å¼‚å¸¸æ—¶@ç›¸å…³äººå‘˜
            if (isLowRate && group.mentionUsers.length > 0) {
                const mentions = group.mentionUsers.map(userId => `[${userId}](tg://user?id=${userId})`).join(' ');
                message += `ğŸ“¢ *å¼‚å¸¸é€šçŸ¥:* ${mentions}\\n`;
                message += `âš ï¸ *å‘Šè­¦:* è¿é€šç‡ä½äº${group.threshold}%ï¼\\n\\n`;
            }
            
            message += `ğŸ”— *æµ‹è¯•é“¾æ¥:* ${result.pageUrl || \`https://www.itdog.cn/http/?domain=\${encodeURIComponent(result.domain)}\`}\\n`;
            
            // å¦‚æœæœ‰æˆªå›¾ä¸”ç”¨æˆ·é€‰æ‹©å‘é€æˆªå›¾
            if (result.screenshot && group.sendScreenshot) {
                message += `ğŸ“¸ *æˆªå›¾:* å·²åŒ…å«åœ¨ç»“æœä¸­\\n`;
            }
            
            // å‘é€æ¶ˆæ¯
            const response = await sendTelegramMessage(group.botToken, group.chatId, message);
            
            if (response.ok) {
                stats.sentNotifications++;
                updateStatsDisplay();
                saveStats();
                
                const logMsg = isLowRate ? 
                    `âš ï¸ å¼‚å¸¸ç»“æœå·²å‘é€åˆ°ç¾¤ç»„: ${group.name}` : 
                    `âœ… ç»“æœå·²å‘é€åˆ°ç¾¤ç»„: ${group.name}`;
                addLog(logMsg, isLowRate ? 'warning' : 'success');
                
                return true;
            } else {
                throw new Error(response.description || 'å‘é€å¤±è´¥');
            }
            
        } catch (error) {
            addLog(`âŒ å‘é€ç»“æœå¤±è´¥: ${error.message}`, 'error');
            return false;
        }
    }

    // å‘é€Telegramæ¶ˆæ¯
    async function sendTelegramMessage(botToken, chatId, text) {
        try {
            const response = await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: chatId,
                    text: text,
                    parse_mode: 'Markdown',
                    disable_web_page_preview: true
                })
            });
            
            return await response.json();
        } catch (error) {
            console.error('å‘é€Telegramæ¶ˆæ¯å¤±è´¥:', error);
            return { ok: false, description: error.message };
        }
    }

    // æ˜¾ç¤ºæµ‹è¯•æ§åˆ¶é¢æ¿
    function showTestControls() {
        if (!isTesting) {
            isTesting = true;
            elements.testControls.style.display = 'block';
        }
    }

    // éšè—æµ‹è¯•æ§åˆ¶é¢æ¿
    function hideTestControls() {
        if (isTesting && activeTestGroups.size === 0) {
            isTesting = false;
            elements.testControls.style.display = 'none';
        }
    }

    // æ›´æ–°æ´»è·ƒç¾¤ç»„æ•°
    function updateActiveGroupsCount() {
        const activeCount = Array.from(activeTestGroups.values()).filter(t => t.isTesting).length;
        elements.activeGroupsCount.textContent = activeCount;
        elements.activeTests.textContent = activeCount;
    }

    // æ›´æ–°æµ‹è¯•è¿›åº¦
    function updateTestProgress() {
        let totalDomains = 0;
        let testedDomains = 0;
        let successDomains = 0;
        let errorDomains = 0;
        
        activeTestGroups.forEach(testState => {
            if (testState.isTesting) {
                totalDomains += testState.domains.length;
                testedDomains += Object.keys(testState.results).length;
                
                // ç»Ÿè®¡æˆåŠŸå’Œå¤±è´¥
                Object.values(testState.results).forEach(result => {
                    if (result.connectivityRate >= (testState.group.threshold || 90)) {
                        successDomains++;
                    } else {
                        errorDomains++;
                    }
                });
            }
        });
        
        elements.testedCount.textContent = testedDomains;
        elements.successCount.textContent = successDomains;
        elements.errorCount.textContent = errorDomains;
        elements.progressText.textContent = `${testedDomains}/${totalDomains}`;
        elements.progressBar.style.width = totalDomains > 0 ? `${(testedDomains / totalDomains) * 100}%` : '0%';
    }

    // æ›´æ–°æµ‹è¯•ç»Ÿè®¡
    function updateTestStats(isSuccess) {
        updateTestProgress();
    }

    // åˆ‡æ¢æš‚åœçŠ¶æ€
    function togglePause() {
        isPaused = !isPaused;
        
        if (isPaused) {
            elements.pauseBtn.innerHTML = '<i class="fas fa-play"></i> ç»§ç»­';
            addLog('â¸ï¸ æ‰€æœ‰æµ‹è¯•å·²æš‚åœ', 'warning');
        } else {
            elements.pauseBtn.innerHTML = '<i class="fas fa-pause"></i> æš‚åœ';
            addLog('â–¶ï¸ æ‰€æœ‰æµ‹è¯•å·²ç»§ç»­', 'success');
            
            // ç»§ç»­æ‰€æœ‰æµ‹è¯•
            activeTestGroups.forEach((testState, groupId) => {
                if (testState.isTesting) {
                    testNextDomain(groupId);
                }
            });
        }
    }

    // åœæ­¢æ‰€æœ‰æµ‹è¯•
    function stopAllTests() {
        isPaused = false;
        
        activeTestGroups.forEach((testState, groupId) => {
            stopGroupTest(groupId);
        });
        
        hideTestControls();
        addLog('â¹ï¸ æ‰€æœ‰æµ‹è¯•å·²åœæ­¢', 'warning');
    }

    // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
    function updateStatsDisplay() {
        elements.todayTests.textContent = stats.todayTests;
        elements.sentNotifications.textContent = stats.sentNotifications;
        elements.totalDomains.textContent = stats.totalDomains;
        elements.activeGroupsCount.textContent = Array.from(activeTestGroups.values()).filter(t => t.isTesting).length;
    }

    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showStatus(message, type) {
        elements.configStatus.textContent = message;
        elements.configStatus.className = 'status-message';
        
        if (type === 'success') {
            elements.configStatus.classList.add('status-success');
        } else if (type === 'error') {
            elements.configStatus.classList.add('status-error');
        }
        
        elements.configStatus.style.display = 'block';
        
        setTimeout(() => {
            elements.configStatus.style.display = 'none';
        }, 3000);
    }

    // æ·»åŠ æ—¥å¿—
    function addLog(message, type = 'info') {
        const now = new Date();
        const timeString = now.toLocaleTimeString('zh-CN', { hour12: false });
        
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        
        let icon = 'ğŸ“';
        if (type === 'success') icon = 'âœ…';
        if (type === 'error') icon = 'âŒ';
        if (type === 'warning') icon = 'âš ï¸';
        if (type === 'info') icon = 'â„¹ï¸';
        
        logEntry.innerHTML = `
            <span class="log-time">${timeString}</span>
            <span class="log-content">${icon} ${message}</span>
        `;
        
        elements.monitorLog.appendChild(logEntry);
        elements.monitorLog.scrollTop = elements.monitorLog.scrollHeight;
        
        // é™åˆ¶æ—¥å¿—æ•°é‡
        const logEntries = elements.monitorLog.querySelectorAll('.log-entry');
        if (logEntries.length > 200) {
            for (let i = 0; i < logEntries.length - 200; i++) {
                logEntries[i].remove();
            }
        }
    }

    // æ˜¾ç¤ºè„šæœ¬ä»£ç 
    function showScriptCode() {
        const scriptCode = `// ==UserScript==
// @name         ITDOGç½‘ç«™æµ‹é€Ÿç›‘æ§ v10.0 - æˆªå›¾å‘é€ç‰ˆ
// @namespace    http://tampermonkey.net/
// @version      10.0
// @description  è‡ªåŠ¨æå–åŸŸåã€ç‚¹å‡»å¼€å§‹æµ‹è¯•ã€ç›‘æ§è¿é€šç‡ã€æˆªå›¾å¹¶è¿”å›ç»“æœç»™ä¸»é¡µé¢
// @author       å¤šç¾¤ç›‘æ§ç³»ç»Ÿ
// @match        https://www.itdog.cn/*
// @run-at       document-end
// @grant        GM_addStyle
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_xmlhttpRequest
// @require      https://html2canvas.hertzen.com/dist/html2canvas.min.js
// ==/UserScript==

(function() {
    'use strict';

    // é˜²é‡å¤æ‰§è¡Œæ£€æŸ¥
    if (window.itdogMonitorRunningV10) {
        console.log('ğŸš« ITDOGç›‘æ§è„šæœ¬å·²åœ¨è¿è¡Œä¸­');
        return;
    }
    window.itdogMonitorRunningV10 = true;
    window.itdogMonitorDetected = true;

    console.log('ğŸš€ ITDOGç›‘æ§è„šæœ¬å¯åŠ¨ - æˆªå›¾å‘é€ç‰ˆ v10.0');

    // é…ç½®
    const CONFIG = {
        maxChecks: 60,
        checkInterval: 2000,
        minSuccessRate: 90,
        minTotalTests: 8,
        timeout: 180000,
        waitAfterClick: 5000,
        stableThreshold: 3
    };

    // çŠ¶æ€å˜é‡
    let hasProcessed = false;
    let testStarted = false;
    let testReallyStarted = false;
    let monitoringStarted = false;
    let resultsSent = false;
    let monitoringInterval = null;
    let checkCount = 0;
    let clickTime = 0;
    let currentDomain = '';
    let currentStage = 'initial';

    // æ¶ˆæ¯ç›‘å¬
    window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'PING_ITDOG_MONITOR') {
            console.log('ğŸ“© æ”¶åˆ°ä¸»é¡µé¢PINGï¼Œå›å¤PONG');
            event.source.postMessage({
                type: 'PONG_ITDOG_MONITOR',
                source: 'ITDOG_SCRIPT_V10',
                timestamp: Date.now(),
                version: '10.0',
                stage: currentStage
            }, event.origin);
        }
    });

    // è·å–åŸŸå
    function getDomain() {
        try {
            // ä»URLå‚æ•°è·å–
            const urlParams = new URLSearchParams(window.location.search);
            let domain = urlParams.get('domain');
            
            if (domain) {
                domain = decodeURIComponent(domain).trim();
                console.log('âœ… ä»URLè·å–åŸŸå:', domain);
                return domain;
            }

            // ä»è¾“å…¥æ¡†è·å–
            const inputs = document.querySelectorAll('input[type="text"], input[type="url"]');
            for (const input of inputs) {
                if (input && input.value) {
                    let value = input.value.trim();
                    if (value.length > 3) {
                        console.log('âœ… ä»è¾“å…¥æ¡†è·å–åŸŸå:', value);
                        return value;
                    }
                }
            }

            return null;
        } catch (error) {
            console.log('è·å–åŸŸåå¤±è´¥:', error);
            return null;
        }
    }

    // è¿è¥å•†è¯†åˆ«
    function identifyOperator(nodeText) {
        if (!nodeText) return 'other';
        const text = nodeText.toLowerCase();
        
        if (text.includes('ç§»åŠ¨') || text.includes('cmcc') || text.includes('chinamobile')) {
            return 'mobile';
        } else if (text.includes('è”é€š') || text.includes('unicom') || text.includes('chinaunicom')) {
            return 'unicom';
        } else if (text.includes('ç”µä¿¡') || text.includes('telecom') || text.includes('chinatelecom')) {
            return 'telecom';
        } else if (text.includes('bgp') || text.includes('å¤šçº¿')) {
            return 'bgp';
        } else {
            return 'other';
        }
    }

    // æå–æµ‹è¯•ç»“æœï¼ˆè¿è¥å•†åˆ†æç‰ˆï¼‰
    function extractResults() {
        let totalTests = 0;
        let success200Tests = 0;
        let connectivityRate = 0;
        let completed = false;
        
        // è¿è¥å•†ç»Ÿè®¡
        const operatorStats = {
            mobile: { name: 'ä¸­å›½ç§»åŠ¨', success: 0, total: 0, errors: [] },
            unicom: { name: 'ä¸­å›½è”é€š', success: 0, total: 0, errors: [] },
            telecom: { name: 'ä¸­å›½ç”µä¿¡', success: 0, total: 0, errors: [] },
            bgp: { name: 'BGPå¤šçº¿', success: 0, total: 0, errors: [] },
            other: { name: 'å…¶ä»–ç½‘ç»œ', success: 0, total: 0, errors: [] }
        };
        
        try {
            // æŸ¥æ‰¾æ£€æµ‹ç‚¹è¡¨æ ¼
            const tables = document.querySelectorAll('table');
            
            for (const table of tables) {
                const rows = table.querySelectorAll('tr');
                if (rows.length < 2) continue;
                
                const firstRow = rows[0].textContent.toLowerCase();
                const isTestTable = firstRow.includes('æ£€æµ‹ç‚¹') ||
                                   firstRow.includes('èŠ‚ç‚¹') ||
                                   firstRow.includes('status');
                
                if (isTestTable) {
                    console.log('âœ… æ‰¾åˆ°æ£€æµ‹ç‚¹è¡¨æ ¼ï¼Œè¡Œæ•°:', rows.length);
                    
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        const cells = row.querySelectorAll('td');
                        if (cells.length < 2) continue;
                        
                        totalTests++;
                        
                        // æå–èŠ‚ç‚¹åç§°
                        const nodeName = cells[0]?.textContent?.trim() || '';
                        const nodeOperator = identifyOperator(nodeName);
                        
                        // åˆ¤æ–­çŠ¶æ€
                        const rowText = row.textContent.toLowerCase();
                        let isSuccess = false;
                        
                        // æ£€æŸ¥æ˜¯å¦æˆåŠŸ
                        if (rowText.includes('200') || 
                            rowText.includes('æˆåŠŸ') || 
                            rowText.includes('æ­£å¸¸') ||
                            rowText.includes('ok') ||
                            rowText.includes('success')) {
                            isSuccess = true;
                        }
                        
                        // ç»Ÿè®¡è¿è¥å•†æ•°æ®
                        operatorStats[nodeOperator].total++;
                        if (isSuccess) {
                            success200Tests++;
                            operatorStats[nodeOperator].success++;
                        } else {
                            operatorStats[nodeOperator].errors.push({
                                nodeName: nodeName,
                                operator: operatorStats[nodeOperator].name
                            });
                        }
                    }
                    
                    if (totalTests > 0) {
                        connectivityRate = Math.round((success200Tests / totalTests) * 100);
                        completed = totalTests >= CONFIG.minTotalTests;
                        break;
                    }
                }
            }
        } catch (error) {
            console.log('æå–ç»“æœå¤±è´¥:', error);
        }
        
        // è®¡ç®—è¿è¥å•†æ‘˜è¦
        const operatorSummary = {
            mobileErrors: operatorStats.mobile.total - operatorStats.mobile.success,
            unicomErrors: operatorStats.unicom.total - operatorStats.unicom.success,
            telecomErrors: operatorStats.telecom.total - operatorStats.telecom.success,
            otherErrors: operatorStats.other.total - operatorStats.other.success +
                        operatorStats.bgp.total - operatorStats.bgp.success,
            
            mobileTotal: operatorStats.mobile.total,
            unicomTotal: operatorStats.unicom.total,
            telecomTotal: operatorStats.telecom.total,
            otherTotal: operatorStats.other.total + operatorStats.bgp.total,
            
            mobileSuccess: operatorStats.mobile.success,
            unicomSuccess: operatorStats.unicom.success,
            telecomSuccess: operatorStats.telecom.success,
            
            mobileRate: operatorStats.mobile.total > 0 ?
                Math.round((operatorStats.mobile.success / operatorStats.mobile.total) * 100) : 0,
            unicomRate: operatorStats.unicom.total > 0 ?
                Math.round((operatorStats.unicom.success / operatorStats.unicom.total) * 100) : 0,
            telecomRate: operatorStats.telecom.total > 0 ?
                Math.round((operatorStats.telecom.success / operatorStats.telecom.total) * 100) : 0
        };
        
        console.log(\`ğŸ“Š æå–ç»“æœ: æ€»æ•°=\${totalTests}, æˆåŠŸ=\${success200Tests}, ç‡=\${connectivityRate}%\`);
        
        return {
            totalTests: totalTests,
            success200Tests: success200Tests,
            connectivityRate: connectivityRate,
            isCompleted: completed || (totalTests >= CONFIG.minTotalTests && connectivityRate > 0),
            isLowRate: connectivityRate < CONFIG.minSuccessRate && connectivityRate > 0,
            operatorStats: operatorStats,
            operatorSummary: operatorSummary
        };
    }

    // å–æ¶ˆæ¸¯æ¾³å°é€‰é¡¹
    function uncheckOverseas() {
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        
        for (const checkbox of checkboxes) {
            if (!checkbox.checked) continue;
            
            const parent = checkbox.parentElement;
            const label = document.querySelector(\`label[for="\${checkbox.id}"]\`);
            let text = '';
            if (parent) text += parent.textContent;
            if (label) text += label.textContent;
            text = text.toLowerCase();
            
            const keywords = ['æ¸¯æ¾³å°', 'é¦™æ¸¯', 'æ¾³é—¨', 'å°æ¹¾', 'æµ·å¤–', 'å›½å¤–'];
            for (const keyword of keywords) {
                if (text.includes(keyword)) {
                    console.log(\`âœ… å–æ¶ˆå‹¾é€‰: \${keyword}\`);
                    checkbox.click();
                    return true;
                }
            }
        }
        return false;
    }

    // æŸ¥æ‰¾å¼€å§‹æŒ‰é’®
    function findStartButton() {
        const allButtons = document.querySelectorAll('button, input[type="submit"], input[type="button"]');
        
        for (const button of allButtons) {
            if (button.disabled) continue;
            
            const buttonText = (button.textContent || button.value || '').trim().toLowerCase();
            
            if (buttonText.includes('å¼€å§‹æµ‹è¯•') ||
                buttonText.includes('å¼€å§‹æ£€æµ‹') ||
                buttonText.includes('ç«‹å³æµ‹é€Ÿ') ||
                buttonText === 'æµ‹è¯•' ||
                buttonText === 'æ£€æµ‹') {
                return button;
            }
        }
        
        // æŸ¥æ‰¾ä¸»è¦æŒ‰é’®æ ·å¼
        const primaryButtons = document.querySelectorAll('.el-button--primary, .ant-btn-primary, .btn-primary, .btn-success');
        for (const button of primaryButtons) {
            if (!button.disabled) {
                return button;
            }
        }
        
        return null;
    }

    // å¼€å§‹æµ‹è¯•
    function startTest() {
        if (testStarted) return false;
        
        const button = findStartButton();
        if (!button) return false;
        
        console.log('ğŸ¯ ç‚¹å‡»å¼€å§‹æŒ‰é’®');
        clickTime = Date.now();
        testStarted = true;
        hasProcessed = true;
        currentStage = 'testing';
        
        button.click();
        return true;
    }

    // æ£€æŸ¥æµ‹è¯•æ˜¯å¦çœŸæ­£å¼€å§‹
    function checkIfTestReallyStarted() {
        const pageText = document.body.textContent.toLowerCase();
        
        if (pageText.includes('æµ‹è¯•ä¸­') ||
            pageText.includes('æ£€æµ‹ä¸­') ||
            pageText.includes('æ­£åœ¨æµ‹è¯•')) {
            return true;
        }
        
        const results = extractResults();
        if (results.totalTests > 0) {
            return true;
        }
        
        const timeSinceClick = Date.now() - clickTime;
        if (clickTime > 0 && timeSinceClick > CONFIG.waitAfterClick) {
            return true;
        }
        
        return false;
    }

    // æˆªå›¾åŠŸèƒ½
    function captureScreenshot() {
        return new Promise((resolve, reject) => {
            try {
                console.log('ğŸ“¸ å¼€å§‹æˆªå›¾...');
                
                // ç­‰å¾…é¡µé¢åŠ è½½
                setTimeout(() => {
                    if (typeof html2canvas !== 'undefined') {
                        // æˆªå›¾ä¸»è¦ç»“æœåŒºåŸŸ
                        const resultArea = document.querySelector('table') || document.body;
                        
                        html2canvas(resultArea, {
                            scale: 0.7,
                            useCORS: true,
                            allowTaint: true,
                            backgroundColor: '#ffffff',
                            logging: false
                        }).then(canvas => {
                            const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                            console.log('âœ… æˆªå›¾å®Œæˆï¼Œå¤§å°:', Math.round(dataUrl.length / 1024), 'KB');
                            resolve(dataUrl);
                        }).catch(error => {
                            console.log('âŒ html2canvasæˆªå›¾å¤±è´¥:', error);
                            resolve(null);
                        });
                    } else {
                        console.log('âš ï¸ html2canvasæœªåŠ è½½ï¼Œæ— æ³•æˆªå›¾');
                        resolve(null);
                    }
                }, 1000);
            } catch (error) {
                console.log('âŒ æˆªå›¾å¤±è´¥:', error);
                resolve(null);
            }
        });
    }

    // å‘é€ç»“æœåˆ°ä¸»é¡µé¢
    async function sendResults(results) {
        try {
            console.log('ğŸ“¤ å‡†å¤‡å‘é€ç»“æœåˆ°ä¸»é¡µé¢...');
            
            // æˆªå›¾
            const screenshot = await captureScreenshot();
            
            // å‡†å¤‡æ•°æ®
            const data = {
                type: 'ITDOG_TEST_RESULT',
                domain: currentDomain,
                connectivityRate: results.connectivityRate || 0,
                totalTests: results.totalTests || 0,
                success200Tests: results.success200Tests || 0,
                isLowRate: results.isLowRate || false,
                isCompleted: results.isCompleted || false,
                timestamp: new Date().toISOString(),
                screenshot: screenshot,
                pageUrl: window.location.href,
                pageTitle: document.title,
                operatorStats: results.operatorStats || {},
                operatorSummary: results.operatorSummary || {},
                source: 'ITDOG_MONITOR_V10',
                version: '10.0'
            };
            
            console.log('ğŸ“¤ å‘é€ç»“æœæ•°æ®');
            
            // å‘é€ç»™openerï¼ˆä¸»æ§åˆ¶é¡µé¢ï¼‰
            if (window.opener && !window.opener.closed) {
                window.opener.postMessage(data, '*');
                console.log('âœ… å‘é€ç»™openeræˆåŠŸ');
                
                // å‘é€ç¬¬äºŒæ¬¡ç¡®ä¿æ”¶åˆ°
                setTimeout(() => {
                    window.opener.postMessage(data, '*');
                }, 500);
            }
            
            // å‘é€ç»™parentï¼ˆiframeæƒ…å†µï¼‰
            if (window.parent && window.parent !== window) {
                window.parent.postMessage(data, '*');
                console.log('âœ… å‘é€ç»™parentæˆåŠŸ');
            }
            
            // å¹¿æ’­ç»™æ‰€æœ‰çª—å£
            window.postMessage(data, '*');
            console.log('âœ… å¹¿æ’­å‘é€æˆåŠŸ');
            
            return true;
            
        } catch (error) {
            console.log('âŒ å‘é€ç»“æœå¤±è´¥:', error);
            return false;
        }
    }

    // ç›‘æ§ç»“æœ
    function monitorResults() {
        if (monitoringStarted) return;
        
        console.log('ğŸ” å¼€å§‹ç›‘æ§æµ‹è¯•ç»“æœ...');
        monitoringStarted = true;
        currentStage = 'monitoring';
        checkCount = 0;
        let lastTotalTests = 0;
        let stableCount = 0;
        let consecutiveNoResults = 0;
        
        // è®¾ç½®è¶…æ—¶
        const timeoutId = setTimeout(() => {
            console.log('â° ç›‘æ§è¶…æ—¶ï¼Œå¼ºåˆ¶å®Œæˆ');
            if (monitoringInterval) clearInterval(monitoringInterval);
            const results = extractResults();
            finishTest(results);
        }, CONFIG.timeout);
        
        monitoringInterval = setInterval(() => {
            checkCount++;
            
            // æ£€æŸ¥æµ‹è¯•æ˜¯å¦çœŸæ­£å¼€å§‹
            if (!testReallyStarted) {
                testReallyStarted = checkIfTestReallyStarted();
                if (testReallyStarted) {
                    console.log('âœ… æ£€æµ‹åˆ°æµ‹è¯•çœŸæ­£å¼€å§‹äº†');
                }
            }
            
            console.log(\`ğŸ“Š ç›‘æ§æ£€æŸ¥ \${checkCount}/\${CONFIG.maxChecks}\`);
            
            const results = extractResults();
            
            if (results.totalTests === 0) {
                consecutiveNoResults++;
                if (consecutiveNoResults >= 10) {
                    console.log('âš ï¸ è¿ç»­10æ¬¡æ— ç»“æœï¼Œå¯èƒ½æµ‹è¯•å¤±è´¥');
                }
            } else {
                consecutiveNoResults = 0;
                
                const isStable = results.totalTests >= CONFIG.minTotalTests &&
                                results.totalTests === lastTotalTests;
                
                if (results.isCompleted || isStable) {
                    stableCount++;
                    console.log(\`âœ… æµ‹è¯•ç¨³å®š \${stableCount}/\${CONFIG.stableThreshold} æ¬¡\`);
                } else {
                    stableCount = 0;
                }
                
                lastTotalTests = results.totalTests;
                
                // åˆ¤æ–­æ˜¯å¦å®Œæˆ
                if (!resultsSent && (stableCount >= CONFIG.stableThreshold || checkCount >= CONFIG.maxChecks)) {
                    clearTimeout(timeoutId);
                    clearInterval(monitoringInterval);
                    finishTest(results);
                }
            }
            
        }, CONFIG.checkInterval);
    }

    // å®Œæˆæµ‹è¯•
    async function finishTest(results) {
        if (resultsSent) {
            console.log('âš ï¸ ç»“æœå·²å‘é€ï¼Œè·³è¿‡é‡å¤å‘é€');
            return;
        }
        
        resultsSent = true;
        currentStage = 'completed';
        
        console.log('âœ… æµ‹è¯•å®Œæˆï¼Œå‡†å¤‡å‘é€ç»“æœ:', results);
        
        const sent = await sendResults(results);
        
        if (sent) {
            console.log('âœ… ç»“æœå‘é€æˆåŠŸ');
            showCompletionMessage(results);
        } else {
            console.log('âŒ ç»“æœå‘é€å¤±è´¥');
        }
        
        // 5-10ç§’åå…³é—­é¡µé¢
        const closeDelay = 5000 + Math.random() * 5000;
        console.log(\`â³ \${Math.round(closeDelay/1000)}ç§’åå…³é—­é¡µé¢\`);
        
        setTimeout(() => {
            try {
                window.close();
                console.log('âœ… å°è¯•å…³é—­é¡µé¢');
            } catch (e) {
                console.log('âš ï¸ æ— æ³•è‡ªåŠ¨å…³é—­é¡µé¢ï¼Œè¯·æ‰‹åŠ¨å…³é—­');
            }
        }, closeDelay);
    }

    // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
    function showCompletionMessage(results) {
        const completionDiv = document.createElement('div');
        completionDiv.style.cssText = \`
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            color: white;
            padding: 40px;
            border-radius: 20px;
            z-index: 1000000;
            text-align: center;
            border: 3px solid #2ecc71;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        \`;
        
        const isLowRate = results.isLowRate;
        const mainColor = isLowRate ? '#e74c3c' : '#2ecc71';
        const emoji = isLowRate ? 'âš ï¸' : 'âœ…';
        const title = isLowRate ? 'è¿é€šç‡ä½äºæ ‡å‡†' : 'æµ‹è¯•æˆåŠŸå®Œæˆ';
        
        completionDiv.innerHTML = \`
            <div style="font-size: 80px; margin-bottom: 20px;">\${emoji}</div>
            <h2 style="margin: 0 0 15px 0; color: \${mainColor}">\${title}</h2>
            <div style="margin-bottom: 15px; font-size: 18px; word-break: break-all; padding: 0 20px;">
                \${currentDomain || 'æœªçŸ¥åŸŸå'}
            </div>
            <div style="font-size: 64px; font-weight: bold; margin: 25px 0; color: \${mainColor}">
                \${results.connectivityRate}%
            </div>
            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 20px;">
                ğŸ“¡ è¿è¥å•†èŠ‚ç‚¹åˆ†ææ•°æ®å·²é‡‡é›†<br>
                ğŸ“¸ æµ‹è¯•æˆªå›¾å·²å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
            </div>
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.3);">
                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 10px;">
                    ğŸ¯ æµ‹è¯•ç»“æœå·²å‘é€åˆ°ä¸»æ§é¡µé¢
                </div>
                <div style="font-size: 12px; opacity: 0.7;">
                    æœ¬é¡µé¢å°†åœ¨å‡ ç§’åè‡ªåŠ¨å…³é—­...
                </div>
            </div>
        \`;
        
        document.body.appendChild(completionDiv);
    }

    // ä¸»æ‰§è¡Œæµç¨‹
    function executeTest() {
        if (hasProcessed) {
            console.log('ğŸš« è„šæœ¬å·²æ‰§è¡Œï¼Œç¦æ­¢é‡å¤è¿è¡Œ');
            return;
        }
        
        currentDomain = getDomain();
        if (!currentDomain) {
            console.log('âŒ æ— æ³•è·å–åŸŸåï¼Œåœæ­¢è„šæœ¬');
            return;
        }
        
        console.log('âœ… æµ‹è¯•åŸŸå:', currentDomain);
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ç»“æœ
        const existingResults = extractResults();
        if (existingResults.totalTests > 0) {
            console.log('ğŸ“Š æ£€æµ‹åˆ°å·²æœ‰æµ‹è¯•ç»“æœï¼Œç›´æ¥å‘é€');
            setTimeout(() => {
                finishTest(existingResults);
            }, 2000);
            return;
        }
        
        // æ‰§è¡Œæµ‹è¯•æµç¨‹
        setTimeout(() => {
            // å–æ¶ˆæ¸¯æ¾³å°é€‰é¡¹
            uncheckOverseas();
            
            setTimeout(() => {
                // å¼€å§‹æµ‹è¯•
                const started = startTest();
                
                if (started) {
                    console.log('âœ… æµ‹è¯•å·²å¯åŠ¨ï¼Œç­‰å¾…ç»“æœ...');
                    
                    // å¼€å§‹ç›‘æ§
                    setTimeout(() => {
                        monitorResults();
                    }, CONFIG.waitAfterClick);
                } else {
                    console.log('âŒ å¯åŠ¨æµ‹è¯•å¤±è´¥');
                }
            }, 1500);
        }, 1000);
    }

    // åˆå§‹åŒ–
    function init() {
        console.log('ğŸ”„ ITDOGç›‘æ§è„šæœ¬åˆå§‹åŒ– v10.0');
        
        // æ£€æŸ¥é¡µé¢æ˜¯å¦å·²åŠ è½½å®Œæˆ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', executeTest);
        } else {
            setTimeout(executeTest, 1500);
        }
    }

    // å¯åŠ¨
    init();

})();`;

        // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºè„šæœ¬ä»£ç 
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        `;

        const modalContent = document.createElement('div');
        modalContent.style.cssText = `
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        `;

        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'âœ•';
        closeBtn.style.cssText = `
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
        `;
        closeBtn.onclick = () => modal.remove();

        const title = document.createElement('h3');
        title.textContent = 'Tampermonkeyè„šæœ¬ä»£ç ';
        title.style.cssText = `
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
        `;

        const codeArea = document.createElement('textarea');
        codeArea.value = scriptCode;
        codeArea.style.cssText = `
            width: 100%;
            height: 400px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            padding: 15px;
            border: 2px solid #3498db;
            border-radius: 10px;
            background: #f8f9fa;
            resize: vertical;
        `;

        const instructions = document.createElement('div');
        instructions.innerHTML = `
            <div style="margin: 20px 0; padding: 15px; background: #e8f4fc; border-radius: 8px;">
                <strong>å®‰è£…è¯´æ˜ï¼š</strong>
                <ol style="margin: 10px 0; padding-left: 20px;">
                    <li>å¤åˆ¶ä¸Šé¢çš„ä»£ç </li>
                    <li>æ‰“å¼€Tampermonkeyæ‰©å±•</li>
                    <li>ç‚¹å‡»"æ·»åŠ æ–°è„šæœ¬"</li>
                    <li>ç²˜è´´ä»£ç å¹¶ä¿å­˜</li>
                    <li>è®¿é—® itdog.cn æµ‹è¯•</li>
                </ol>
            </div>
        `;

        modalContent.appendChild(closeBtn);
        modalContent.appendChild(title);
        modalContent.appendChild(codeArea);
        modalContent.appendChild(instructions);
        modal.appendChild(modalContent);
        document.body.appendChild(modal);

        // è‡ªåŠ¨é€‰ä¸­ä»£ç 
        codeArea.select();
        
        addLog('ğŸ“‹ Tampermonkeyè„šæœ¬ä»£ç å·²æ˜¾ç¤º', 'info');
    }

    // æµ‹è¯•è„šæœ¬è¿æ¥
    function testScriptConnection() {
        // å°è¯•æ‰“å¼€ä¸€ä¸ªæµ‹è¯•é¡µé¢
        const testUrl = 'https://www.itdog.cn/http/?domain=example.com';
        const testWindow = window.open(testUrl, '_blank');
        
        if (testWindow) {
            addLog('ğŸŒ æ‰“å¼€æµ‹è¯•é¡µé¢æ£€æŸ¥è„šæœ¬è¿æ¥...', 'info');
            
            // ç­‰å¾…é¡µé¢åŠ è½½
            setTimeout(() => {
                testWindow.postMessage({ 
                    type: 'PING_ITDOG_MONITOR',
                    source: 'MAIN_CONTROL_TEST',
                    timestamp: Date.now()
                }, '*');
                
                // ç›‘å¬å›å¤
                const messageHandler = function(event) {
                    if (event.data && event.data.type === 'PONG_ITDOG_MONITOR') {
                        showScriptStatus('âœ… è„šæœ¬è¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');
                        addLog('âœ… Tampermonkeyè„šæœ¬è¿è¡Œæ­£å¸¸', 'success');
                        window.removeEventListener('message', messageHandler);
                        testWindow.close();
                    }
                };
                
                window.addEventListener('message', messageHandler);
                
                // è®¾ç½®è¶…æ—¶
                setTimeout(() => {
                    window.removeEventListener('message', messageHandler);
                    if (!testWindow.closed) {
                        testWindow.close();
                    }
                    showScriptStatus('âŒ è„šæœ¬è¿æ¥æµ‹è¯•å¤±è´¥ï¼Œè¯·ç¡®ä¿è„šæœ¬å·²å®‰è£…', 'error');
                }, 5000);
                
            }, 3000);
        } else {
            showScriptStatus('âŒ æ— æ³•æ‰“å¼€æµ‹è¯•é¡µé¢ï¼Œè¯·å…è®¸å¼¹å‡ºçª—å£', 'error');
        }
    }

    // åˆå§‹åŒ–åº”ç”¨
    init();
});
</script>
</body>
</html>
